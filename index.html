<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>بانک مونوپولی</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-dark: #0D1B2A;    
  --bg-light: #1B263B;   
  --primary: #3A86FF;     
  --primary-hover: #5c9bff;
  --secondary: #415A77; 
  --secondary-hover: #527194;
  --text: #E0E1DD;       
  --danger: #ff4b4b;
  font-family: 'Vazirmatn', sans-serif;
}
* { 
  box-sizing: border-box; 
  -webkit-tap-highlight-color: transparent;
}
body {
  background: var(--bg-dark);
  color: var(--text);
  margin: 0;
  padding: 0;
  user-select: none;
  -webkit-user-select: none;
  font-size: 16px;
  font-family: 'Vazirmatn', sans-serif;
}
section { display: none; padding: 20px; }
section.active { display:block; }
h1, h2, h3 { text-align:center; color: var(--text); font-weight: 700; }
h1 { font-size: 28px; }
h2 { margin-bottom: 30px;}

/* --- دکمه‌ها --- */
button {
  border:none;
  border-radius: 25px;
  padding: 12px 28px;
  font-family:'Vazirmatn', sans-serif; /* اطمینان از فونت */
  font-size:16px;
  margin: 10px auto;
  display:block;
  cursor:pointer;
  transition: all .2s ease-in-out;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  min-width: 150px;
}
button:disabled {
  background: #778DA9 !important;
  color: #ccc;
  cursor: not-allowed;
  box-shadow: none;
}
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover:not(:disabled) { background: var(--primary-hover); transform: translateY(-2px); }
.btn-secondary { background: var(--secondary); color: var(--text); }
.btn-secondary:hover:not(:disabled) { background: var(--secondary-hover); }

/* --- فرم‌ها --- */
input, select {
  border: 1px solid var(--secondary);
  background: var(--bg-light);
  color: var(--text);
  border-radius:15px;
  padding: 12px 20px;
  font-family: 'Vazirmatn', sans-serif; /* اطمینان از فونت */
  font-size:16px;
  text-align:center;
  width:90%;
  max-width: 300px;
  margin: 10px auto;
  display:block;
  transition: all .2s ease;
}
input:focus, select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.3);
}
label { display: block; text-align: center; margin-top: 20px; color: #aab; }

/* --- لیست بازیکنان --- */
#playerList {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-top: 20px;
}
.player-card {
  background: var(--bg-light);
  border-radius: 20px;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.player-card.bankrupt { opacity: 0.5; background: #2a2a2a; }
.player-info { display: flex; align-items: center; gap: 15px; }
.player-tag {
  background: var(--primary); color: #fff; width: 40px; height: 40px;
  border-radius: 50%; display: flex; justify-content: center; align-items: center;
  font-weight: 700; font-size: 18px;
}
.player-name { font-size: 18px; font-weight: 600; }
.player-balance { font-size: 18px; font-weight: 400; direction: ltr; }
.bankrupt-stamp::after{
  content:"ورشکسته"; position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%) rotate(-15deg); background: var(--danger);
  color: #fff; padding: 5px 50px; font-size: 18px; font-weight: bold;
  opacity: 0.9; letter-spacing: 2px;
}

/* --- کادر تست NFC --- */
#nfcDebugOutput {
  background: #000;
  border: 1px dashed var(--primary);
  border-radius: 10px;
  padding: 15px;
  margin: 25px 0;
  text-align: center;
  color: #fff;
  font-family: monospace; /* برای دیدن دقیق کاراکترها */
  font-size: 14px;
}

/* --- پاپ‌آپ‌ها --- */
.popup {
  position:fixed; inset:0; background:#000000aa; display:none; justify-content:center; align-items:center; z-index:99;
}
.popup.active { display:flex; }
.popup-box {
  background: var(--bg-light); border-radius:30px; padding:25px; 
  width:90%; max-width:400px; text-align:center;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
.popup-box .button-group {
    display: flex; justify-content: center; gap: 10px; margin-top: 20px;
}

#formattedAmountDisplay {
    color: var(--text);
    font-size: 22px;
    font-weight: bold;
    margin-bottom: 10px;
    min-height: 30px; /* برای جلوگیری از پرش صفحه */
}

.circle {
  width:100px; height:100px; border-radius:50%;
  border: 2px solid var(--primary); color:var(--text); font-size:16px; /* فونت کوچکتر برای جا شدن نام‌ها */
  display: flex; justify-content: center; align-items: center; text-align: center;
  padding: 5px; margin:20px auto; transition: all .3s ease;
  word-break: break-word;
}
.circle.filled { background: var(--primary); color: #fff; }

.keyboard { display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-top:10px;}
.keyboard button{ 
    border-radius:15px; padding:14px; font-size:20px; background: var(--secondary);
    box-shadow: none; margin: 0; min-width: auto;
}
.keyboard button:hover { background: var(--secondary-hover); transform: none; }

/* --- انیمیشن‌ها --- */
.fade {
  position:fixed; inset:0; background:#000000dd; color:#fff; display:none;
  justify-content:center; align-items:center; flex-direction:column; font-size:20px; z-index:999;
}
.fade.active{ display:flex; animation:fadeInOut 1.2s ease-in-out;}
@keyframes fadeInOut{0%{opacity:0;}40%{opacity:1;}80%{opacity:1;}100%{opacity:0;}}
.arrow {
  width:60px; height:60px; border-top:5px solid #fff; border-right:5px solid #fff;
  transform:rotate(45deg); margin-top:10px; animation:arrowAnim 1.2s ease-in-out;
}
@keyframes arrowAnim{0%{transform:translateX(-100px) rotate(45deg);opacity:0;}
50%{opacity:1;}
100%{transform:translateX(100px) rotate(45deg);opacity:0;}}
</style>
</head>
<body>

<!----------- صفحه شروع ----------->
<section id="start" class="active">
  <h1>🏦 بانک مونوپولی</h1>
  <label for="playerCount">تعداد بازیکنان:</label>
  <select id="playerCount">
    <option value="2">۲</option><option value="3">۳</option><option value="4">۴</option><option value="5">۵</option><option value="6">۶</option>
  </select>
  <label for="startMoney">موجودی اولیه:</label>
  <input type="number" id="startMoney" placeholder="مثلاً 15000">
  <label for="turnReward">پاداش دور کامل:</label>
  <input type="number" id="turnReward" placeholder="مثلاً 2000">
  <button id="continueToNames" class="btn-primary">ادامه</button>
</section>

<!----------- صفحه دریافت نام ----------->
<section id="names">
  <h2>وارد کردن نام بازیکنان</h2>
  <div id="nameInputs"></div>
  <button id="startGame" class="btn-primary">شروع بازی</button>
</section>

<!----------- صفحه بازی ----------->
<section id="game">
  <h2>مدیریت بازی</h2>
  <button id="transferBtn" class="btn-primary">💸 کارت به کارت</button>
  <button id="rewardBtn" class="btn-primary">🎁 دریافت پاداش دور</button>
  
  <!-- کادر تست NFC -->
  <div id="nfcDebugOutput">برای تست، تگ را به گوشی نزدیک کنید تا محتوای آن اینجا نمایش داده شود.</div>
  
  <div id="playerList"></div>
  <button id="endGame" class="btn-secondary">اتمام بازی ❌</button>
</section>

<!----------- پاپ‌آپ کارت به کارت ----------->
<div id="transferPopup" class="popup">
  <div class="popup-box">
    <h3>💳 کارت به کارت</h3>
    <div id="formattedAmountDisplay"></div>
    <input type="hidden" id="amountInput"> <!-- مخفی شد و فقط برای نگهداری عدد خام استفاده می‌شود -->
    <div class="keyboard" id="numPad"></div>
    <div style="display:flex; justify-content:space-around; align-items: center; margin-top:10px;">
      <div class="circle" id="giverCircle">دهنده</div>
      <p style="font-size: 30px; margin: 0 10px;">➔</p>
      <div class="circle" id="receiverCircle">گیرنده</div>
    </div>
    <div class="button-group">
        <button id="transferConfirm" class="btn-primary">انتقال</button>
        <button id="transferCancel" class="btn-secondary">انصراف</button>
    </div>
  </div>
</div>

<!----------- پاپ‌آپ پاداش دور ----------->
<div id="rewardPopup" class="popup">
  <div class="popup-box">
    <h3>🎁 دریافت پاداش دور</h3>
    <div id="rewardAmount" style="font-size:22px;margin:10px;"></div>
    <div class="circle" id="rewardCircle">بازیکن</div>
    <div class="button-group">
        <button id="rewardConfirm" class="btn-primary">تایید</button>
        <button id="rewardCancel" class="btn-secondary">انصراف</button>
    </div>
  </div>
</div>

<!----------- انیمیشن انتقال ----------->
<div id="transferFade" class="fade">
  <div id="transferInfo" style="text-align: center;">
    <div class="circle filled" id="fadeGiver"></div>
    <div class="arrow"></div>
    <div class="circle filled" id="fadeReceiver"></div>
  </div>
</div>

<div id="rewardFade" class="fade">
  <div style="text-align: center;">
    <div id="rewardShow" style="font-size: 24px; font-weight: bold; margin-bottom: 10px;"></div>
    <div class="arrow"></div>
    <div class="circle filled" id="rewardTo"></div>
  </div>
</div>

<script>
document.addEventListener('contextmenu', e => e.preventDefault());

// ------------------------- متغیرهای گلوبال -------------------------
const sections = { start: document.getElementById('start'), names: document.getElementById('names'), game: document.getElementById('game') };
const popups = { transfer: document.getElementById('transferPopup'), reward: document.getElementById('rewardPopup') };
const nfcDebugOutput = document.getElementById('nfcDebugOutput');
let ndefReader;
let nfcAbortController = null;

// ------------------------- تابع کمکی برای فرمت اعداد -------------------------
function formatToPersian(num) {
  return new Intl.NumberFormat('fa-IR').format(num);
}

// ------------------------- مدیریت صفحات -------------------------
function showSection(id) {
  for (let key in sections) sections[key].classList.remove('active');
  sections[id].classList.add('active');
  // اگر به صفحه بازی رفتیم، اسکن NFC برای تست فعال شود
  if (id === 'game') {
      startGlobalNFCScanForDebug();
  }
}

// ------------------------- مرحله ۱: تنظیمات اولیه -------------------------
document.getElementById('continueToNames').onclick = () => {
  const count = parseInt(playerCount.value);
  const startMoneyVal = parseInt(startMoney.value);
  const rewardVal = parseInt(turnReward.value);
  if (isNaN(startMoneyVal) || startMoneyVal <= 0 || isNaN(rewardVal) || rewardVal <= 0) {
    alert("مقادیر پولی را به درستی و بزرگتر از صفر وارد کنید.");
    return;
  }
  localStorage.setItem('playerCount', count);
  localStorage.setItem('startMoney', startMoneyVal);
  localStorage.setItem('turnReward', rewardVal);
  generateNameInputs(count);
  showSection('names');
};

// ------------------------- مرحله ۲: نام بازیکنان -------------------------
function generateNameInputs(count) {
  const container = document.getElementById('nameInputs');
  container.innerHTML = '';
  for (let i = 1; i <= count; i++) {
    const input = document.createElement('input');
    input.placeholder = `نام بازیکن ${i}`;
    input.id = `playerName${i}`;
    container.appendChild(input);
  }
}

document.getElementById('startGame').onclick = () => {
  const count = parseInt(localStorage.getItem('playerCount'));
  let players = [];
  for (let i = 1; i <= count; i++) {
    let name = document.getElementById(`playerName${i}`).value.trim();
    if (!name) { alert("نام تمام بازیکنان را وارد کنید."); return; }
    players.push({ id: i, name: name, balance: parseInt(localStorage.getItem('startMoney')), bankrupt: false });
  }
  localStorage.setItem('players', JSON.stringify(players));
  renderPlayerList();
  showSection('game');
};

// ------------------------- مرحله ۳: صفحه بازی -------------------------
function renderPlayerList() {
  const playerListContainer = document.getElementById('playerList');
  playerListContainer.innerHTML = '';
  const players = JSON.parse(localStorage.getItem('players'));
  
  players.forEach(p => {
    const card = document.createElement('div');
    card.className = 'player-card';
    if (p.bankrupt) card.classList.add('bankrupt-stamp');

    card.innerHTML = `
      <div class="player-info">
        <div class="player-tag">${p.id}</div>
        <div class="player-name">${p.name}</div>
      </div>
      <div class="player-balance">${formatToPersian(p.balance)}</div>
    `;
    
    card.addEventListener('contextmenu', e => {
      e.preventDefault();
      if (p.bankrupt) return;
      if (confirm(`آیا از ورشکستگی بازیکن «${p.name}» مطمئن هستید؟`)) {
        p.bankrupt = true;
        localStorage.setItem('players', JSON.stringify(players));
        renderPlayerList();
      }
    });
    playerListContainer.appendChild(card);
  });
}

// ------------------------- منطق NFC -------------------------
async function startNFCScan(onRead, onScanStart, onScanEnd) {
    if (!('NDEFReader' in window)) {
        alert("مرورگر شما از Web NFC پشتیبانی نمی‌کند. از گوگل کروم در اندروید استفاده کنید.");
        return;
    }
    try {
        if (!ndefReader) ndefReader = new NDEFReader();
        nfcAbortController = new AbortController();
        if (onScanStart) onScanStart();

        ndefReader.onreading = event => {
            const decoder = new TextDecoder();
            const rawText = decoder.decode(event.message.records[0].data).trim();
            
            // نمایش خروجی خام در کادر تست
            nfcDebugOutput.textContent = `داده خام تگ: [${rawText}]`;

            const parts = rawText.split('\n');
            const id = parseInt(parts[0]);
            
            if (isNaN(id)) {
                nfcDebugOutput.textContent += ' | خطا: ID خوانده شده عدد نیست!';
                return; 
            }
            
            const players = JSON.parse(localStorage.getItem('players'));
            const player = players.find(p => p.id === id);
            
            if (player && !player.bankrupt) {
                onRead(player);
            } else if (!player) {
                nfcDebugOutput.textContent += ` | خطا: بازیکنی با ID=${id} یافت نشد!`;
            }
        };

        await ndefReader.scan({ signal: nfcAbortController.signal });

    } catch (error) {
        if (onScanEnd) onScanEnd();
        nfcDebugOutput.textContent = `خطا در فعالسازی NFC: ${error.message}`;
    }
}

function stopNFCScan() {
    if (nfcAbortController) {
        nfcAbortController.abort();
        nfcAbortController = null;
    }
}

// تابع اسکن سراسری فقط برای کادر تست
async function startGlobalNFCScanForDebug() {
    if (!('NDEFReader' in window)) return;
    try {
        const reader = new NDEFReader();
        await reader.scan();
        reader.onreading = event => {
            const decoder = new TextDecoder();
            const rawText = decoder.decode(event.message.records[0].data).trim();
            nfcDebugOutput.textContent = `داده خام تگ: [${rawText}]`;
        };
    } catch (error) {
        // این خطا طبیعی است اگر اسکن دیگری (از پاپ‌آپ‌ها) فعال شود
    }
}

// ------------------------- کارت به کارت -------------------------
const numPad = document.getElementById('numPad');
const amountInput = document.getElementById('amountInput');
const formattedAmountDisplay = document.getElementById('formattedAmountDisplay');

function updateFormattedAmount() {
    const amount = parseInt(amountInput.value) || 0;
    formattedAmountDisplay.textContent = amount > 0 ? `${formatToPersian(amount)} تومان` : '';
}

['۱','۲','۳','۴','۵','۶','۷','۸','۹','۰','⌫','پاک'].forEach((key, i) => {
    const btn = document.createElement('button');
    btn.textContent = key;
    if (key === '⌫') {
        btn.onclick = () => {
            amountInput.value = amountInput.value.slice(0, -1);
            updateFormattedAmount();
        };
    } else if (key === 'پاک') {
        btn.onclick = () => {
            amountInput.value = '';
            updateFormattedAmount();
        };
    } else {
        const num = i === 9 ? '0' : (i + 1).toString();
        btn.onclick = () => {
            amountInput.value += num;
            updateFormattedAmount();
        };
    }
    numPad.appendChild(btn);
});

let giverTag = null, receiverTag = null;
const giverCircle = document.getElementById('giverCircle');
const receiverCircle = document.getElementById('receiverCircle');

function resetTransferPopup() {
    stopNFCScan();
    giverTag = null; receiverTag = null;
    giverCircle.textContent = 'دهنده';
    receiverCircle.textContent = 'گیرنده';
    giverCircle.classList.remove('filled');
    receiverCircle.classList.remove('filled');
    amountInput.value = '';
    updateFormattedAmount();
    popups.transfer.classList.remove('active');
}

document.getElementById('transferBtn').onclick = () => {
    popups.transfer.classList.add('active');
    giverCircle.textContent = 'در حال اسکن...';
    startNFCScan(
        // onRead
        player => {
            if (!giverTag) {
                giverTag = player;
                giverCircle.textContent = player.name;
                giverCircle.classList.add('filled');
                receiverCircle.textContent = 'در حال اسکن...';
            } else if (!receiverTag && player.id !== giverTag.id) {
                receiverTag = player;
                receiverCircle.textContent = player.name;
                receiverCircle.classList.add('filled');
                stopNFCScan();
            }
        },
        // onScanStart
        () => {
            if (!giverTag) giverCircle.textContent = 'در حال اسکن...';
            else receiverCircle.textContent = 'در حال اسکن...';
        },
        // onScanEnd
        () => {
            if (!giverTag) giverCircle.textContent = 'دهنده';
            if (!receiverTag) receiverCircle.textContent = 'گیرنده';
        }
    );
};

document.getElementById('transferCancel').onclick = resetTransferPopup;

document.getElementById('transferConfirm').onclick = () => {
    const amount = parseInt(amountInput.value);
    if (!giverTag || !receiverTag) { alert("لطفاً تگ دهنده و گیرنده را اسکن کنید."); return; }
    if (isNaN(amount) || amount <= 0) { alert("مبلغ انتقال را به درستی وارد کنید."); return; }
    
    let players = JSON.parse(localStorage.getItem('players'));
    const giver = players.find(p => p.id === giverTag.id);
    const receiver = players.find(p => p.id === receiverTag.id);

    if (giver.balance < amount) { alert(`موجودی «${giver.name}» کافی نیست!`); return; }

    giver.balance -= amount;
    receiver.balance += amount;
    localStorage.setItem('players', JSON.stringify(players));
    
    showTransferAnimation(giver.name, receiver.name);
    resetTransferPopup();
    setTimeout(renderPlayerList, 1100);
};

function showTransferAnimation(giverName, receiverName) {
    document.getElementById('fadeGiver').textContent = giverName;
    document.getElementById('fadeReceiver').textContent = receiverName;
    document.getElementById('transferFade').classList.add('active');
    setTimeout(() => document.getElementById('transferFade').classList.remove('active'), 1200);
}

// ------------------------- پاداش دور -------------------------
let rewardTag = null;
const rewardCircle = document.getElementById('rewardCircle');

function resetRewardPopup() {
    stopNFCScan();
    rewardTag = null;
    rewardCircle.textContent = 'بازیکن';
    rewardCircle.classList.remove('filled');
    popups.reward.classList.remove('active');
}

document.getElementById('rewardBtn').onclick = () => {
    const turnReward = parseInt(localStorage.getItem('turnReward'));
    document.getElementById('rewardAmount').textContent = `مبلغ پاداش: ${formatToPersian(turnReward)} تومان`;
    popups.reward.classList.add('active');
    rewardCircle.textContent = 'در حال اسکن...';
    startNFCScan(
        player => {
            rewardTag = player;
            rewardCircle.textContent = player.name;
            rewardCircle.classList.add('filled');
            stopNFCScan();
        },
        () => { rewardCircle.textContent = 'در حال اسکن...'; },
        () => { if (!rewardTag) rewardCircle.textContent = 'بازیکن'; }
    );
};

document.getElementById('rewardCancel').onclick = resetRewardPopup;

document.getElementById('rewardConfirm').onclick = () => {
    if (!rewardTag) { alert("لطفا تگ بازیکن را اسکن کنید."); return; }
    const rewardAmount = parseInt(localStorage.getItem('turnReward'));
    let players = JSON.parse(localStorage.getItem('players'));
    const player = players.find(p => p.id === rewardTag.id);
    player.balance += rewardAmount;
    localStorage.setItem('players', JSON.stringify(players));

    showRewardAnimation(player.name, rewardAmount);
    resetRewardPopup();
    setTimeout(renderPlayerList, 1100);
};

function showRewardAnimation(name, amount) {
    document.getElementById('rewardTo').textContent = name;
    document.getElementById('rewardShow').textContent = `+${formatToPersian(amount)} تومان`;
    document.getElementById('rewardFade').classList.add('active');
    setTimeout(() => document.getElementById('rewardFade').classList.remove('active'), 1200);
}

// ------------------------- اتمام بازی -------------------------
document.getElementById('endGame').onclick = () => {
    if (confirm("آیا برای شروع یک بازی جدید، تمام اطلاعات پاک شود؟")) {
        localStorage.clear();
        location.reload();
    }
};

// --- اجرای اولیه ---
if (localStorage.getItem('players')) {
    renderPlayerList();
    showSection('game');
}
</script>

</body>
</html>
