<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>بانک مونوپولی - نسخه پیشرفته</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --primary: #8a2be2;
  --secondary: #4b0082;
  --accent: #9370db;
  --dark: #121212;
  --darker: #0a0a0a;
  --light: #f0f0f0;
  --gray: #2a2a2a;
  --success: #00c853;
  --danger: #ff5252;
  --warning: #ffd740;
  --card-border: rgba(138, 43, 226, 0.3);
  --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.36);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Vazirmatn', sans-serif;
}

body {
  background: linear-gradient(135deg, var(--darker), var(--dark));
  color: var(--light);
  min-height: 100vh;
  padding: 20px;
  overflow-x: hidden;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
}

header {
  text-align: center;
  padding: 20px 0;
  margin-bottom: 30px;
  border-bottom: 1px solid var(--card-border);
}

.logo {
  font-size: 2.8rem;
  color: var(--accent);
  margin-bottom: 10px;
  text-shadow: 0 0 15px rgba(147, 112, 219, 0.7);
}

.title {
  font-size: 1.8rem;
  font-weight: 700;
  background: linear-gradient(90deg, var(--accent), var(--primary));
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

.section {
  display: none;
  animation: fadeIn 0.6s ease-out;
}

.section.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.card {
  background: rgba(30, 30, 40, 0.7);
  backdrop-filter: blur(12px);
  border-radius: 20px;
  border: 1px solid var(--card-border);
  box-shadow: var(--card-shadow);
  padding: 25px;
  margin-bottom: 25px;
  transition: transform 0.4s, box-shadow 0.4s;
}

.card:hover {
  transform: translateY(-8px);
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.45);
}

.card-title {
  font-size: 1.4rem;
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--primary);
  color: var(--accent);
  display: flex;
  align-items: center;
  gap: 10px;
}

.btn {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  border: none;
  padding: 12px 25px;
  border-radius: 50px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  box-shadow: 0 4px 15px rgba(138, 43, 226, 0.3);
}

.btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(138, 43, 226, 0.5);
}

.btn:active {
  transform: translateY(1px);
}

.btn-sm {
  padding: 8px 16px;
  font-size: 0.9rem;
}

.btn-outline {
  background: transparent;
  border: 2px solid var(--primary);
  color: var(--accent);
}

.btn-danger {
  background: linear-gradient(135deg, var(--danger), #c2185b);
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.player-card {
  position: relative;
  overflow: hidden;
  padding: 20px;
}

.player-card::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(147,112,219,0.1) 0%, transparent 70%);
  z-index: -1;
}

.player-card h3 {
  font-size: 1.3rem;
  margin-bottom: 15px;
  color: var(--accent);
}

.balance {
  font-size: 1.8rem;
  font-weight: 700;
  margin: 10px 0;
  color: var(--light);
  text-shadow: 0 0 10px rgba(255,255,255,0.2);
}

.currency {
  color: var(--accent);
  font-size: 1.2rem;
}

.input-group {
  margin-bottom: 20px;
}

.input-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: var(--accent);
}

.input-group input {
  width: 100%;
  padding: 14px;
  background: rgba(40, 40, 50, 0.6);
  border: 1px solid var(--card-border);
  border-radius: 12px;
  color: var(--light);
  font-size: 1.1rem;
  transition: all 0.3s;
}

.input-group input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.3);
}

/* NFC اسکنر استایل */
.nfc-scanner {
  text-align: center;
  padding: 30px;
  margin: 20px 0;
  border-radius: 20px;
  background: rgba(40, 40, 50, 0.4);
  border: 2px dashed var(--card-border);
  transition: all 0.4s;
}

.scan-prompt {
  font-size: 1.4rem;
  margin-bottom: 20px;
  color: var(--accent);
}

.nfc-icon {
  font-size: 4rem;
  color: var(--primary);
  margin-bottom: 20px;
  transition: all 0.5s;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); opacity: 0.7; }
  50% { transform: scale(1.1); opacity: 1; }
  100% { transform: scale(1); opacity: 0.7; }
}

.scanning-active .nfc-icon {
  color: var(--success);
  animation: scanning 1.5s infinite;
}

@keyframes scanning {
  0% { transform: scale(1); }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); }
}

.scan-success .nfc-icon {
  color: var(--success);
  animation: success 1s ease;
}

@keyframes success {
  0% { transform: scale(1); }
  25% { transform: scale(1.8); opacity: 0.8; }
  50% { transform: scale(0.8); opacity: 1; }
  75% { transform: scale(1.4); }
  100% { transform: scale(1); }
}

/* پاپ‌آپ استایل */
.popup {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(10, 10, 15, 0.95);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.4s;
}

.popup.active {
  opacity: 1;
  visibility: visible;
}

.popup-content {
  background: linear-gradient(145deg, var(--gray), var(--darker));
  width: 90%;
  max-width: 500px;
  border-radius: 20px;
  padding: 30px;
  box-shadow: var(--card-shadow);
  border: 1px solid var(--card-border);
  transform: scale(0.9);
  transition: transform 0.4s;
}

.popup.active .popup-content {
  transform: scale(1);
}

.popup-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid var(--primary);
}

.popup-title {
  font-size: 1.6rem;
  color: var(--accent);
}

.close-btn {
  background: none;
  border: none;
  color: var(--light);
  font-size: 1.8rem;
  cursor: pointer;
  transition: color 0.3s;
}

.close-btn:hover {
  color: var(--danger);
}

/* تراکنش‌ها استایل */
.transactions {
  max-height: 300px;
  overflow-y: auto;
  margin-top: 20px;
}

.transaction-item {
  background: rgba(50, 50, 60, 0.4);
  border-radius: 12px;
  padding: 12px 15px;
  margin-bottom: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-left: 4px solid var(--primary);
}

.transaction-amount {
  font-weight: 700;
  font-size: 1.1rem;
}

.transaction-positive {
  color: var(--success);
}

.transaction-negative {
  color: var(--danger);
}

/* ریسپانسیو */
@media (max-width: 768px) {
  .grid {
    grid-template-columns: 1fr;
  }
  
  .logo {
    font-size: 2.2rem;
  }
  
  .title {
    font-size: 1.5rem;
  }
}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo">
      <i class="fas fa-landmark"></i>
    </div>
    <h1 class="title">بانک اختصاصی مونوپولی</h1>
  </header>

  <!-- بخش اصلی برنامه -->
  <main>
    <!-- بخش راه‌اندازی -->
    <section id="setupSection" class="section active">
      <div class="card">
        <h2 class="card-title"><i class="fas fa-cogs"></i> راه‌اندازی اولیه</h2>
        
        <div class="input-group">
          <label for="playerCount">تعداد بازیکنان</label>
          <input type="number" id="playerCount" min="2" max="8" value="4">
        </div>
        
        <button id="confirmPlayers" class="btn">
          <i class="fas fa-check-circle"></i> تأیید بازیکنان
        </button>
      </div>
      
      <div id="playerSetup" style="display:none;">
        <div class="card">
          <h2 class="card-title"><i class="fas fa-users"></i> تنظیمات بازیکنان</h2>
          <div class="grid" id="playerGrid"></div>
          
          <div class="nfc-scanner">
            <div class="scan-prompt">
              <i class="fas fa-hand-point-down"></i> کارت NFC بازیکن را اسکن کنید
            </div>
            <div class="nfc-icon">
              <i class="fas fa-rss"></i>
            </div>
            <p>کارت NFC را نزدیک دستگاه نگه دارید</p>
          </div>
          
          <button id="startGame" class="btn" style="display:none; margin-top:20px;">
            <i class="fas fa-play"></i> شروع بازی
          </button>
        </div>
      </div>
    </section>

    <!-- بخش اصلی بازی -->
    <section id="gameSection" class="section">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <h2 class="card-title"><i class="fas fa-coins"></i> وضعیت مالی</h2>
          <button id="managePlayers" class="btn btn-outline btn-sm">
            <i class="fas fa-user-edit"></i> مدیریت بازیکنان
          </button>
        </div>
        
        <div class="grid" id="playerStatusGrid"></div>
      </div>
      
      <div class="card">
        <h2 class="card-title"><i class="fas fa-exchange-alt"></i> عملیات بانکی</h2>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
          <button id="transferBtn" class="btn">
            <i class="fas fa-paper-plane"></i> انتقال وجه
          </button>
          <button id="depositBtn" class="btn">
            <i class="fas fa-donate"></i> واریز به حساب
          </button>
          <button id="withdrawBtn" class="btn">
            <i class="fas fa-hand-holding-usd"></i> برداشت از حساب
          </button>
          <button id="transactionsBtn" class="btn">
            <i class="fas fa-history"></i> تاریخچه تراکنش‌ها
          </button>
        </div>
      </div>
      
      <div class="card">
        <h2 class="card-title"><i class="fas fa-sync-alt"></i> عملیات سریع</h2>
        <button id="collectBtn" class="btn" style="margin-bottom:10px;">
          <i class="fas fa-hand-holding-usd"></i> دریافت ۲۰۰ هزار تومان (عبور از شروع)
        </button>
        <button id="taxBtn" class="btn btn-danger">
          <i class="fas fa-file-invoice-dollar"></i> پرداخت مالیات (۷۵ هزار تومان)
        </button>
      </div>
    </section>
  </main>
</div>

<!-- پاپ‌آپ‌ها -->
<div id="transferPopup" class="popup">
  <div class="popup-content">
    <div class="popup-header">
      <h3 class="popup-title"><i class="fas fa-paper-plane"></i> انتقال وجه</h3>
      <button class="close-btn">&times;</button>
    </div>
    <div class="input-group">
      <label for="fromPlayer">انتقال دهنده</label>
      <select id="fromPlayer" class="input"></select>
    </div>
    <div class="input-group">
      <label for="toPlayer">دریافت کننده</label>
      <select id="toPlayer" class="input"></select>
    </div>
    <div class="input-group">
      <label for="amount">مبلغ (تومان)</label>
      <input type="number" id="amount" min="1000" step="1000" value="1000">
    </div>
    
    <div class="nfc-scanner">
      <div class="scan-prompt">
        <i class="fas fa-hand-point-down"></i> کارت NFC دریافت کننده را اسکن کنید
      </div>
      <div class="nfc-icon">
        <i class="fas fa-rss"></i>
      </div>
    </div>
    
    <button id="confirmTransfer" class="btn" style="width:100%; margin-top:20px;">
      <i class="fas fa-check"></i> تأیید انتقال
    </button>
  </div>
</div>

<!-- سایر پاپ‌آپ‌ها (Deposit, Withdraw, Transactions) به صورت مشابه پیاده‌سازی می‌شوند -->

<script>
// ==================== مدیریت وضعیت برنامه ====================
const state = {
  players: [],
  transactions: [],
  gameStarted: false
};

// ==================== NFC منطق - نسخه ترمیم شده ====================
document.addEventListener('DOMContentLoaded', () => {
  // فعال‌سازی NFC هنگام لود صفحه
  if ('NDEFReader' in window) {
    initNFC();
  } else {
    console.error('مرورگر از Web NFC پشتیبانی نمی‌کند');
    alert("مرورگر شما از فناوری NFC پشتیبانی نمی‌کند. لطفاً از Chrome برای اندروید استفاده کنید");
  }
});

let ndefReader;
let activeScanMode = null; // 'setup' یا 'transfer'

async function initNFC() {
  try {
    ndefReader = new NDEFReader();
    ndefReader.onerror = (event) => {
      console.error("خطای NFC:", event.message);
      alert(`خطای NFC: ${event.message || 'خطای ناشناخته'}`);
    };
    
    // هندلر اصلی خواندن NFC
    ndefReader.onreading = (event) => {
      const nfcId = event.serialNumber;
      console.log("کارت اسکن شد:", nfcId);
      
      // تشخیص حالت فعلی اسکن
      if (activeScanMode === 'setup') {
        handleInitialScan(nfcId);
      } 
      else if (activeScanMode === 'transfer') {
        handleTransferScan(nfcId);
      }
      
      // جلوه بصری تأیید اسکن
      showScanConfirmation();
    };
  } catch (err) {
    console.error("خطا در راه‌اندازی NFC:", err);
    alert(`خطا در راه‌اندازی NFC: ${err.message}`);
  }
}

// فعال‌سازی اسکنر NFC
function startNFCScan(mode) {
  activeScanMode = mode;
  try {
    ndefReader.scan();
    console.log(`اسکن NFC فعال (حالت: ${mode})`);
    
    // نمایش وضعیت اسکن در UI
    const scanner = document.querySelector('.nfc-scanner');
    if (scanner) scanner.classList.add('scanning-active');
  } catch (err) {
    console.error("خطا در شروع اسکن:", err);
    alert(`خطا در شروع اسکن NFC: ${err.message}`);
  }
}

// توقف اسکنر NFC
function stopNFCScan() {
  try {
    if (ndefReader) {
      ndefReader.onreading = null;
    }
    activeScanMode = null;
    
    // غیرفعال کردن وضعیت اسکن در UI
    const scanner = document.querySelector('.nfc-scanner');
    if (scanner) scanner.classList.remove('scanning-active');
    
    console.log("اسکن NFC متوقف شد");
  } catch (err) {
    console.error("خطا در توقف اسکن:", err);
  }
}

// نمایش تأیید بصری اسکن موفق
function showScanConfirmation() {
  const scanner = document.querySelector('.nfc-scanner');
  if (!scanner) return;
  
  scanner.classList.add('scan-success');
  setTimeout(() => {
    scanner.classList.remove('scan-success');
  }, 1000);
}

// ==================== هندلرهای اسکن NFC ====================
function handleInitialScan(scannedId) {
  console.log("اسکن در حالت تنظیمات:", scannedId);
  
  // پیدا کردن اولین بازیکن بدون کارت
  const playerWithoutCard = state.players.find(p => !p.nfcId);
  
  if (playerWithoutCard) {
    playerWithoutCard.nfcId = scannedId;
    updatePlayerDisplay();
    
    // بررسی برای نمایش دکمه شروع بازی
    const allPlayersHaveCards = state.players.every(p => p.nfcId);
    if (allPlayersHaveCards) {
      document.getElementById('startGame').style.display = 'block';
    }
  }
}

function handleTransferScan(scannedId) {
  console.log("اسکن در حالت انتقال وجه:", scannedId);
  
  const receiverPlayer = state.players.find(p => p.nfcId === scannedId);
  if (receiverPlayer) {
    document.getElementById('toPlayer').value = receiverPlayer.id;
  }
}

// ==================== مدیریت پلیرها ====================
document.getElementById('confirmPlayers').addEventListener('click', () => {
  const playerCount = parseInt(document.getElementById('playerCount').value);
  setupPlayers(playerCount);
});

function setupPlayers(count) {
  state.players = [];
  
  for (let i = 1; i <= count; i++) {
    state.players.push({
      id: i,
      name: `بازیکن ${i}`,
      balance: 1500000,
      nfcId: null
    });
  }
  
  document.getElementById('playerSetup').style.display = 'block';
  updatePlayerDisplay();
  
  // فعال‌سازی NFC برای تنظیم کارتها
  startNFCScan('setup');
}

function updatePlayerDisplay() {
  const playerGrid = document.getElementById('playerGrid');
  playerGrid.innerHTML = '';
  
  state.players.forEach(player => {
    const playerCard = document.createElement('div');
    playerCard.className = 'player-card';
    playerCard.innerHTML = `
      <h3>${player.name}</h3>
      <div>موجودی: <span class="balance">${player.balance.toLocaleString()}</span> <span class="currency">تومان</span></div>
      <div style="margin-top:10px; color:${player.nfcId ? 'var(--success)' : 'var(--danger)'}">
        ${player.nfcId ? 'کارت NFC ثبت شد' : 'کارت NFC ثبت نشده'}
      </div>
    `;
    playerGrid.appendChild(playerCard);
  });
}

// ==================== مدیریت بازی ====================
document.getElementById('startGame').addEventListener('click', () => {
  state.gameStarted = true;
  document.getElementById('setupSection').classList.remove('active');
  document.getElementById('gameSection').classList.add('active');
  stopNFCScan();
});

// ==================== تراکنش‌ها ====================
document.getElementById('transferBtn').addEventListener('click', () => {
  document.getElementById('transferPopup').classList.add('active');
  startNFCScan('transfer');
});

document.getElementById('confirmTransfer').addEventListener('click', () => {
  const fromId = parseInt(document.getElementById('fromPlayer').value);
  const toId = parseInt(document.getElementById('toPlayer').value);
  const amount = parseInt(document.getElementById('amount').value);
  
  if (fromId && toId && amount > 0) {
    transferMoney(fromId, toId, amount);
    document.getElementById('transferPopup').classList.remove('active');
    stopNFCScan();
  }
});

function transferMoney(fromId, toId, amount) {
  const fromPlayer = state.players.find(p => p.id === fromId);
  const toPlayer = state.players.find(p => p.id === toId);
  
  if (fromPlayer && toPlayer && fromPlayer.balance >= amount) {
    fromPlayer.balance -= amount;
    toPlayer.balance += amount;
    
    // ثبت تراکنش
    state.transactions.push({
      id: Date.now(),
      from: fromPlayer.id,
      to: toPlayer.id,
      amount,
      timestamp: new Date()
    });
    
    updateGameDisplay();
  }
}

function updateGameDisplay() {
  const playerStatusGrid = document.getElementById('playerStatusGrid');
  playerStatusGrid.innerHTML = '';
  
  state.players.forEach(player => {
    const playerCard = document.createElement('div');
    playerCard.className = 'player-card';
    playerCard.innerHTML = `
      <h3>${player.name}</h3>
      <div>موجودی: <span class="balance">${player.balance.toLocaleString()}</span> <span class="currency">تومان</span></div>
      <div style="margin-top:10px; font-size:0.9em; color:var(--accent)">
        NFC: ${player.nfcId ? 'فعال' : 'غیرفعال'}
      </div>
    `;
    playerStatusGrid.appendChild(playerCard);
  });
}

// ==================== مدیریت پاپ‌آپ‌ها ====================
document.querySelectorAll('.close-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    btn.closest('.popup').classList.remove('active');
    stopNFCScan();
  });
});

// ==================== رویدادهای سریع ====================
document.getElementById('collectBtn').addEventListener('click', () => {
  state.players.forEach(player => {
    player.balance += 200000;
  });
  updateGameDisplay();
});

document.getElementById('taxBtn').addEventListener('click', () => {
  state.players.forEach(player => {
    player.balance -= 75000;
  });
  updateGameDisplay();
});
</script>
</body>
</html>
