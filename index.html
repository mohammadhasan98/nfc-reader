<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¨Ø§Ù†Ú© Ù…ÙˆÙ†ÙˆÙ¾ÙˆÙ„ÛŒ</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg-dark: #0D1B2A;
  --bg-light: #1B263B;
  --primary: #3A86FF;
  --primary-hover: #5c9bff;
  --secondary: #415A77;
  --secondary-hover: #527194;
  --text: #E0E1DD;
  --danger: #ff4b4b;
  --success: #4bff7b;
  --danger-bg: rgba(255, 75, 75, 0.8);
  --success-bg: rgba(75, 255, 123, 0.8);

  /* Player colors for cards */
  --player-color-1: #FF6B6B;
  --player-color-2: #4ECDC4;
  --player-color-3: #45B7D1;
  --player-color-4: #F7D154;
  --player-color-5: #9A77D1;
  --player-color-6: #50C878;
  --player-color-7: #FF9F1C;
  --player-color-8: #F5558D;

  font-family: 'Vazirmatn', sans-serif;
}
* { 
  box-sizing: border-box; 
  -webkit-tap-highlight-color: transparent;
}
body {
  background: var(--bg-dark);
  color: var(--text);
  margin: 0;
  padding: 0;
  user-select: none;
  -webkit-user-select: none;
  font-size: 16px;
  overflow-x: hidden;
}
section { 
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  padding: 20px;
  opacity: 0;
  pointer-events: none;
  transform: translateX(20px);
  transition: opacity 0.5s ease, transform 0.5s ease;
}
section.active { 
  opacity: 1;
  pointer-events: auto;
  transform: translateX(0);
}
h1, h2, h3 { text-align:center; color: var(--text); font-weight: 700; }
h1 { 
    font-size: 2.5rem; 
    margin-bottom: 25px; 
    background: linear-gradient(45deg, var(--primary), var(--primary-hover));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: 900;
    text-shadow: 0 0 20px rgba(58, 134, 255, 0.2);
}
h2 { margin-bottom: 30px; font-size: 1.8rem;}

/* --- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ --- */
button {
  font-family:'Vazirmatn', sans-serif;
  border:none;
  border-radius: 25px;
  padding: 12px 28px;
  font-size:16px;
  margin: 0; /* Changed from margin: 10px auto */
  display:block;
  cursor:pointer;
  transition: all .2s ease-in-out;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  width: 100%;
}
button:active { transform: translateY(1px) scale(0.98); }
button:disabled {
  background: #778DA9 !important;
  color: #ccc;
  cursor: not-allowed;
  box-shadow: none;
  transform: none !important;
}
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover:not(:disabled) { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(58, 134, 255, 0.2);}
.btn-secondary { background: var(--secondary); color: var(--text); }
.btn-secondary:hover:not(:disabled) { background: var(--secondary-hover); }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover:not(:disabled) { background: #e03a3a; }
.btn-success { background: var(--success); color: var(--bg-dark); }
.btn-success:hover:not(:disabled) { background: #60ff8c; }

#startGameBtn {
    padding: 16px 40px;
    font-size: 18px;
    font-weight: 700;
    border-radius: 30px;
    margin: 30px auto 0;
    min-width: 180px;
    width: auto;
}

#endGame { margin: 30px auto 0; max-width: 300px; }

.floating-btn {
  position: fixed; top: 15px; left: 15px;
  width: 50px; height: 50px; border-radius: 50%;
  background: var(--secondary); color: var(--text);
  display: flex; justify-content: center; align-items: center;
  padding: 0; margin: 0; z-index: 1000;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.floating-btn svg { width: 24px; height: 24px; }

/* --- ÙØ±Ù…â€ŒÙ‡Ø§ --- */
input, select {
  font-family:'Vazirmatn', sans-serif;
  border: 1px solid var(--secondary); background: var(--bg-light);
  color: var(--text); border-radius:15px; padding: 12px 20px;
  font-size:16px; text-align:center; width:90%;
  max-width: 300px; margin: 10px auto; display:block;
  transition: all .2s ease;
}
input:focus, select:focus {
  outline: none; border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.3);
}
label { display: block; text-align: center; margin-top: 20px; color: #aab; }

/* --- ØµÙØ­Ù‡ Ø´Ø±ÙˆØ¹ --- */
@keyframes pulse-border {
  0% { box-shadow: 0 0 0 0 rgba(58, 134, 255, 0.6); }
  70% { box-shadow: 0 0 0 10px rgba(58, 134, 255, 0); }
  100% { box-shadow: 0 0 0 0 rgba(58, 134, 255, 0); }
}
.scan-prompt {
  text-align: center; font-size: 18px; color: var(--primary-hover);
  padding: 15px; border: 2px solid var(--primary);
  border-radius: 15px; margin: 30px auto; max-width: 320px;
  animation: pulse-border 2.5s infinite cubic-bezier(0.66, 0, 0, 1);
}

#scannedPlayersList {
    margin-top: 25px; padding: 0 10px;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
}
.scanned-player-item {
    border-radius: 12px;
    font-size: 16px;
    text-align: center;
    padding: 15px 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    min-height: 70px;
    color: #fff;
    font-weight: 600;
    text-shadow: 0 1px 3px rgba(0,0,0,0.4);
}
.scanned-player-item.color-1 { background-color: var(--player-color-1); }
.scanned-player-item.color-2 { background-color: var(--player-color-2); }
.scanned-player-item.color-3 { background-color: var(--player-color-3); }
.scanned-player-item.color-4 { background-color: var(--player-color-4); }
.scanned-player-item.color-5 { background-color: var(--player-color-5); }
.scanned-player-item.color-6 { background-color: var(--player-color-6); }
.scanned-player-item.color-7 { background-color: var(--player-color-7); }
.scanned-player-item.color-8 { background-color: var(--player-color-8); }

.scanned-player-item .player-id {
    font-weight: 900;
    background: rgba(0,0,0,0.2);
    padding: 3px 8px;
    border-radius: 7px;
}
.scanned-player-item .player-name {
    flex-grow: 1;
    text-align: right;
}

/* --- Ú†ÛŒØ¯Ù…Ø§Ù† Ø¬Ø¯ÛŒØ¯ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ --- */
#game-actions-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: auto auto;
    gap: 15px;
    margin-bottom: 30px;
}
#game-actions-container button { height: 100%; }
#transferBtn { grid-column: 2 / 3; grid-row: 1 / 3; font-size: 18px; padding: 20px; }
#rewardBtn { grid-column: 1 / 2; grid-row: 1 / 2; }
#bankTxBtn { grid-column: 1 / 2; grid-row: 2 / 3; }


/* --- Ù„ÛŒØ³Øª Ùˆ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† (ØµÙØ­Ù‡ Ø¨Ø§Ø²ÛŒ) --- */
#playerList {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px; margin-top: 20px;
}
@keyframes slideInCard {
  from { opacity: 0; transform: translateY(20px) scale(0.98); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}
.player-card {
  background: linear-gradient(145deg, var(--bg-light), #212f45);
  border-radius: 20px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  transition: transform .2s ease, background-color 0.4s ease, opacity 0.4s ease;
  animation: slideInCard 0.5s ease-out forwards;
  opacity: 0; position: relative; overflow: hidden;
  border: 1px solid rgba(255, 255, 255, 0.05);
}
.player-card:hover { transform: translateY(-3px); }
.player-card-header {
  padding: 12px 15px; display: flex;
  align-items: center; justify-content: space-between;
  color: #fff; font-weight: 700;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}
.player-card.color-1 .player-card-header { background-color: var(--player-color-1); }
.player-card.color-2 .player-card-header { background-color: var(--player-color-2); }
.player-card.color-3 .player-card-header { background-color: var(--player-color-3); }
.player-card.color-4 .player-card-header { background-color: var(--player-color-4); }
.player-card.color-5 .player-card-header { background-color: var(--player-color-5); }
.player-card.color-6 .player-card-header { background-color: var(--player-color-6); }
.player-card.color-7 .player-card-header { background-color: var(--player-color-7); }
.player-card.color-8 .player-card-header { background-color: var(--player-color-8); }

.player-name { font-size: 16px; }

.player-id-tag {
  font-size: 18px; font-weight: 700;
  background: rgba(0,0,0,0.2);
  padding: 2px 10px;
  border-radius: 8px;
}
.player-card-body { padding: 15px; text-align: center; }
.player-card-body label {
    font-size: 14px; color: #aab;
    margin: 0 0 5px 0;
}
.player-balance { 
  font-size: 26px; font-weight: 700;
  direction: ltr; 
  transition: color .3s ease, transform 0.3s ease, background-color 0.5s ease; 
  padding: 3px 10px;
  border-radius: 10px;
  display: inline-block;
  min-width: 100px;
}

@keyframes stamp-animation {
  0% { opacity: 0; transform: translate(-50%, -50%) rotate(-15deg) scale(2.5); }
  60% { opacity: 0.8; transform: translate(-50%, -50%) rotate(-15deg) scale(0.9); }
  80% { transform: translate(-50%, -50%) rotate(-15deg) scale(1.1); }
  100% { opacity: 0.8; transform: translate(-50%, -50%) rotate(-15deg) scale(1); }
}
.player-card.bankrupt { opacity: 0.5; background: #2a2a2a; }
.player-card.bankrupt::after{
  content:"ÙˆØ±Ø´Ú©Ø³ØªÙ‡"; position: absolute; top: 50%; left: 50%;
  transform-origin: center center; border: 4px solid var(--danger);
  color: var(--danger); background: transparent; padding: 5px 20px;
  border-radius: 10px; font-size: 20px; font-weight: 900;
  letter-spacing: 1px; opacity: 0;
  animation: stamp-animation 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  animation-delay: 0.2s;
}

@keyframes balance-up-anim { 
  0% { background-color: var(--success-bg); transform: scale(1.1); } 
  80% { background-color: var(--success-bg); transform: scale(1); }
  100% { background-color: transparent; transform: scale(1); } 
}
@keyframes balance-down-anim { 
  0% { background-color: var(--danger-bg); transform: scale(1.1); } 
  80% { background-color: var(--danger-bg); transform: scale(1); }
  100% { background-color: transparent; transform: scale(1); } 
}
.balance-up { animation: balance-up-anim 1.8s ease; }
.balance-down { animation: balance-down-anim 1.8s ease; }
.balance-down-delayed { animation: balance-down-anim 1.8s ease; }
.balance-up-delayed { animation: balance-up-anim 1.8s ease; }

/* --- Ù¾Ø§Ù¾â€ŒØ¢Ù¾â€ŒÙ‡Ø§ --- */
@keyframes popupFadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
.popup {
  position:fixed; inset:0; background:rgba(0,0,0,0.6);
  display:none; justify-content:center; align-items:center;
  z-index:99; backdrop-filter: blur(5px);
}
.popup.active { display:flex; }
.popup.active .popup-box { animation: popupFadeIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.popup-box {
  background: var(--bg-light); border-radius:30px; padding:25px;
  width:90%; max-width:400px; text-align:center;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  border: 1px solid var(--secondary);
}
.popup-box .button-group {
    display: flex; justify-content: center; gap: 10px;
    margin-top: 20px; flex-wrap: wrap;
}
.popup-box .button-group button { min-width: 120px; width: auto; }

/* --- Ú©ÛŒØ¨ÙˆØ±Ø¯ Ùˆ Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ --- */
.circle {
  width:100px; height:100px; border-radius:50%; border: 2px solid var(--primary);
  color:var(--text); font-size:18px; display: flex; justify-content: center;
  align-items: center; text-align: center; padding: 5px; margin:20px auto;
  transition: all .3s ease; overflow: hidden; word-break: break-word;
}
.circle.filled { background: var(--primary); color: #fff; }
@keyframes circleNameFadeIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
.name-animating { animation: circleNameFadeIn 0.4s ease; }

@keyframes pulse-effect {
  0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(58, 134, 255, 0.7); }
  50% { transform: scale(1.05); box-shadow: 0 0 10px 5px rgba(58, 134, 255, 0); }
  100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(58, 134, 255, 0); }
}
.pulsing {
  animation: pulse-effect 1.5s infinite ease-in-out;
}

.keyboard { 
    display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; 
    margin: 20px 0; padding: 0 10px;
}
.keyboard button{ 
    border-radius:15px; padding:14px; font-size:20px; background: var(--secondary);
    box-shadow: none; margin: 0; min-width: auto; width: 100%;
}
.keyboard button:hover { background: var(--secondary-hover); transform: none; }
.keyboard button:active { transform: scale(0.95); background: var(--primary); }

/* --- Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø§Ù†ØªÙ‚Ø§Ù„ --- */
.fade {
  position:fixed; inset:0; background: rgba(13, 27, 42, 0.5);
  backdrop-filter: blur(10px); color:#fff; display:none; justify-content:center;
  align-items:center; flex-direction:column; font-size:20px; z-index:999;
}
.fade.active { display:flex; }
#transferInfo, #bankTxInfo { 
  display: flex; justify-content: space-around; align-items: center; 
  width: 100%; max-width: 400px; padding: 0 20px; position: relative;
}
#transferInfo .circle, #bankTxInfo .bank-entity { opacity: 0; transform: scale(0.8); }

#fadeAmount, #fadeBankTxAmount {
    position: absolute; left: 50%; transform: translateX(-50%); top: -40px;
    font-size: 24px; font-weight: bold; opacity: 0;
    transition: opacity 0.5s ease 0.5s;
    z-index: 3;
}

.bank-entity {
    width: 100px; height: 100px;
    display: flex; align-items: center; justify-content: center;
}
.bank-entity .bank-text-label {
    width: 100px; height: 100px; border-radius: 20px; border: 2px dashed #aaa;
    display: flex; align-items: center; justify-content: center;
    font-size: 24px; font-weight: bold; color: white;
}
.bank-entity .circle { margin: 0; }

@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
.fade-entity-anim { animation: pulse 0.8s ease-in-out forwards; animation-delay: 0.1s; opacity: 1 !important; transform: scale(1); }
.fade-receiver-anim { animation-delay: 1.5s !important; }


/* New Flow Animation & Z-INDEX FIX */
.transfer-flow {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 100px;
    height: 10px;
    z-index: 1; /* Ù„Ø§ÛŒÙ‡ Ø²ÛŒØ±ÛŒÙ† */
}
/* Z-INDEX FIX: Make sure entities are on top */
#transferInfo .circle, 
#bankTxInfo .bank-entity,
#rewardFade .circle {
    position: relative; /* Must be positioned for z-index to work */
    z-index: 2; /* Ù„Ø§ÛŒÙ‡ Ø±ÙˆÛŒÛŒ */
}


.dot {
    position: absolute;
    width: 10px;
    height: 10px;
    background: #fff;
    border-radius: 50%;
    box-shadow: 0 0 10px #fff, 0 0 20px var(--primary);
    opacity: 0;
    animation: flow-dot-anim 1.2s ease-in-out infinite;
}
.dot:nth-child(2) { animation-delay: 0.3s; }
.dot:nth-child(3) { animation-delay: 0.6s; }

@keyframes flow-dot-anim {
    0% { transform: translateX(80px); opacity: 0; }
    25% { opacity: 1; }
    75% { opacity: 1; }
    100% { transform: translateX(-80px); opacity: 0; }
}

#rewardFade .transfer-flow {
    width: 10px;
    height: 80px;
    margin: 15px 0;
}
#rewardFade .dot {
    animation-name: flow-dot-vertical-anim;
    animation-duration: 1.5s;
}
@keyframes flow-dot-vertical-anim {
    0% { transform: translateY(-50px); opacity: 0; }
    25% { opacity: 1; }
    75% { opacity: 1; }
    100% { transform: translateY(50px); opacity: 0; }
}


#dialogPopup, #addPlayerPopup, #bankTxPopup { z-index: 100; }
#dialogMessage { font-size: 18px; line-height: 1.6; margin-bottom: 25px;}

</style>
</head>
<body>

<button id="fullscreenBtn" class="floating-btn">
  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M9.00002 4.00002H4.00002V9.00002" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M20 9.00002V4.00002H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M15 20H20V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M4.00002 15H9.00002V20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</button>

<section id="start" class="active">
  <h1>ğŸ¦ Ø¨Ø§Ù†Ú© Ù…ÙˆÙ†ÙˆÙ¾ÙˆÙ„ÛŒ</h1>
  <p class="scan-prompt">Ù„Ø·ÙØ§ Ú©Ø§Ø±Øª Ù‡Ø± Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯</p>
  <div id="scannedPlayersList"></div>
  <label for="startMoney">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§ÙˆÙ„ÛŒÙ‡:</label>
  <input type="text" inputmode="numeric" id="startMoney" placeholder="Ù…Ø«Ù„Ø§Ù‹ Û±Ûµ,Û°Û°Û°">
  <label for="turnReward">Ù¾Ø§Ø¯Ø§Ø´ Ø¯ÙˆØ± Ú©Ø§Ù…Ù„:</label>
  <input type="text" inputmode="numeric" id="turnReward" placeholder="Ù…Ø«Ù„Ø§Ù‹ Û²,Û°Û°Û°">
  <button id="startGameBtn" class="btn-primary" disabled>Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
</section>

<section id="game">
  <div id="game-actions-container">
    <button id="transferBtn" class="btn-primary">ğŸ’¸ Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª</button>
    <button id="rewardBtn" class="btn-primary">ğŸ Ù¾Ø§Ø¯Ø§Ø´ Ø¯ÙˆØ±</button>
    <button id="bankTxBtn" class="btn-primary">ğŸ¦ Ø¯Ø±ÛŒØ§ÙØª/Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡ Ø¨Ø§Ù†Ú©</button>
  </div>
  <div id="playerList"></div>
  <button id="endGame" class="btn-danger">Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ</button>
</section>

<!-- Popups -->
<div id="transferPopup" class="popup">
  <div class="popup-box">
    <h2 id="transferTitle">ğŸ’¸ Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª</h2>
    <div id="transferCircles" style="display:flex; justify-content:center; gap:20px;">
      <div><label>Ø§Ø²</label><div id="fromCircle" class="circle">Ú©Ø§Ø±Øª Ø¨Ú©Ø´ÛŒØ¯</div></div>
      <div><label>Ø¨Ù‡</label><div id="toCircle" class="circle">Ú©Ø§Ø±Øª Ø¨Ú©Ø´ÛŒØ¯</div></div>
    </div>
    <input type="text" inputmode="numeric" id="transferAmount" placeholder="Ù…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    <div class="button-group">
      <button id="confirmTransfer" class="btn-success" disabled>ØªØ§ÛŒÛŒØ¯</button>
      <button onclick="hidePopup('transferPopup')" class="btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>
  </div>
</div>

<div id="rewardPopup" class="popup">
  <div class="popup-box">
    <h2 id="rewardTitle">ğŸ Ù¾Ø§Ø¯Ø§Ø´ Ø¯ÙˆØ±</h2>
    <div id="rewardCircle" class="circle">Ú©Ø§Ø±Øª Ø¨Ú©Ø´ÛŒØ¯</div>
    <div class="button-group">
      <button id="confirmReward" class="btn-success" disabled>ØªØ§ÛŒÛŒØ¯</button>
      <button onclick="hidePopup('rewardPopup')" class="btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>
  </div>
</div>

<div id="bankTxPopup" class="popup">
    <div class="popup-box">
        <h2 id="bankTxPopupTitle">Ø¯Ø±ÛŒØ§ÙØª ÛŒØ§ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡ Ø¨Ø§Ù†Ú©</h2>
        <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px;">
            <button id="bankTxTypeReceive" class="btn-primary">Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² Ø¨Ø§Ù†Ú©</button>
            <button id="bankTxTypePay" class="btn-secondary">Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡ Ø¨Ø§Ù†Ú©</button>
        </div>
        <div id="bankTxCircle" class="circle">Ú©Ø§Ø±Øª Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ Ø¨Ú©Ø´ÛŒØ¯</div>
        <input type="text" inputmode="numeric" id="bankTxAmount" placeholder="Ù…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
        <div class="button-group">
            <button id="confirmBankTx" class="btn-success" disabled>ØªØ§ÛŒÛŒØ¯</button>
            <button onclick="hidePopup('bankTxPopup')" class="btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
        </div>
    </div>
</div>


<div id="dialogPopup" class="popup">
  <div class="popup-box">
    <h2 id="dialogTitle">ØªÙˆØ¬Ù‡</h2>
    <p id="dialogMessage"></p>
    <div class="button-group">
      <button id="dialogConfirm" class="btn-primary">Ø¨Ø§Ø´Ù‡</button>
      <button id="dialogCancel" class="btn-secondary" style="display:none;">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>
  </div>
</div>

<div id="addPlayerPopup" class="popup">
    <div class="popup-box">
        <h2>Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¬Ø¯ÛŒØ¯</h2>
        <p>Ú©Ø§Ø±Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ø´Ù…Ø§Ø±Ù‡ <strong id="newPlayerId"></strong> Ø§Ø³Ú©Ù† Ø´Ø¯.</p>
        <input type="text" id="newPlayerName" placeholder="Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
        <div class="button-group">
            <button id="confirmAddPlayer" class="btn-success">Ø§ÙØ²ÙˆØ¯Ù†</button>
            <button onclick="hidePopup('addPlayerPopup')" class="btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
        </div>
    </div>
</div>

<!-- Fade Animation Screens -->
<div id="transferFade" class="fade">
  <span id="fadeAmount"></span>
  <div id="transferInfo">
    <div id="fadeFromCircle" class="circle"></div>
    <div class="transfer-flow"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    <div id="fadeToCircle" class="circle"></div>
  </div>
</div>

<div id="rewardFade" class="fade">
  <div class="bank-entity"><div class="bank-text-label">Ø¨Ø§Ù†Ú©</div></div>
  <div class="transfer-flow"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
  <div class="circle"></div>
</div>

<div id="bankTxFade" class="fade">
    <span id="fadeBankTxAmount"></span>
    <div id="bankTxInfo">
        <div id="fadeBankTxGiver"></div>
        <div class="transfer-flow"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        <div id="fadeBankTxReceiver"></div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // ---- Global State & DOM Elements ----
    const sections = {
        start: document.getElementById('start'),
        game: document.getElementById('game'),
    };
    const popups = {
        transfer: document.getElementById('transferPopup'),
        reward: document.getElementById('rewardPopup'),
        bankTx: document.getElementById('bankTxPopup'),
        dialog: document.getElementById('dialogPopup'),
        addPlayer: document.getElementById('addPlayerPopup'),
    };
    const fades = {
        transfer: document.getElementById('transferFade'),
        reward: document.getElementById('rewardFade'),
        bankTx: document.getElementById('bankTxFade'),
    };

    let players = [];
    let gameState = {
        initialMoney: 15000,
        turnReward: 2000,
        scanTarget: null, // 'from', 'to', 'reward', 'addPlayer', 'bankTx'
        transfer: { from: null, to: null, amount: 0 },
        reward: { player: null, amount: 0 },
        bankTx: { player: null, amount: 0, type: 'receive' }, // 'receive' or 'pay'
        nextPlayerColorIndex: 1,
    };
    let nfcAbortController = null;

    // --- Formatters & Helpers ---
    const formatMoney = (amount) => new Intl.NumberFormat('fa-IR').format(amount);
    const parseFormattedNumber = (str) => parseInt(str.replace(/,/g, ''), 10) || 0;
    
    // Auto-format number inputs
    document.querySelectorAll('input[inputmode="numeric"]').forEach(input => {
        input.addEventListener('input', (e) => {
            let value = parseFormattedNumber(e.target.value);
            if (!isNaN(value)) {
                e.target.value = formatMoney(value);
            } else {
                e.target.value = '';
            }
        });
    });

    // ---- Page/Section Navigation ----
    const showSection = (sectionId) => {
        Object.values(sections).forEach(s => s.classList.remove('active'));
        sections[sectionId].classList.add('active');
    };

    const showPopup = (popupId) => { 
        if(popups[popupId]) popups[popupId].classList.add('active'); 
    };
    const hidePopup = (popupId) => { 
        if(popups[popupId]) popups[popupId].classList.remove('active'); 
    };
    
    const showDialog = (title, message, onConfirm, showCancel = false) => {
        document.getElementById('dialogTitle').textContent = title;
        document.getElementById('dialogMessage').innerHTML = message;
        const confirmBtn = document.getElementById('dialogConfirm');
        const cancelBtn = document.getElementById('dialogCancel');

        const confirmHandler = () => {
            hidePopup('dialog');
            if(onConfirm) onConfirm();
            confirmBtn.removeEventListener('click', confirmHandler);
            cancelBtn.removeEventListener('click', cancelHandler);
        };
        const cancelHandler = () => {
            hidePopup('dialog');
            confirmBtn.removeEventListener('click', confirmHandler);
            cancelBtn.removeEventListener('click', cancelHandler);
        };
        
        confirmBtn.addEventListener('click', confirmHandler);
        cancelBtn.addEventListener('click', cancelHandler);
        
        cancelBtn.style.display = showCancel ? 'block' : 'none';
        showPopup('dialog');
    };

    // ---- Player Management ----
    const addPlayer = (id, name) => {
        if(players.some(p => p.id === id)) {
            console.warn(`Player with ID ${id} already exists.`);
            return;
        }
        const newPlayer = {
            id,
            name,
            balance: gameState.initialMoney,
            colorClass: `color-${gameState.nextPlayerColorIndex}`,
            isBankrupt: false,
        };
        players.push(newPlayer);
        gameState.nextPlayerColorIndex = (gameState.nextPlayerColorIndex % 8) + 1;
        renderPlayers();
        updateStartButtonState();
    };

    const updateBalance = (playerId, amount, isDelayed = false) => {
        const player = players.find(p => p.id === playerId);
        if (!player) return;

        player.balance += amount;
        
        if (player.balance < 0) {
            player.isBankrupt = true;
        }

        const cardElement = document.getElementById(`player-${playerId}`);
        if(cardElement){
            const balanceEl = cardElement.querySelector('.player-balance');
            balanceEl.textContent = formatMoney(player.balance);
            
            const animClass = amount > 0 ? (isDelayed ? 'balance-up-delayed' : 'balance-up') : (isDelayed ? 'balance-down-delayed' : 'balance-down');
            balanceEl.classList.remove('balance-up', 'balance-down', 'balance-up-delayed', 'balance-down-delayed');
            void balanceEl.offsetWidth; // Trigger reflow
            balanceEl.classList.add(animClass);

            if(player.isBankrupt) {
                cardElement.classList.add('bankrupt');
            }
        }
    };
    
    const getPlayerById = (id) => players.find(p => p.id === id);

    // ---- Rendering ----
    const renderScannedPlayers = () => {
        const list = document.getElementById('scannedPlayersList');
        list.innerHTML = players.map(p => `
            <div class="scanned-player-item ${p.colorClass}">
                <span class="player-name">${p.name}</span>
                <span class="player-id">${p.id}</span>
            </div>
        `).join('');
    };

    const renderPlayers = () => {
        const list = document.getElementById('playerList');
        list.innerHTML = players.map(p => `
            <div id="player-${p.id}" class="player-card ${p.colorClass} ${p.isBankrupt ? 'bankrupt' : ''}">
                <div class="player-card-header">
                    <span class="player-name">${p.name}</span>
                    <span class="player-id-tag">${p.id}</span>
                </div>
                <div class="player-card-body">
                    <label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</label>
                    <div class="player-balance">${formatMoney(p.balance)}</div>
                </div>
            </div>
        `).join('');
    };
    
    const updateStartButtonState = () => {
        document.getElementById('startGameBtn').disabled = players.length < 2;
    };

    // ---- NFC Logic ----
    const startNFCScan = async (target) => {
        if (!("NDEFReader" in window)) {
            showDialog("Ø®Ø·Ø§", "Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø´Ù…Ø§ Ø§Ø² NFC Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.");
            return;
        }

        gameState.scanTarget = target;
        nfcAbortController = new AbortController();
        
        try {
            const ndef = new NDEFReader();
            await ndef.scan({ signal: nfcAbortController.signal });

            ndef.addEventListener("reading", ({ serialNumber }) => {
                const playerId = serialNumber; // Use the card's unique serial number
                handleNFCScan(playerId);
            });
            ndef.addEventListener("readingerror", () => {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ú©Ø§Ø±Øª NFC.");
                showDialog("Ø®Ø·Ø§", "Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ú©Ø§Ø±Øª Ù¾ÛŒØ´ Ø¢Ù…Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.");
            });
        } catch (error) {
            console.error(`Ø§Ø³Ú©Ù† NFC Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯: ${error}`);
            if (error.name !== 'AbortError') {
                showDialog("Ø®Ø·Ø§", "Ø§Ù…Ú©Ø§Ù† ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ NFC ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯. Ø¢ÛŒØ§ Ø±ÙˆØ´Ù† Ø§Ø³ØªØŸ");
            }
        }
    };

    const stopNFCScan = () => {
        if (nfcAbortController) {
            nfcAbortController.abort();
            nfcAbortController = null;
        }
        gameState.scanTarget = null;
        document.querySelectorAll('.pulsing').forEach(el => el.classList.remove('pulsing'));
    };

    const handleNFCScan = (id) => {
        const target = gameState.scanTarget;
        const player = getPlayerById(id);

        if (target === 'addPlayer') {
            if (player) {
                showDialog("Ø®Ø·Ø§", `Ø§ÛŒÙ† Ú©Ø§Ø±Øª Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù† "${player.name}" Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª.`);
            } else {
                document.getElementById('newPlayerId').textContent = id;
                document.getElementById('newPlayerName').value = '';
                showPopup('addPlayerPopup');
                stopNFCScan();
            }
        } else if (target) {
            if (!player) {
                showDialog("Ø®Ø·Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†", "Ø§ÛŒÙ† Ú©Ø§Ø±Øª Ø¯Ø± Ø¨Ø§Ø²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.");
                return;
            }
            if (player.isBankrupt) {
                 showDialog("Ø®Ø·Ø§", `Ø¨Ø§Ø²ÛŒÚ©Ù† "${player.name}" ÙˆØ±Ø´Ú©Ø³ØªÙ‡ Ø´Ø¯Ù‡ Ùˆ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¯Ø± ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ Ø´Ø±Ú©Øª Ú©Ù†Ø¯.`);
                 return;
            }

            switch(target) {
                case 'from':
                    if (gameState.transfer.to && gameState.transfer.to.id === id) {
                        showDialog("Ø®Ø·Ø§", "Ø¨Ø§Ø²ÛŒÚ©Ù† Ù…Ø¨Ø¯Ø§ Ùˆ Ù…Ù‚ØµØ¯ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ ÛŒÚ©Ø³Ø§Ù† Ø¨Ø§Ø´Ù†Ø¯.");
                        return;
                    }
                    gameState.transfer.from = player;
                    updateCircle('fromCircle', player);
                    break;
                case 'to':
                    if (gameState.transfer.from && gameState.transfer.from.id === id) {
                        showDialog("Ø®Ø·Ø§", "Ø¨Ø§Ø²ÛŒÚ©Ù† Ù…Ø¨Ø¯Ø§ Ùˆ Ù…Ù‚ØµØ¯ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ ÛŒÚ©Ø³Ø§Ù† Ø¨Ø§Ø´Ù†Ø¯.");
                        return;
                    }
                    gameState.transfer.to = player;
                    updateCircle('toCircle', player);
                    break;
                case 'reward':
                    gameState.reward.player = player;
                    updateCircle('rewardCircle', player);
                    break;
                case 'bankTx':
                    gameState.bankTx.player = player;
                    updateCircle('bankTxCircle', player);
                    break;
            }
            
            stopNFCScan();
            validatePopupForms();
        }
    };

    // ---- UI Update Logic ----
    const updateCircle = (circleId, player) => {
        const circle = document.getElementById(circleId);
        if(player) {
            circle.innerHTML = `<span class="name-animating">${player.name}</span>`;
            circle.classList.add('filled');
            circle.style.borderColor = `var(--player-color-${player.colorClass.split('-')[2]})`;
        } else {
            circle.innerHTML = circle.dataset.defaultText || "Ú©Ø§Ø±Øª Ø¨Ú©Ø´ÛŒØ¯";
            circle.classList.remove('filled');
            circle.style.borderColor = 'var(--primary)';
        }
    };
    
    // ---- Game Flow & Actions ----
    const startGame = () => {
        const startMoneyInput = document.getElementById('startMoney');
        const turnRewardInput = document.getElementById('turnReward');
        
        gameState.initialMoney = parseFormattedNumber(startMoneyInput.value) || 15000;
        gameState.turnReward = parseFormattedNumber(turnRewardInput.value) || 2000;

        // Update existing players with new initial money
        players.forEach(p => p.balance = gameState.initialMoney);

        stopNFCScan();
        renderPlayers();
        showSection('game');
    };

    const endGame = () => {
        showDialog(
            "Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒØŸ",
            "Ø¢ÛŒØ§ Ø§Ø² Ù¾Ø§ÛŒØ§Ù† Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ Ùˆ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ",
            () => {
                players = [];
                gameState.nextPlayerColorIndex = 1;
                document.getElementById('scannedPlayersList').innerHTML = '';
                document.getElementById('startMoney').value = formatMoney(15000);
                document.getElementById('turnReward').value = formatMoney(2000);
                updateStartButtonState();
                showSection('start');
                startNFCScan('addPlayer');
            },
            true // Show cancel button
        );
    };

    // ---- Transaction Logic ----
    const executeTransfer = () => {
        const { from, to } = gameState.transfer;
        const amount = parseFormattedNumber(document.getElementById('transferAmount').value);

        if (!from || !to || amount <= 0) {
            showDialog("Ø®Ø·Ø§", "Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
            return;
        }
        if (from.balance < amount) {
            showDialog("Ø®Ø·Ø§", `Ù…ÙˆØ¬ÙˆØ¯ÛŒ "${from.name}" Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø§Ù†ØªÙ‚Ø§Ù„ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª.`);
            return;
        }

        hidePopup('transferPopup');
        showTransferAnimation(from, to, amount, () => {
            updateBalance(from.id, -amount, true); // delayed update
            updateBalance(to.id, +amount, true); // delayed update
        });
    };

    const executeReward = () => {
        const { player } = gameState.reward;
        const amount = gameState.turnReward;

        if (!player) return;

        hidePopup('rewardPopup');
        showRewardAnimation(player, amount, () => {
            updateBalance(player.id, +amount, true);
        });
    };

    const executeBankTx = () => {
        const { player, type } = gameState.bankTx;
        const amount = parseFormattedNumber(document.getElementById('bankTxAmount').value);

        if (!player || amount <= 0) {
             showDialog("Ø®Ø·Ø§", "Ù„Ø·ÙØ§Ù‹ Ø¨Ø§Ø²ÛŒÚ©Ù† Ùˆ Ù…Ø¨Ù„Øº Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
            return;
        }

        if (type === 'pay' && player.balance < amount) {
            showDialog("Ø®Ø·Ø§", `Ù…ÙˆØ¬ÙˆØ¯ÛŒ "${player.name}" Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ÛŒÙ† Ù…Ø¨Ù„Øº Ø¨Ù‡ Ø¨Ø§Ù†Ú© Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª.`);
            return;
        }

        hidePopup('bankTxPopup');
        
        const change = type === 'receive' ? +amount : -amount;
        showBankTxAnimation(player, amount, type, () => {
             updateBalance(player.id, change, true);
        });
    };


    // ---- Animations ----
    const showTransferAnimation = (from, to, amount, onComplete) => {
        const fadeFrom = document.getElementById('fadeFromCircle');
        const fadeTo = document.getElementById('fadeToCircle');
        document.getElementById('fadeAmount').textContent = formatMoney(amount);

        fadeFrom.className = `circle color-${from.colorClass.split('-')[2]}`;
        fadeFrom.innerHTML = `<span>${from.name}</span>`;
        fadeTo.className = `circle color-${to.colorClass.split('-')[2]}`;
        fadeTo.innerHTML = `<span>${to.name}</span>`;

        fades.transfer.classList.add('active');

        // Animation sequence
        setTimeout(() => { fadeFrom.classList.add('fade-entity-anim'); }, 100);
        setTimeout(() => { document.getElementById('fadeAmount').style.opacity = '1'; }, 300);
        setTimeout(() => { fadeTo.classList.add('fade-entity-anim', 'fade-receiver-anim'); }, 500);

        setTimeout(() => {
            fades.transfer.classList.remove('active');
            onComplete();
        }, 2800);
    };
    
    const showRewardAnimation = (player, amount, onComplete) => {
        const playerCircle = fades.reward.querySelector('.circle');
        
        playerCircle.className = `circle color-${player.colorClass.split('-')[2]}`;
        playerCircle.innerHTML = `<span>${player.name}</span>`;
        
        fades.reward.querySelector('.bank-entity').innerHTML = `<div class="bank-text-label">ğŸ ${formatMoney(amount)}</div>`;

        fades.reward.classList.add('active');

        // Animation sequence
        setTimeout(() => { fades.reward.querySelector('.bank-entity').classList.add('fade-entity-anim'); }, 100);
        setTimeout(() => { playerCircle.classList.add('fade-entity-anim', 'fade-receiver-anim'); }, 500);

        setTimeout(() => {
            fades.reward.classList.remove('active');
            onComplete();
        }, 2800);
    };

    const showBankTxAnimation = (player, amount, type, onComplete) => {
        const giverEl = document.getElementById('fadeBankTxGiver');
        const receiverEl = document.getElementById('fadeBankTxReceiver');
        const amountEl = document.getElementById('fadeBankTxAmount');

        giverEl.innerHTML = '';
        receiverEl.innerHTML = '';
        amountEl.textContent = formatMoney(amount);
        
        const playerCircleHTML = `<div class="circle color-${player.colorClass.split('-')[2]}"><span>${player.name}</span></div>`;
        const bankBoxHTML = `<div class="bank-entity"><div class="bank-text-label">Ø¨Ø§Ù†Ú©</div></div>`;

        if (type === 'receive') {
            giverEl.innerHTML = bankBoxHTML;
            receiverEl.innerHTML = playerCircleHTML;
            amountEl.style.color = 'var(--success)';
        } else { // pay
            giverEl.innerHTML = playerCircleHTML;
            receiverEl.innerHTML = bankBoxHTML;
            amountEl.style.color = 'var(--danger)';
        }

        fades.bankTx.classList.add('active');
        
        // Animation sequence
        setTimeout(() => { giverEl.classList.add('fade-entity-anim'); }, 100);
        setTimeout(() => { amountEl.style.opacity = '1'; }, 300);
        setTimeout(() => { receiverEl.classList.add('fade-entity-anim', 'fade-receiver-anim'); }, 500);

        setTimeout(() => {
            fades.bankTx.classList.remove('active');
            giverEl.classList.remove('fade-entity-anim');
            receiverEl.classList.remove('fade-entity-anim', 'fade-receiver-anim');
            amountEl.style.opacity = '0';
            onComplete();
        }, 2800);
    };
    
    // ---- Popup Setup & Validation ----
    const setupPopups = () => {
        // Transfer Popup
        document.getElementById('transferBtn').addEventListener('click', () => {
            gameState.transfer = { from: null, to: null, amount: 0 };
            updateCircle('fromCircle', null);
            updateCircle('toCircle', null);
            document.getElementById('transferAmount').value = '';
            document.getElementById('fromCircle').classList.add('pulsing');
            startNFCScan('from');
            showPopup('transferPopup');
            validatePopupForms();
        });
        document.getElementById('fromCircle').addEventListener('click', () => {
            stopNFCScan();
            document.querySelectorAll('.pulsing').forEach(el => el.classList.remove('pulsing'));
            document.getElementById('fromCircle').classList.add('pulsing');
            startNFCScan('from');
        });
        document.getElementById('toCircle').addEventListener('click', () => {
            stopNFCScan();
            document.querySelectorAll('.pulsing').forEach(el => el.classList.remove('pulsing'));
            document.getElementById('toCircle').classList.add('pulsing');
            startNFCScan('to');
        });
        document.getElementById('confirmTransfer').addEventListener('click', executeTransfer);

        // Reward Popup
        document.getElementById('rewardBtn').addEventListener('click', () => {
            gameState.reward = { player: null, amount: gameState.turnReward };
            document.getElementById('rewardTitle').textContent = `ğŸ Ù¾Ø§Ø¯Ø§Ø´ Ø¯ÙˆØ± (${formatMoney(gameState.turnReward)})`;
            updateCircle('rewardCircle', null);
            document.getElementById('rewardCircle').classList.add('pulsing');
            startNFCScan('reward');
            showPopup('rewardPopup');
            validatePopupForms();
        });
        document.getElementById('rewardCircle').addEventListener('click', () => {
             stopNFCScan();
             document.getElementById('rewardCircle').classList.add('pulsing');
             startNFCScan('reward');
        });
        document.getElementById('confirmReward').addEventListener('click', executeReward);

        // Bank TX Popup
        document.getElementById('bankTxBtn').addEventListener('click', () => {
            gameState.bankTx = { player: null, amount: 0, type: 'receive' };
            updateCircle('bankTxCircle', null);
            document.getElementById('bankTxAmount').value = '';
            document.getElementById('bankTxCircle').classList.add('pulsing');
            document.getElementById('bankTxTypeReceive').classList.add('btn-primary');
            document.getElementById('bankTxTypeReceive').classList.remove('btn-secondary');
            document.getElementById('bankTxTypePay').classList.add('btn-secondary');
            document.getElementById('bankTxTypePay').classList.remove('btn-primary');
            startNFCScan('bankTx');
            showPopup('bankTxPopup');
            validatePopupForms();
        });
        document.getElementById('bankTxCircle').addEventListener('click', () => {
            stopNFCScan();
            document.getElementById('bankTxCircle').classList.add('pulsing');
            startNFCScan('bankTx');
        });
        document.getElementById('bankTxTypeReceive').addEventListener('click', () => {
            gameState.bankTx.type = 'receive';
            document.getElementById('bankTxTypeReceive').classList.replace('btn-secondary', 'btn-primary');
            document.getElementById('bankTxTypePay').classList.replace('btn-primary', 'btn-secondary');
        });
        document.getElementById('bankTxTypePay').addEventListener('click', () => {
            gameState.bankTx.type = 'pay';
            document.getElementById('bankTxTypePay').classList.replace('btn-secondary', 'btn-primary');
            document.getElementById('bankTxTypeReceive').classList.replace('btn-primary', 'btn-secondary');
        });
        document.getElementById('confirmBankTx').addEventListener('click', executeBankTx);
        
        // Add Player Popup
        document.getElementById('confirmAddPlayer').addEventListener('click', () => {
            const id = document.getElementById('newPlayerId').textContent;
            const name = document.getElementById('newPlayerName').value.trim();
            if (name) {
                addPlayer(id, name);
                renderScannedPlayers();
                hidePopup('addPlayerPopup');
                startNFCScan('addPlayer'); // Ready for next scan
            } else {
                showDialog("Ø®Ø·Ø§", "Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
            }
        });

        // Close popups when clicking outside the box
        Object.values(popups).forEach(p => {
            p.addEventListener('click', (e) => {
                if(e.target === p) {
                    hidePopup(p.id);
                    stopNFCScan();
                }
            });
        });

        // Listen for input changes to validate forms
        document.getElementById('transferAmount').addEventListener('input', validatePopupForms);
        document.getElementById('bankTxAmount').addEventListener('input', validatePopupForms);
    };

    const validatePopupForms = () => {
        // Transfer
        const transferAmount = parseFormattedNumber(document.getElementById('transferAmount').value);
        document.getElementById('confirmTransfer').disabled = !(gameState.transfer.from && gameState.transfer.to && transferAmount > 0);
        // Reward
        document.getElementById('confirmReward').disabled = !gameState.reward.player;
        // Bank TX
        const bankTxAmount = parseFormattedNumber(document.getElementById('bankTxAmount').value);
        document.getElementById('confirmBankTx').disabled = !(gameState.bankTx.player && bankTxAmount > 0);
    };

    // ---- Event Listeners ----
    document.getElementById('startGameBtn').addEventListener('click', startGame);
    document.getElementById('endGame').addEventListener('click', endGame);
    
    document.querySelector('.scan-prompt').addEventListener('click', () => startNFCScan('addPlayer'));

    document.getElementById('fullscreenBtn').addEventListener('click', () => {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
            });
        } else {
            document.exitFullscreen();
        }
    });

    // ---- Initialization ----
    const init = () => {
        // Set default text for circles
        document.getElementById('fromCircle').dataset.defaultText = 'Ú©Ø§Ø±Øª Ø¨Ú©Ø´ÛŒØ¯';
        document.getElementById('toCircle').dataset.defaultText = 'Ú©Ø§Ø±Øª Ø¨Ú©Ø´ÛŒØ¯';
        document.getElementById('rewardCircle').dataset.defaultText = 'Ú©Ø§Ø±Øª Ø¨Ú©Ø´ÛŒØ¯';
        document.getElementById('bankTxCircle').dataset.defaultText = 'Ú©Ø§Ø±Øª Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ Ø¨Ú©Ø´ÛŒØ¯';
        
        // Set initial values
        document.getElementById('startMoney').value = formatMoney(gameState.initialMoney);
        document.getElementById('turnReward').value = formatMoney(gameState.turnReward);

        setupPopups();
        showSection('start');
        startNFCScan('addPlayer');
        updateStartButtonState();
    };

    init();
});
</script>

</body>
</html>
