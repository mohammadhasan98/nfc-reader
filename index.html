<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>بانک مونوپولی</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
/* ──────────────────────── ریشه و فونت ──────────────────────── */
:root {
  --bg-dark: #0A0E1A;
  --bg-card: #111827;
  --bg-card-hover: #1e293b;
  --primary: #00D4FF;
  --primary-hover: #00eaff;
  --accent: #7C3AED;
  --accent-hover: #9f67ff;
  --danger: #FF3B5C;
  --danger-hover: #ff5c78;
  --success: #10B981;
  --success-hover: #34d399;
  --text: #F1F5F9;
  --text-muted: #94A3B8;
  --border: #1E293B;
  --shadow-sm: 0 4px 12px rgba(0,0,0,0.25);
  --shadow-lg: 0 12px 30px rgba(0,0,0,0.35);
  --radius-sm: 12px;
  --radius-md: 20px;
  --radius-lg: 28px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-family: 'Vazirmatn', sans-serif;
}

/* ──────────────────────── پایه ──────────────────────── */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  margin:0; padding:0; background: var(--bg-dark); color: var(--text);
  min-height: 100vh; overflow-x:hidden; user-select:none; -webkit-user-select:none;
  font-size:16px; line-height:1.5;
}
section { 
  position:absolute; inset:0; padding:20px; 
  opacity:0; pointer-events:none; transform:translateX(30px);
  transition: opacity .6s ease, transform .6s ease;
}
section.active { opacity:1; pointer-events:auto; transform:translateX(0); }

h1,h2,h3 { text-align:center; margin:0 0 20px; font-weight:900; }
h1 { 
  font-size:2.8rem; background:linear-gradient(135deg,var(--primary),var(--accent));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  text-shadow:0 0 30px rgba(0,212,255,0.15);
}
h2 { font-size:1.9rem; color:var(--text); }

/* ──────────────────────── دکمه‌ها ──────────────────────── */
button {
  font-family:inherit; border:none; border-radius:var(--radius-lg);
  padding:14px 32px; font-size:17px; font-weight:600;
  margin:8px auto; display:block; cursor:pointer;
  transition:var(--transition); min-width:190px;
  box-shadow:var(--shadow-sm); position:relative; overflow:hidden;
}
button::before{
  content:''; position:absolute; inset:0; background:linear-gradient(135deg,rgba(255,255,255,0.15),transparent);
  opacity:0; transition:var(--transition);
}
button:hover::before{ opacity:1; }
button:active{ transform:scale(0.97); }

.btn-primary{ background:var(--primary); color:#fff; }
.btn-primary:hover{ background:var(--primary-hover); transform:translateY(-3px); box-shadow:var(--shadow-lg); }
.btn-secondary{ background:var(--bg-card); color:var(--text); border:1px solid var(--border); }
.btn-secondary:hover{ background:var(--bg-card-hover); }
.btn-danger{ background:var(--danger); color:#fff; }
.btn-danger:hover{ background:var(--danger-hover); }

.floating-btn{
  position:fixed; top:16px; left:16px; width:56px; height:56px; border-radius:50%;
  background:var(--bg-card); color:var(--text); display:flex; justify-content:center; align-items:center;
  z-index:1000; box-shadow:var(--shadow-lg); padding:0; min-width:unset;
}
.floating-btn svg{ width:26px; height:26px; }

/* ──────────────────────── فرم‌ها ──────────────────────── */
input, select{
  font-family:inherit; width:90%; max-width:340px; margin:12px auto; display:block;
  padding:14px 20px; font-size:17px; text-align:center; border-radius:var(--radius-md);
  border:1px solid var(--border); background:var(--bg-card); color:var(--text);
  transition:var(--transition);
}
input:focus, select:focus{
  outline:none; border-color:var(--primary); box-shadow:0 0 0 4px rgba(0,212,255,0.2);
}
label{ text-align:center; color:var(--text-muted); margin-top:16px; display:block; }

/* ──────────────────────── صفحه شروع ──────────────────────── */
.scan-prompt{
  text-align:center; font-size:19px; color:var(--primary);
  padding:18px; border:2px solid var(--primary); border-radius:var(--radius-md);
  margin:30px auto; max-width:360px; animation:pulse-border 2.5s infinite ease-in-out;
}
@keyframes pulse-border{
  0%,100%{ box-shadow:0 0 0 0 rgba(0,212,255,0.6); }
  70%{ box-shadow:0 0 0 12px rgba(0,212,255,0); }
}
#startGameBtn{
  padding:18px 48px; font-size:19px; font-weight:700; border-radius:32px;
  margin-top:35px; background:linear-gradient(135deg,var(--primary),var(--accent));
}
#startGameBtn:disabled{ background:#334155; cursor:not-allowed; transform:none; }

/* کارت‌های اسکن شده */
#scannedPlayersList{
  margin-top:28px; display:grid; grid-template-columns:repeat(auto-fill,minmax(145px,1fr));
  gap:16px; padding:0 8px;
}
.scanned-player-item{
  background:var(--bg-card); border-radius:var(--radius-md); padding:14px 8px;
  text-align:center; box-shadow:var(--shadow-sm); transition:var(--transition);
  border-top:6px solid transparent; min-height:92px; display:flex; flex-direction:column;
  justify-content:center; gap:6px;
}
.scanned-player-item:hover{ transform:translateY(-4px); box-shadow:var(--shadow-lg); }
.scanned-player-item .name{ font-weight:700; font-size:17px; color:var(--text); }
.scanned-player-item .id-tag{
  font-size:13px; color:var(--text-muted); background:var(--bg-dark);
  padding:3px 10px; border-radius:10px; display:inline-block;
}

/* رنگ‌های بازیکن */
.scanned-player-item.color-1{ border-top-color:#FF6B6B; }
.scanned-player-item.color-2{ border-top-color:#4ECDC4; }
.scanned-player-item.color-3{ border-top-color:#45B7D1; }
.scanned-player-item.color-4{ border-top-color:#F7D154; }
.scanned-player-item.color-5{ border-top-color:#9A77D1; }
.scanned-player-item.color-6{ border-top-color:#50C878; }
.scanned-player-item.color-7{ border-top-color:#FF9F1C; }
.scanned-player-item.color-8{ border-top-color:#F5558D; }

/* ──────────────────────── صفحه بازی ──────────────────────── */
#playerList{
  display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
  gap:20px; margin-top:25px;
}
.player-card{
  background:var(--bg-card); border-radius:var(--radius-lg); overflow:hidden;
  box-shadow:var(--shadow-lg); transition:var(--transition); position:relative;
  animation:slideInCard .6s ease-out forwards; opacity:0;
}
@keyframes slideInCard{
  from{ opacity:0; transform:translateY(30px) scale(0.95); }
  to{ opacity:1; transform:translateY(0) scale(1); }
}
.player-card:hover{ transform:translateY(-6px); box-shadow:0 20px 40px rgba(0,0,0,0.4); }

.player-card-header{
  padding:14px 18px; display:flex; align-items:center; justify-content:space-between;
  font-weight:700; color:#fff; position:relative;
}
.player-card-header::after{
  content:''; position:absolute; bottom:0; left:0; right:0; height:1px;
  background:linear-gradient(90deg,transparent,var(--border),transparent);
}
.player-name{ font-size:18px; }
.player-id-tag{
  font-size:19px; font-weight:800; background:rgba(0,0,0,0.3);
  padding:4px 12px; border-radius:12px;
}

.player-card-body{ padding:18px; text-align:center; }
.player-card-body label{ font-size:15px; color:var(--text-muted); margin-bottom:8px; }
.player-balance{
  font-size:28px; font-weight:800; direction:ltr; color:var(--text);
  transition:color .4s ease, transform .4s ease;
}

/* ورشکستگی */
.player-card.bankrupt{
  opacity:0.6; filter:grayscale(1); background:#1a1a1a;
}
.player-card.bankrupt::after{
  content:"ورشکسته"; position:absolute; inset:0; display:flex;
  align-items:center; justify-content:center; font-size:24px; font-weight:900;
  color:var(--danger); background:rgba(0,0,0,0.7); border:4px solid var(--danger);
  border-radius:var(--radius-lg); animation:stamp-animation .7s ease forwards;
  animation-delay:.2s; opacity:0;
}
@keyframes stamp-animation{
  0%{ opacity:0; transform:rotate(-20deg) scale(2); }
  60%{ opacity:0.9; transform:rotate(-20deg) scale(0.9); }
  100%{ opacity:0.9; transform:rotate(-20deg) scale(1); }
}

/* انیمیشن موجودی */
@keyframes balance-up-anim{ 0%{color:var(--success);transform:scale(1.2);} 100%{color:var(--text);transform:scale(1);} }
@keyframes balance-down-anim{ 0%{color:var(--danger);transform:scale(1.2);} 100%{color:var(--text);transform:scale(1);} }
.balance-up{ animation:balance-up-anim 1.2s ease; }
.balance-down{ animation:balance-down-anim 1.2s ease; }

/* ──────────────────────── پاپ‌آپ‌ها ──────────────────────── */
.popup{
  position:fixed; inset:0; background:rgba(10,14,26,0.85); backdrop-filter:blur(12px);
  display:none; justify-content:center; align-items:center; z-index:999;
}
.popup.active{ display:flex; }
.popup-box{
  background:var(--bg-card); border-radius:var(--radius-lg); padding:30px;
  width:92%; max-width:420px; text-align:center; box-shadow:var(--shadow-lg);
  border:1px solid var(--border); animation:popupFadeIn .4s cubic-bezier(0.175,0.885,0.32,1.275);
}
@keyframes popupFadeIn{ from{opacity:0;transform:scale(0.88);} to{opacity:1;transform:scale(1);} }

.popup-box .button-group{
  display:flex; justify-content:center; gap:12px; margin-top:24px; flex-wrap:wrap;
}
.popup-box .button-group button{ min-width:130px; }

/* کیبورد عددی */
.keyboard{
  display:grid; grid-template-columns:repeat(3,1fr); gap:12px;
  margin:24px 0; padding:0 12px;
}
.keyboard button{
  border-radius:var(--radius-md); padding:16px; font-size:22px; background:var(--bg-dark);
  color:var(--text); box-shadow:none; font-weight:600;
}
.keyboard button:hover{ background:var(--primary); transform:none; }
.keyboard button:active{ transform:scale(0.94); background:var(--primary-hover); }

/* دایره‌ها */
.circle{
  width:110px; height:110px; border-radius:50%; margin:22px auto;
  border:3px solid var(--primary); color:var(--text); font-size:19px;
  display:flex; justify-content:center; align-items:center; text-align:center;
  padding:8px; transition:var(--transition); overflow:hidden; word-break:break-word;
}
.circle.filled{ background:var(--primary); color:#fff; border-color:var(--primary); }
.name-animating{ animation:circleNameFadeIn .5s ease; }
@keyframes circleNameFadeIn{ from{opacity:0;transform:scale(0.7);} to{opacity:1;transform:scale(1);} }

/* انیمیشن انتقال */
.fade{
  position:fixed; inset:0; background:rgba(10,14,26,0.92); backdrop-filter:blur(16px);
  display:none; justify-content:center; align-items:center; flex-direction:column;
  z-index:9999; font-size:22px; color:#fff;
}
.fade.active{ display:flex; }
#transferInfo{ display:flex; align-items:center; gap:24px; position:relative; }
#transferInfo .circle{ opacity:0; transform:scale(0.7); }
#transferInfo .arrow{
  width:70px; height:70px; border-top:6px solid #fff; border-left:6px solid #fff;
  transform:rotate(-135deg); opacity:0;
}
#fadeAmount{
  position:absolute; top:-50px; left:50%; transform:translateX(-50%);
  font-size:26px; font-weight:900; opacity:0; transition:opacity .6s ease .4s;
}
.fade-giver-anim{ animation:pulse .9s ease forwards; animation-delay:.1s; opacity:1 !important; }
.fade-arrow-anim{ animation:arrowAnimRTL 1.2s ease forwards; animation-delay:.6s; opacity:1; }
.fade-receiver-anim{ animation:pulse .9s ease forwards; animation-delay:1.6s; opacity:1 !important; }
@keyframes pulse{ 0%{transform:scale(1);} 50%{transform:scale(1.2);} 100%{transform:scale(1);} }
@keyframes arrowAnimRTL{
  from{ transform:translateX(100px) rotate(-135deg); opacity:0; }
  to{ transform:translateX(-100px) rotate(-135deg); opacity:1; }
}

/* پاداش */
.reward-arrow{
  width:60px; height:60px; border-bottom:6px solid #fff; border-left:6px solid #fff;
  margin:18px auto; transform:rotate(-45deg);
  animation:rewardArrowAnim 1.4s ease-in-out infinite;
}
@keyframes rewardArrowAnim{
  0%{ transform:translateY(-30px) rotate(-45deg); opacity:0; }
  50%{ opacity:1; }
  100%{ transform:translateY(30px) rotate(-45deg); opacity:0; }
}

/* رنگ هدر کارت‌ها */
.player-card.color-1 .player-card-header{ background:#FF6B6B; }
.player-card.color-2 .player-card-header{ background:#4ECDC4; }
.player-card.color-3 .player-card-header{ background:#45B7D1; }
.player-card.color-4 .player-card-header{ background:#F7D154; }
.player-card.color-5 .player-card-header{ background:#9A77D1; }
.player-card.color-6 .player-card-header{ background:#50C878; }
.player-card.color-7 .player-card-header{ background:#FF9F1C; }
.player-card.color-8 .player-card-header{ background:#F5558D; }

/* افکت‌های ویژه */
.glow-primary{ box-shadow:0 0 20px rgba(0,212,255,0.4); }
.glow-accent{ box-shadow:0 0 20px rgba(124,58,237,0.4); }

</style>
</head>
<body>

<!-- دکمه تمام صفحه -->
<button id="fullscreenBtn" class="floating-btn">
  <i class="fas fa-expand"></i>
</button>

<!-- صفحه شروع -->
<section id="start" class="active">
  <h1>🏦 بانک مونوپولی</h1>
  <p class="scan-prompt">لطفا کارت هر بازیکن را اسکن کنید</p>
  <div id="scannedPlayersList"></div>
  <label for="startMoney">موجودی اولیه:</label>
  <input type="text" inputmode="numeric" id="startMoney" placeholder="مثلاً ۱۵,۰۰۰">
  <label for="turnReward">پاداش دور کامل:</label>
  <input type="text" inputmode="numeric" id="turnReward" placeholder="مثلاً ۲,۰۰۰">
  <button id="startGameBtn" class="btn-primary" disabled>شروع بازی</button>
</section>

<!-- صفحه بازی -->
<section id="game">
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:32px;">
    <button id="transferBtn" class="btn-primary glow-primary"><i class="fas fa-exchange-alt"></i> کارت به کارت</button>
    <button id="rewardBtn" class="btn-primary glow-accent"><i class="fas fa-gift"></i> پاداش دور</button>
    <button class="btn-secondary" disabled><i class="fas fa-university"></i> پرداخت/دریافت</button>
    <button class="btn-secondary" disabled><i class="fas fa-home"></i> رهن ملک</button>
  </div>
  <div id="playerList"></div>
  <button id="endGame" class="btn-danger" style="margin-top:36px;"><i class="fas fa-redo"></i> اتمام و شروع مجدد</button>
</section>

<!-- پاپ‌آپ انتقال -->
<div id="transferPopup" class="popup">
  <div class="popup-box">
    <h3><i class="fas fa-credit-card"></i> کارت به کارت</h3>
    <input type="text" id="amountInput" readonly placeholder="مبلغ">
    <div class="keyboard" id="numPad"></div>
    <div style="display:flex; justify-content:space-around; align-items:center; margin-top:12px;">
      <div class="circle" id="giverCircle">دهنده</div>
      <p style="font-size:34px; margin:0 12px; color:var(--primary);">←</p>
      <div class="circle" id="receiverCircle">گیرنده</div>
    </div>
    <div class="button-group">
      <button id="transferConfirm" class="btn-primary"><i class="fas fa-check"></i> انتقال</button>
      <button id="transferCancel" class="btn-secondary"><i class="fas fa-times"></i> انصراف</button>
    </div>
  </div>
</div>

<!-- پاپ‌آپ پاداش -->
<div id="rewardPopup" class="popup">
  <div class="popup-box">
    <h3><i class="fas fa-trophy"></i> دریافت پاداش دور</h3>
    <div id="rewardAmount" style="font-size:23px; margin:22px; color:var(--success);"></div>
    <div class="circle" id="rewardCircle">بازیکن</div>
    <div class="button-group">
      <button id="rewardConfirm" class="btn-primary"><i class="fas fa-check"></i> تایید</button>
      <button id="rewardCancel" class="btn-secondary"><i class="fas fa-times"></i> انصراف</button>
    </div>
  </div>
</div>

<!-- پاپ‌آپ عمومی -->
<div id="dialogPopup" class="popup">
  <div class="popup-box">
    <h3 id="dialogTitle">توجه!</h3>
    <p id="dialogMessage"></p>
    <div class="button-group" id="dialogButtons"></div>
  </div>
</div>

<!-- افزودن بازیکن -->
<div id="addPlayerPopup" class="popup">
  <div class="popup-box">
    <h3><i class="fas fa-user-plus"></i> افزودن بازیکن جدید</h3>
    <p>لطفا نام بازیکن را وارد کنید:</p>
    <input type="text" id="newPlayerNameInput" placeholder="نام بازیکن">
    <div class="button-group">
      <button id="confirmAddPlayer" class="btn-primary"><i class="fas fa-check"></i> تایید</button>
      <button id="cancelAddPlayer" class="btn-secondary"><i class="fas fa-times"></i> انصراف</button>
    </div>
  </div>
</div>

<!-- انیمیشن انتقال -->
<div id="transferFade" class="fade">
  <div id="transferInfo">
    <div id="fadeAmount"></div>
    <div class="circle filled" id="fadeGiver"></div>
    <div class="arrow"></div>
    <div class="circle filled" id="fadeReceiver"></div>
  </div>
</div>

<!-- انیمیشن پاداش -->
<div id="rewardFade" class="fade">
  <div style="text-align:center;">
    <div id="rewardShow" style="font-size:26px; font-weight:900; margin-bottom:12px; color:var(--success);"></div>
    <div class="reward-arrow"></div>
    <div class="circle filled" id="rewardTo"></div>
  </div>
</div>

<script>
// === تمام کد جاوااسکریپت قبلی بدون تغییر (فقط ظاهر بهبود یافت) ===
document.addEventListener('contextmenu', e => e.preventDefault());

const sections = { start: document.getElementById('start'), game: document.getElementById('game') };
const popups = { 
    transfer: document.getElementById('transferPopup'), 
    reward: document.getElementById('rewardPopup'), 
    dialog: document.getElementById('dialogPopup'),
    addPlayer: document.getElementById('addPlayerPopup')
};
let ndefReader, nfcAbortController = null;

const startMoney = document.getElementById('startMoney');
const turnReward = document.getElementById('turnReward');
const startGameBtn = document.getElementById('startGameBtn');
const NUM_PLAYER_COLORS = 8;

let tempPlayers = [];

const dialogTitle = document.getElementById('dialogTitle'), dialogMessage = document.getElementById('dialogMessage'), dialogButtons = document.getElementById('dialogButtons');
function customAlert(message, title = "توجه") {
    dialogTitle.textContent = title;
    dialogMessage.textContent = message;
    dialogButtons.innerHTML = `<button id="dialogOk" class="btn-primary">باشه</button>`;
    popups.dialog.classList.add('active');
    return new Promise(resolve => {
        document.getElementById('dialogOk').onclick = () => { popups.dialog.classList.remove('active'); resolve(); };
    });
}
function customConfirm(message, title = "تاییدیه") {
    dialogTitle.textContent = title;
    dialogMessage.textContent = message;
    dialogButtons.innerHTML = `<button id="dialogConfirm" class="btn-primary">بله</button><button id="dialogCancel" class="btn-secondary">خیر</button>`;
    popups.dialog.classList.add('active');
    return new Promise(resolve => {
        document.getElementById('dialogConfirm').onclick = () => { popups.dialog.classList.remove('active'); resolve(true); };
        document.getElementById('dialogCancel').onclick = () => { popups.dialog.classList.remove('active'); resolve(false); };
    });
}

function showSection(id) {
    Object.values(sections).forEach(s => s.classList.remove('active'));
    sections[id].classList.add('active');
}

function toEnglishDigits(str) {
  if (typeof str !== 'string') return str;
  const persianArabicMap = { '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4', '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9', '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4', '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9' };
  return str.replace(/[۰-۹٠-٩]/g, c => persianArabicMap[c]);
}

// --- مرحله ۱: تنظیمات و افزودن بازیکنان ---
function handleInitialScan(scannedId) {
    if (tempPlayers.some(p => p.id === scannedId)) {
        customAlert("این کارت قبلا برای بازیکن دیگری ثبت شده است.");
        return;
    }
    
    const newPlayerNameInput = document.getElementById('newPlayerNameInput');
    newPlayerNameInput.value = '';
    popups.addPlayer.classList.add('active');
    
    document.getElementById('confirmAddPlayer').onclick = () => {
        const name = newPlayerNameInput.value.trim();
        if (!name) {
            customAlert("لطفا نام بازیکن را وارد کنید.");
            return;
        }
        tempPlayers.push({ id: scannedId, name: name });
        updateScannedPlayersList();
        popups.addPlayer.classList.remove('active');
    };
    
    document.getElementById('cancelAddPlayer').onclick = () => {
        popups.addPlayer.classList.remove('active');
    };
}

// --- تغییرات آیتم 4: منطق جدید ساخت کارت بازیکنان اسکن شده ---
function updateScannedPlayersList() {
    const listEl = document.getElementById('scannedPlayersList');
    listEl.innerHTML = '';
    tempPlayers.forEach((player, index) => {
        const item = document.createElement('div');
        item.className = 'scanned-player-item';
        item.classList.add(`color-${(index % NUM_PLAYER_COLORS) + 1}`);
        item.innerHTML = `
            <span class="name">${player.name}</span>
            <span class="id-tag">کارت: ${player.id}</span>
        `;
        listEl.appendChild(item);
    });
    
    startGameBtn.disabled = tempPlayers.length < 2;
}

startGameBtn.onclick = () => {
    const startMoneyVal = parseInt(toEnglishDigits(startMoney.value).replace(/,/g, ''));
    const rewardVal = parseInt(toEnglishDigits(turnReward.value).replace(/,/g, ''));
    if (isNaN(startMoneyVal) || startMoneyVal <= 0 || isNaN(rewardVal) || rewardVal <= 0) {
        customAlert("مقادیر پولی را به درستی و بزرگتر از صفر وارد کنید.");
        return;
    }
    
    const finalPlayers = tempPlayers.map(p => ({
        ...p,
        balance: startMoneyVal,
        bankrupt: false
    }));

    localStorage.setItem('players', JSON.stringify(finalPlayers));
    localStorage.setItem('startMoney', startMoneyVal);
    localStorage.setItem('turnReward', rewardVal);

    stopNFCScan();
    renderPlayerList();
    showSection('game');
};


// --- مرحله ۳: صفحه بازی ---
function renderPlayerList() {
    const container = document.getElementById('playerList');
    container.innerHTML = '';
    JSON.parse(localStorage.getItem('players')).forEach((p, index) => {
        const card = document.createElement('div');
        card.className = 'player-card';
        card.classList.add(`color-${(index % NUM_PLAYER_COLORS) + 1}`);

        card.dataset.playerId = p.id;
        card.style.animationDelay = `${index * 100}ms`;
        if (p.bankrupt) card.classList.add('bankrupt');

        card.innerHTML = `
            <div class="player-card-header">
                <span class="player-name">${p.name}</span>
                <span class="player-id-tag">${p.id}</span>
            </div>
            <div class="player-card-body">
                <label>موجودی</label>
                <div class="player-balance" data-balance-id="${p.id}">${p.balance.toLocaleString('fa-IR')}</div>
            </div>
        `;
        
        card.addEventListener('contextmenu', async e => {
            e.preventDefault();
            if (p.bankrupt) return; 
            if (await customConfirm(`آیا از ورشکستگی بازیکن «${p.name}» مطمئن هستید؟`)) {
                let players = JSON.parse(localStorage.getItem('players'));
                const target = players.find(pl => pl.id === p.id);
                if (target) {
                    target.bankrupt = true;
                    localStorage.setItem('players', JSON.stringify(players));
                    updatePlayerDisplays(players);
                }
            }
        });
        container.appendChild(card);
    });
}

function updatePlayerDisplays(newPlayers, oldPlayers) {
    newPlayers.forEach(p => {
        const card = document.querySelector(`.player-card[data-player-id="${p.id}"]`);
        if (!card) return;
        const balanceEl = card.querySelector(`.player-balance[data-balance-id="${p.id}"]`);
        if (p.bankrupt) card.classList.add('bankrupt'); else card.classList.remove('bankrupt');
        
        const oldPlayer = oldPlayers?.find(op => op.id === p.id);
        if (oldPlayer && p.balance !== oldPlayer.balance) {
            balanceEl.textContent = p.balance.toLocaleString('fa-IR');
            const animClass = p.balance > oldPlayer.balance ? 'balance-up' : 'balance-down';
            balanceEl.classList.remove('balance-up', 'balance-down');
            void balanceEl.offsetWidth;
            balanceEl.classList.add(animClass);
        } else {
            balanceEl.textContent = p.balance.toLocaleString('fa-IR');
        }
    });
}


// --- منطق NFC ---
async function startNFCScan(onRead) {
    if (!('NDEFReader' in window)) {
        customAlert("مرورگر شما از Web NFC پشتیبانی نمی‌کند. از گوگل کروم در اندروید استفاده کنید.", "خطای NFC");
        return;
    }
    try {
        if (!ndefReader) ndefReader = new NDEFReader();
        nfcAbortController = new AbortController();
        await ndefReader.scan({ signal: nfcAbortController.signal });
        ndefReader.onreading = event => {
            const decoder = new TextDecoder();
            const idString = decoder.decode(event.message.records[0].data).split('\n')[0];
            const id = parseInt(idString);
            if (isNaN(id)) return;
            
            if (sections.game.classList.contains('active')) {
                const player = JSON.parse(localStorage.getItem('players')).find(p => p.id === id);
                if (player && !player.bankrupt) onRead(player);
            } else if (sections.start.classList.contains('active')) {
                onRead(id);
            }
        };
    } catch (error) {
        customAlert(`خطا در فعالسازی NFC: ${error.message}.`, "خطای NFC");
    }
}
function stopNFCScan() { if (nfcAbortController) { nfcAbortController.abort(); nfcAbortController = null; } }

// --- کارت به کارت ---
const numPad = document.getElementById('numPad'), amountInput = document.getElementById('amountInput');
['۱','۲','۳','۴','۵','۶','۷','۸','۹','پاک','۰','⌫'].forEach(key => {
    const btn = document.createElement('button'); btn.textContent = key;
    if (key === '⌫') btn.onclick = () => amountInput.value = amountInput.value.slice(0, -1);
    else if (key === 'پاک') btn.onclick = () => amountInput.value = '';
    else btn.onclick = () => amountInput.value += key;
    numPad.appendChild(btn);
});
let giverTag = null, receiverTag = null;
const giverCircle = document.getElementById('giverCircle'), receiverCircle = document.getElementById('receiverCircle');
function animateCircleName(circle, name) {
    circle.textContent = name;
    circle.classList.add('filled', 'name-animating');
    circle.addEventListener('animationend', () => circle.classList.remove('name-animating'), { once: true });
}
function resetTransferPopup() {
    stopNFCScan();
    giverTag = receiverTag = null;
    giverCircle.textContent = 'دهنده';
    receiverCircle.textContent = 'گیرنده';
    giverCircle.classList.remove('filled');
    receiverCircle.classList.remove('filled');
    amountInput.value = '';
    popups.transfer.classList.remove('active');
}
document.getElementById('transferBtn').onclick = () => {
    popups.transfer.classList.add('active');
    startNFCScan(player => {
        if (!giverTag) { giverTag = player; animateCircleName(giverCircle, player.name); } 
        else if (!receiverTag && player.id !== giverTag.id) { receiverTag = player; animateCircleName(receiverCircle, player.name); stopNFCScan(); }
    });
};
document.getElementById('transferCancel').onclick = resetTransferPopup;

document.getElementById('transferConfirm').onclick = () => {
    const amount = parseInt(toEnglishDigits(amountInput.value));
    if (!giverTag || !receiverTag) { customAlert("کارت دهنده و گیرنده را اسکن کنید."); return; }
    if (isNaN(amount) || amount <= 0) { customAlert("مبلغ انتقال را به درستی وارد کنید."); return; }

    let players = JSON.parse(localStorage.getItem('players'));
    const giver = players.find(p => p.id === giverTag.id);
    const receiver = players.find(p => p.id === receiverTag.id);

    if (giver.balance < amount) { customAlert(`موجودی «${giver.name}» کافی نیست!`); return; }
    
    giver.balance -= amount;
    receiver.balance += amount;
    localStorage.setItem('players', JSON.stringify(players));
    
    showTransferAnimation(giver.name, receiver.name, amount, giver.id, receiver.id, players); 
    
    resetTransferPopup();
};

function showTransferAnimation(giverName, receiverName, amount, giverId, receiverId, newPlayers) {
    const fade = document.getElementById('transferFade');
    const giverEl = document.getElementById('fadeGiver');
    const receiverEl = document.getElementById('fadeReceiver');
    const arrowEl = fade.querySelector('.arrow');
    const amountEl = document.getElementById('fadeAmount');
    
    giverEl.textContent = giverName; 
    receiverEl.textContent = receiverName;
    amountEl.textContent = amount.toLocaleString('fa-IR');
    
    giverEl.className = 'circle filled'; 
    receiverEl.className = 'circle filled'; 
    arrowEl.className = 'arrow';
    amountEl.style.opacity = '0';
    
    fade.classList.add('active');
    
    setTimeout(() => {
        giverEl.classList.add('fade-giver-anim'); 
        arrowEl.classList.add('fade-arrow-anim'); 
        receiverEl.classList.add('fade-receiver-anim');
        amountEl.style.opacity = '1';
    }, 50);

    setTimeout(() => {
        fade.classList.remove('active');
        const giverData = newPlayers.find(p => p.id === giverId);
        const receiverData = newPlayers.find(p => p.id === receiverId);
        if (giverData) {
            const giverBalanceEl = document.querySelector(`.player-balance[data-balance-id="${giverId}"]`);
            giverBalanceEl.textContent = giverData.balance.toLocaleString('fa-IR');
            giverBalanceEl.classList.remove('balance-up-delayed', 'balance-down-delayed');
            void giverBalanceEl.offsetWidth;
            giverBalanceEl.classList.add('balance-down-delayed');
        }
        
        setTimeout(() => {
            if (receiverData) {
                const receiverBalanceEl = document.querySelector(`.player-balance[data-balance-id="${receiverId}"]`);
                receiverBalanceEl.textContent = receiverData.balance.toLocaleString('fa-IR');
                receiverBalanceEl.classList.remove('balance-up-delayed', 'balance-down-delayed');
                void receiverBalanceEl.offsetWidth;
                receiverBalanceEl.classList.add('balance-up-delayed');
            }
        }, 500); 

    }, 2500); 
}

// --- پاداش دور ---
let rewardTag = null;
const rewardCircle = document.getElementById('rewardCircle');
function resetRewardPopup() {
    stopNFCScan(); rewardTag = null;
    rewardCircle.textContent = 'بازیکن'; rewardCircle.classList.remove('filled');
    popups.reward.classList.remove('active');
}
document.getElementById('rewardBtn').onclick = () => {
    const turnReward = parseInt(localStorage.getItem('turnReward'));
    document.getElementById('rewardAmount').textContent = `مبلغ پاداش: ${turnReward.toLocaleString('fa-IR')}`;
    popups.reward.classList.add('active');
    startNFCScan(player => { rewardTag = player; animateCircleName(rewardCircle, player.name); stopNFCScan(); });
};
document.getElementById('rewardCancel').onclick = resetRewardPopup;
document.getElementById('rewardConfirm').onclick = () => {
    if (!rewardTag) { customAlert("کارت بازیکن را اسکن کنید."); return; }
    const rewardAmount = parseInt(localStorage.getItem('turnReward'));
    const oldPlayers = JSON.parse(localStorage.getItem('players'));
    let players = JSON.parse(JSON.stringify(oldPlayers));
    const player = players.find(p => p.id === rewardTag.id);
    player.balance += rewardAmount;
    localStorage.setItem('players', JSON.stringify(players));
    showRewardAnimation(player.name, rewardAmount);
    resetRewardPopup();
    setTimeout(() => updatePlayerDisplays(players, oldPlayers), 100);
};
function showRewardAnimation(name, amount) {
    const fade = document.getElementById('rewardFade');
    document.getElementById('rewardTo').textContent = name;
    document.getElementById('rewardShow').textContent = `+${amount.toLocaleString('fa-IR')}`;
    fade.classList.add('active');
    setTimeout(() => fade.classList.remove('active'), 2000);
}

// --- اتمام بازی ---
document.getElementById('endGame').onclick = async () => {
    if (await customConfirm("آیا برای شروع یک بازی جدید، تمام اطلاعات پاک شود؟", "پایان بازی")) {
        localStorage.clear();
        location.reload();
    }
};

// --- دکمه تمام صفحه ---
document.getElementById('fullscreenBtn').onclick = () => {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
            customAlert(`خطا در ورود به حالت تمام‌صفحه: ${err.message}`);
        });
    } else {
        document.exitFullscreen();
    }
};

// --- اجرای اولیه ---
function init() {
    if (localStorage.getItem('players')) {
        renderPlayerList();
        showSection('game');
    } else {
        showSection('start');
        startNFCScan(handleInitialScan);
    }
}
init();
</script>

</body>
</html>
