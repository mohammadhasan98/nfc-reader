<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¨Ø§Ù†Ú© Ù…ÙˆÙ†ÙˆÙ¾ÙˆÙ„ÛŒ</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-dark: #0D1B2A;    /* Ø³Ø±Ù…Ù‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ */
  --bg-light: #1B263B;   /* Ø³Ø±Ù…Ù‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù† Ø¨Ø±Ø§ÛŒ Ø­Ø¨Ø§Ø¨â€ŒÙ‡Ø§ Ùˆ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ */
  --primary: #3A86FF;     /* Ø¢Ø¨ÛŒ Ø±ÙˆØ´Ù† Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ */
  --primary-hover: #5c9bff;
  --secondary: #415A77; /* Ø®Ø§Ú©Ø³ØªØ±ÛŒ-Ø¢Ø¨ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ±Ø¹ÛŒ */
  --secondary-hover: #527194;
  --text: #E0E1DD;       /* Ø³ÙÛŒØ¯ Ù…Ø§ÛŒÙ„ Ø¨Ù‡ Ú©Ø±Ù… Ø¨Ø±Ø§ÛŒ Ù…ØªÙ† */
  --danger: #ff4b4b;
  --success: #4bff7b;
  font-family: 'Vazirmatn', sans-serif;
}
* { 
  box-sizing: border-box; 
  -webkit-tap-highlight-color: transparent; /* Ø­Ø°Ù Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ù„Ù…Ø³ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
}
body {
  background: var(--bg-dark);
  color: var(--text);
  margin: 0;
  padding: 0;
  user-select: none;
  -webkit-user-select: none;
  font-size: 16px;
  overflow-x: hidden; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„ Ø§ÙÙ‚ÛŒ Ù†Ø§Ø®ÙˆØ§Ø³ØªÙ‡ */
}
section { 
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  padding: 20px;
  opacity: 0;
  pointer-events: none;
  transform: translateX(20px);
  transition: opacity 0.5s ease, transform 0.5s ease;
}
section.active { 
  opacity: 1;
  pointer-events: auto;
  transform: translateX(0);
}
h1, h2, h3 { text-align:center; color: var(--text); font-weight: 700; }
h1 { font-size: 2.2rem; margin-bottom: 25px; text-shadow: 0 0 10px rgba(58, 134, 255, 0.4);}
h2 { margin-bottom: 30px; font-size: 1.8rem;}

/* --- Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ --- */
button {
  border:none;
  border-radius: 25px; /* Ú¯Ø±Ø¯ÛŒ Ø¨ÛŒØ´ØªØ± */
  padding: 12px 28px;
  font-family:'Vazirmatn';
  font-size:16px;
  margin: 10px auto;
  display:block;
  cursor:pointer;
  transition: all .2s ease-in-out;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  min-width: 180px;
}
button:active {
  transform: translateY(1px) scale(0.98);
}
button:disabled {
  background: #778DA9 !important;
  color: #ccc;
  cursor: not-allowed;
  box-shadow: none;
  transform: none !important;
}
.btn-primary {
  background: var(--primary);
  color: #fff;
}
.btn-primary:hover:not(:disabled) { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(58, 134, 255, 0.2);}

.btn-secondary {
  background: var(--secondary);
  color: var(--text);
}
.btn-secondary:hover:not(:disabled) { background: var(--secondary-hover); }

.btn-danger {
    background: var(--danger);
    color: #fff;
}
.btn-danger:hover:not(:disabled) { background: #e03a3a; }

/* --- Ø§Ø³ØªØ§ÛŒÙ„ ÙØ±Ù…â€ŒÙ‡Ø§ --- */
input, select {
  border: 1px solid var(--secondary);
  background: var(--bg-light);
  color: var(--text);
  border-radius:15px;
  padding: 12px 20px;
  font-size:16px;
  text-align:center;
  width:90%;
  max-width: 300px;
  margin: 10px auto;
  display:block;
  transition: all .2s ease;
}
input:focus, select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.3);
}
label { display: block; text-align: center; margin-top: 20px; color: #aab; }

/* --- Ù„ÛŒØ³Øª Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† --- */
#playerList {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-top: 20px;
}
@keyframes slideInCard {
  from { opacity: 0; transform: translateX(30px); }
  to { opacity: 1; transform: translateX(0); }
}
.player-card {
  background: var(--bg-light);
  border-radius: 20px;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  transition: transform .2s ease, background-color 0.4s ease;
  animation: slideInCard 0.5s ease forwards;
  opacity: 0; /* Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† */
}
.player-card:hover {
  transform: scale(1.02);
}
.player-card.bankrupt {
  opacity: 0.5;
  background: #2a2a2a;
}
.player-info {
  display: flex;
  align-items: center;
  gap: 15px;
}
.player-tag {
  background: var(--primary);
  color: #fff;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: 700;
  font-size: 18px;
  flex-shrink: 0; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©ÙˆÚ†Ú© Ø´Ø¯Ù† ØªÚ¯ */
}
.player-name { font-size: 18px; font-weight: 600; }
.player-balance { font-size: 18px; font-weight: 400; direction: ltr; transition: color .3s ease; }
.bankrupt-stamp {
  position: relative;
  overflow: hidden;
}
.bankrupt-stamp::after{
  content:"ÙˆØ±Ø´Ú©Ø³ØªÙ‡";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-15deg);
  background: var(--danger);
  color: #fff;
  padding: 5px 50px;
  font-size: 18px;
  font-weight: bold;
  opacity: 0.9;
  letter-spacing: 2px;
}

/* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ØªØºÛŒÛŒØ± Ù…ÙˆØ¬ÙˆØ¯ÛŒ */
@keyframes balance-up {
    0% { color: var(--success); transform: scale(1.1); }
    100% { color: var(--text); transform: scale(1); }
}
@keyframes balance-down {
    0% { color: var(--danger); transform: scale(1.1); }
    100% { color: var(--text); transform: scale(1); }
}
.balance-up { animation: balance-up 0.8s ease; }
.balance-down { animation: balance-down 0.8s ease; }


/* --- Ù¾Ø§Ù¾â€ŒØ¢Ù¾â€ŒÙ‡Ø§ --- */
@keyframes popupFadeIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}
.popup {
  position:fixed; inset:0; background:#000000aa; display:none; justify-content:center; align-items:center; z-index:99;
}
.popup.active { display:flex; }
.popup.active .popup-box {
    animation: popupFadeIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.popup-box {
  background: var(--bg-light);
  border-radius:30px; 
  padding:25px; 
  width:90%; 
  max-width:400px; 
  text-align:center;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
.popup-box .button-group {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
}

/* --- Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø¹Ø¯Ø¯ÛŒ --- */
.circle {
  width:100px; height:100px; border-radius:50%;
  border: 2px solid var(--primary);
  color:var(--text); font-size:18px;
  display: flex;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 5px;
  margin:20px auto;
  transition: all .3s ease;
  overflow: hidden;
  word-break: break-word;
}
.circle.filled {
    background: var(--primary);
    color: #fff;
}
.keyboard { 
    display:grid; 
    grid-template-columns:repeat(3, 1fr); 
    gap:10px; 
    margin-top:20px;
    margin-bottom: 20px;
    padding: 0 10px; /* Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾Ø¯ÛŒÙ†Ú¯ Ø¯Ø§Ø®Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú†Ø³Ø¨ÛŒØ¯Ù† Ø¨Ù‡ Ù„Ø¨Ù‡â€ŒÙ‡Ø§ */
}
.keyboard button{ 
    border-radius:15px; 
    padding:14px; 
    font-size:20px; 
    background: var(--secondary);
    box-shadow: none;
    margin: 0;
    min-width: auto; /* Ù…Ù‡Ù…: Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨Ù‡Ù… Ø±ÛŒØ®ØªÚ¯ÛŒ */
}
.keyboard button:hover { background: var(--secondary-hover); transform: none; }
.keyboard button:active { transform: scale(0.95); background: var(--primary); }

/* --- Ø§Ù†ÛŒÙ…ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªÙ‚Ø§Ù„ Ùˆ Ù¾Ø§Ø¯Ø§Ø´ --- */
.fade {
  position:fixed; inset:0; background:#000000dd; color:#fff; display:flex;
  justify-content:center; align-items:center; flex-direction:column; font-size:20px; z-index:999; display:none;
}
.fade.active{ display:flex; animation:fadeInOut 1.5s ease-in-out;}
@keyframes fadeInOut{0%{opacity:0;}20%{opacity:1;}80%{opacity:1;}100%{opacity:0;}}
.arrow {
  width:60px; height:60px; border-top:5px solid #fff; border-left:5px solid #fff; /* Ø§ØµÙ„Ø§Ø­ Ø¨Ø±Ø§ÛŒ Ø¬Ù‡Øª RTL */
  transform:rotate(-45deg); margin-top:10px; animation:arrowAnim 1.2s ease-in-out;
}
@keyframes arrowAnim{
    0%{transform:translateX(100px) rotate(-45deg);opacity:0;}
    50%{opacity:1;}
    100%{transform:translateX(-100px) rotate(-45deg);opacity:0;}
}

/* --- Ù¾Ø§Ù¾ Ø¢Ù¾ Ø¯ÛŒØ§Ù„ÙˆÚ¯ Ø´Ø®ØµÛŒ --- */
#dialogPopup { z-index: 100; }
#dialogMessage { font-size: 18px; line-height: 1.6; margin-bottom: 25px;}

</style>
</head>
<body>

<!----------- ØµÙØ­Ù‡ Ø´Ø±ÙˆØ¹ ----------->
<section id="start" class="active">
  <h1>ğŸ¦ Ø¨Ø§Ù†Ú© Ù…ÙˆÙ†ÙˆÙ¾ÙˆÙ„ÛŒ</h1>
  <label for="playerCount">ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†:</label>
  <select id="playerCount">
    <option value="2">Û²</option>
    <option value="3">Û³</option>
    <option value="4">Û´</option>
    <option value="5">Ûµ</option>
    <option value="6">Û¶</option>
  </select>
  <label for="startMoney">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§ÙˆÙ„ÛŒÙ‡:</label>
  <input type="number" id="startMoney" placeholder="Ù…Ø«Ù„Ø§Ù‹ 15000" value="15000">
  <label for="turnReward">Ù¾Ø§Ø¯Ø§Ø´ Ø¯ÙˆØ± Ú©Ø§Ù…Ù„:</label>
  <input type="number" id="turnReward" placeholder="Ù…Ø«Ù„Ø§Ù‹ 2000" value="2000">
  <button id="continueToNames" class="btn-primary">Ø§Ø¯Ø§Ù…Ù‡</button>
</section>

<!----------- ØµÙØ­Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø§Ù… ----------->
<section id="names">
  <h2>ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</h2>
  <div id="nameInputs"></div>
  <button id="startGame" class="btn-primary">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
  <button id="backToStart" class="btn-secondary">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
</section>

<!----------- ØµÙØ­Ù‡ Ø¨Ø§Ø²ÛŒ ----------->
<section id="game">
  <h2>Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§Ø²ÛŒ</h2>
  <div id="playerList">
    <!-- Player cards will be generated here by JS -->
  </div>
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top: 30px;">
    <button id="transferBtn" class="btn-primary">ğŸ’¸ Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª</button>
    <button id="rewardBtn" class="btn-primary">ğŸ Ù¾Ø§Ø¯Ø§Ø´ Ø¯ÙˆØ±</button>
    <button class="btn-secondary" disabled>ğŸ¦ Ù¾Ø±Ø¯Ø§Ø®Øª/Ø¯Ø±ÛŒØ§ÙØª</button>
    <button class="btn-secondary" disabled>ğŸ  Ø±Ù‡Ù† Ù…Ù„Ú©</button>
  </div>  
  <button id="endGame" class="btn-danger" style="margin-top: 30px;">Ø§ØªÙ…Ø§Ù… Ùˆ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ ğŸ”„</button>
</section>

<!----------- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª ----------->
<div id="transferPopup" class="popup">
  <div class="popup-box">
    <h3>ğŸ’³ Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª</h3>
    <input type="text" id="amountInput" readonly placeholder="Ù…Ø¨Ù„Øº">
    <div class="keyboard" id="numPad"></div>
    <div style="display:flex; justify-content:space-around; align-items: center; margin-top:10px;">
      <div class="circle" id="receiverCircle">Ú¯ÛŒØ±Ù†Ø¯Ù‡</div>
      <p style="font-size: 30px; margin: 0 10px;">â†</p>
      <div class="circle" id="giverCircle">Ø¯Ù‡Ù†Ø¯Ù‡</div>
    </div>
    <div class="button-group">
        <button id="transferConfirm" class="btn-primary">Ø§Ù†ØªÙ‚Ø§Ù„</button>
        <button id="transferCancel" class="btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>
  </div>
</div>

<!----------- Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ù¾Ø§Ø¯Ø§Ø´ Ø¯ÙˆØ± ----------->
<div id="rewardPopup" class="popup">
  <div class="popup-box">
    <h3>ğŸ Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø¯Ø§Ø´ Ø¯ÙˆØ±</h3>
    <div id="rewardAmount" style="font-size:22px;margin:20px;"></div>
    <div class="circle" id="rewardCircle">Ø¨Ø§Ø²ÛŒÚ©Ù†</div>
    <div class="button-group">
        <button id="rewardConfirm" class="btn-primary">ØªØ§ÛŒÛŒØ¯</button>
        <button id="rewardCancel" class="btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>
  </div>
</div>

<!----------- Ù¾Ø§Ù¾ Ø¢Ù¾ Ø¯ÛŒØ§Ù„ÙˆÚ¯ (Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† alert Ùˆ confirm) ----------->
<div id="dialogPopup" class="popup">
    <div class="popup-box">
        <h3 id="dialogTitle">ØªÙˆØ¬Ù‡!</h3>
        <p id="dialogMessage"></p>
        <div class="button-group" id="dialogButtons">
            <!-- Buttons are generated by JS -->
        </div>
    </div>
</div>

<!----------- Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø§Ù†ØªÙ‚Ø§Ù„ ----------->
<div id="transferFade" class="fade">
  <div id="transferInfo" style="text-align: center;">
    <div class="circle filled" id="fadeGiver"></div>
    <div class="arrow"></div>
    <div class="circle filled" id="fadeReceiver"></div>
  </div>
</div>

<!----------- Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù¾Ø§Ø¯Ø§Ø´ ----------->
<div id="rewardFade" class="fade">
  <div style="text-align: center;">
    <div id="rewardShow" style="font-size: 24px; font-weight: bold; margin-bottom: 10px;"></div>
    <div class="arrow"></div>
    <div class="circle filled" id="rewardTo"></div>
  </div>
</div>

<script>
// Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ù…ØªÙ† Ùˆ Ú©Ù„ÛŒÚ©â€ŒØ±Ø§Ø³Øª
document.addEventListener('contextmenu', e => e.preventDefault());

// ------------------------- Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ú¯Ù„ÙˆØ¨Ø§Ù„ -------------------------
const sections = { 
    start: document.getElementById('start'), 
    names: document.getElementById('names'), 
    game: document.getElementById('game') 
};
const popups = {
    transfer: document.getElementById('transferPopup'),
    reward: document.getElementById('rewardPopup'),
    dialog: document.getElementById('dialogPopup')
};
let ndefReader;
let nfcAbortController = null;

// ------------------------- Ø³ÛŒØ³ØªÙ… Ø¯ÛŒØ§Ù„ÙˆÚ¯ Ø´Ø®ØµÛŒ Ø³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ -------------------------
const dialogTitle = document.getElementById('dialogTitle');
const dialogMessage = document.getElementById('dialogMessage');
const dialogButtons = document.getElementById('dialogButtons');

function customAlert(message, title = "ØªÙˆØ¬Ù‡") {
    dialogTitle.textContent = title;
    dialogMessage.textContent = message;
    dialogButtons.innerHTML = `<button id="dialogOk" class="btn-primary">Ø¨Ø§Ø´Ù‡</button>`;
    popups.dialog.classList.add('active');

    return new Promise(resolve => {
        document.getElementById('dialogOk').onclick = () => {
            popups.dialog.classList.remove('active');
            resolve();
        };
    });
}

function customConfirm(message, title = "ØªØ§ÛŒÛŒØ¯ÛŒÙ‡") {
    dialogTitle.textContent = title;
    dialogMessage.textContent = message;
    dialogButtons.innerHTML = `
        <button id="dialogConfirm" class="btn-primary">Ø¨Ù„Ù‡</button>
        <button id="dialogCancel" class="btn-secondary">Ø®ÛŒØ±</button>
    `;
    popups.dialog.classList.add('active');

    return new Promise(resolve => {
        document.getElementById('dialogConfirm').onclick = () => {
            popups.dialog.classList.remove('active');
            resolve(true);
        };
        document.getElementById('dialogCancel').onclick = () => {
            popups.dialog.classList.remove('active');
            resolve(false);
        };
    });
}

// ------------------------- Ù…Ø¯ÛŒØ±ÛŒØª ØµÙØ­Ø§Øª -------------------------
function showSection(id) {
  for (let key in sections) {
      sections[key].classList.remove('active');
  }
  sections[id].classList.add('active');
}

// ------------------------- Ù…Ø±Ø­Ù„Ù‡ Û±: ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ -------------------------
document.getElementById('continueToNames').onclick = () => {
  const count = parseInt(playerCount.value);
  const startMoneyVal = parseInt(startMoney.value);
  const rewardVal = parseInt(turnReward.value);
  if (isNaN(startMoneyVal) || startMoneyVal <= 0 || isNaN(rewardVal) || rewardVal <= 0) {
    customAlert("Ù…Ù‚Ø§Ø¯ÛŒØ± Ù¾ÙˆÙ„ÛŒ Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ùˆ Ø¨Ø²Ø±Ú¯ØªØ± Ø§Ø² ØµÙØ± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
    return;
  }
  localStorage.setItem('playerCount', count);
  localStorage.setItem('startMoney', startMoneyVal);
  localStorage.setItem('turnReward', rewardVal);
  generateNameInputs(count);
  showSection('names');
};
document.getElementById('backToStart').onclick = () => showSection('start');

// ------------------------- Ù…Ø±Ø­Ù„Ù‡ Û²: Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† -------------------------
function generateNameInputs(count) {
  const container = document.getElementById('nameInputs');
  container.innerHTML = '';
  for (let i = 1; i <= count; i++) {
    const input = document.createElement('input');
    input.placeholder = `Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù† ${i}`;
    input.id = `playerName${i}`;
    container.appendChild(input);
  }
}

document.getElementById('startGame').onclick = () => {
  const count = parseInt(localStorage.getItem('playerCount'));
  let players = [];
  for (let i = 1; i <= count; i++) {
    let name = document.getElementById(`playerName${i}`).value.trim();
    if (!name) { 
      customAlert("Ù†Ø§Ù… ØªÙ…Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯."); 
      return; 
    }
    players.push({ id: i, name: name, balance: parseInt(localStorage.getItem('startMoney')), bankrupt: false });
  }
  localStorage.setItem('players', JSON.stringify(players));
  renderPlayerList();
  showSection('game');
};

// ------------------------- Ù…Ø±Ø­Ù„Ù‡ Û³: ØµÙØ­Ù‡ Ø¨Ø§Ø²ÛŒ (Ø±Ù†Ø¯Ø± Ùˆ Ø¢Ù¾Ø¯ÛŒØª) -------------------------
function renderPlayerList() {
  const playerListContainer = document.getElementById('playerList');
  playerListContainer.innerHTML = '';
  const players = JSON.parse(localStorage.getItem('players'));
  
  players.forEach((p, index) => {
    const card = document.createElement('div');
    card.className = 'player-card';
    card.dataset.playerId = p.id;
    card.style.animationDelay = `${index * 100}ms`;

    if (p.bankrupt) card.classList.add('bankrupt-stamp');

    card.innerHTML = `
      <div class="player-info">
        <div class="player-tag">${p.id}</div>
        <div class="player-name">${p.name}</div>
      </div>
      <div class="player-balance" data-balance-id="${p.id}">${p.balance.toLocaleString('fa-IR')}</div>
    `;
    
    card.addEventListener('contextmenu', async (e) => {
      e.preventDefault();
      if (p.bankrupt) return;
      const confirmed = await customConfirm(`Ø¢ÛŒØ§ Ø§Ø² ÙˆØ±Ø´Ú©Ø³ØªÚ¯ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù† Â«${p.name}Â» Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`);
      if (confirmed) {
        let currentPlayers = JSON.parse(localStorage.getItem('players'));
        const targetPlayer = currentPlayers.find(pl => pl.id === p.id);
        if (targetPlayer) {
          targetPlayer.bankrupt = true;
          localStorage.setItem('players', JSON.stringify(currentPlayers));
          updatePlayerDisplays(currentPlayers);
        }
      }
    });
    playerListContainer.appendChild(card);
  });
}

function updatePlayerDisplays(players, oldPlayers) {
    players.forEach(p => {
        const card = document.querySelector(`.player-card[data-player-id="${p.id}"]`);
        if (!card) return;

        const balanceEl = card.querySelector(`.player-balance[data-balance-id="${p.id}"]`);
        
        // Ø¢Ù¾Ø¯ÛŒØª ÙˆØ±Ø´Ú©Ø³ØªÚ¯ÛŒ
        if (p.bankrupt) {
            card.classList.add('bankrupt-stamp');
        } else {
            card.classList.remove('bankrupt-stamp');
        }
        
        // Ø¢Ù¾Ø¯ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ùˆ Ø§Ù†ÛŒÙ…ÛŒØ´Ù†
        const oldPlayer = oldPlayers.find(op => op.id === p.id);
        if (oldPlayer && p.balance !== oldPlayer.balance) {
            balanceEl.textContent = p.balance.toLocaleString('fa-IR');
            const animationClass = p.balance > oldPlayer.balance ? 'balance-up' : 'balance-down';
            balanceEl.classList.remove('balance-up', 'balance-down'); // reset animation
            void balanceEl.offsetWidth; // trigger reflow
            balanceEl.classList.add(animationClass);
        } else {
             balanceEl.textContent = p.balance.toLocaleString('fa-IR');
        }
    });
}

// ------------------------- Ù…Ù†Ø·Ù‚ NFC -------------------------
async function startNFCScan(onRead) {
    if (!('NDEFReader' in window)) {
        customAlert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Web NFC Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ø§Ø² Ú¯ÙˆÚ¯Ù„ Ú©Ø±ÙˆÙ… Ø¯Ø± Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.", "Ø®Ø·Ø§ÛŒ NFC");
        return;
    }

    try {
        if (!ndefReader) ndefReader = new NDEFReader();
        nfcAbortController = new AbortController();
        
        await ndefReader.scan({ signal: nfcAbortController.signal });
        
        ndefReader.onreading = event => {
            const decoder = new TextDecoder();
            const rawText = decoder.decode(event.message.records[0].data);
            const parts = rawText.split('\n');
            const id = parseInt(parts[0]);
            
            if (isNaN(id)) return;
            
            const players = JSON.parse(localStorage.getItem('players'));
            const player = players.find(p => p.id === id);
            
            if (player && !player.bankrupt) {
                onRead(player);
            }
        };

    } catch (error) {
        customAlert(`Ø®Ø·Ø§ Ø¯Ø± ÙØ¹Ø§Ù„Ø³Ø§Ø²ÛŒ NFC: ${error.message}. Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ NFC Ø±ÙˆØ´Ù† Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¢Ù† Ù…Ø¬Ø§Ø² Ø§Ø³Øª.`, "Ø®Ø·Ø§ÛŒ NFC");
    }
}

function stopNFCScan() {
    if (nfcAbortController) {
        nfcAbortController.abort();
        nfcAbortController = null;
    }
}

// ------------------------- Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª -------------------------
const numPad = document.getElementById('numPad');
const amountInput = document.getElementById('amountInput');

// Ø³Ø§Ø®Øª Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø¹Ø¯Ø¯ÛŒ
['Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹','Û°','âŒ«','Ù¾Ø§Ú©'].forEach((key, index) => {
    const btn = document.createElement('button');
    btn.textContent = key;
    if (key === 'âŒ«') {
        btn.onclick = () => amountInput.value = amountInput.value.slice(0, -1);
    } else if (key === 'Ù¾Ø§Ú©') {
        btn.onclick = () => amountInput.value = '';
    } else {
        const persianMap = {'Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9','Û°':'0'};
        btn.onclick = () => amountInput.value += persianMap[key];
    }
    numPad.appendChild(btn);
});

let giverTag = null, receiverTag = null;
const giverCircle = document.getElementById('giverCircle');
const receiverCircle = document.getElementById('receiverCircle');

function resetTransferPopup() {
    stopNFCScan();
    giverTag = null;
    receiverTag = null;
    giverCircle.textContent = 'Ø¯Ù‡Ù†Ø¯Ù‡';
    receiverCircle.textContent = 'Ú¯ÛŒØ±Ù†Ø¯Ù‡';
    giverCircle.classList.remove('filled');
    receiverCircle.classList.remove('filled');
    amountInput.value = '';
    popups.transfer.classList.remove('active');
}

document.getElementById('transferBtn').onclick = () => {
    popups.transfer.classList.add('active');
    startNFCScan(player => {
        if (!giverTag) {
            giverTag = player;
            giverCircle.textContent = player.name;
            giverCircle.classList.add('filled');
        } else if (!receiverTag && player.id !== giverTag.id) {
            receiverTag = player;
            receiverCircle.textContent = player.name;
            receiverCircle.classList.add('filled');
            stopNFCScan();
        }
    });
};

document.getElementById('transferCancel').onclick = resetTransferPopup;

document.getElementById('transferConfirm').onclick = () => {
    const amount = parseInt(amountInput.value);
    if (!giverTag || !receiverTag) {
        customAlert("Ù„Ø·ÙØ§Ù‹ ØªÚ¯ Ø¯Ù‡Ù†Ø¯Ù‡ Ùˆ Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ø±Ø§ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯.");
        return;
    }
    if (isNaN(amount) || amount <= 0) {
        customAlert("Ù…Ø¨Ù„Øº Ø§Ù†ØªÙ‚Ø§Ù„ Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
        return;
    }
    
    const oldPlayers = JSON.parse(localStorage.getItem('players'));
    let players = JSON.parse(JSON.stringify(oldPlayers)); // Deep copy

    const giver = players.find(p => p.id === giverTag.id);
    const receiver = players.find(p => p.id === receiverTag.id);

    if (giver.balance < amount) {
        customAlert(`Ù…ÙˆØ¬ÙˆØ¯ÛŒ Â«${giver.name}Â» Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª!`);
        return;
    }

    giver.balance -= amount;
    receiver.balance += amount;
    localStorage.setItem('players', JSON.stringify(players));
    
    showTransferAnimation(giver.name, receiver.name);
    resetTransferPopup();
    setTimeout(() => updatePlayerDisplays(players, oldPlayers), 100); 
};

function showTransferAnimation(giverName, receiverName) {
    const fade = document.getElementById('transferFade');
    document.getElementById('fadeGiver').textContent = giverName;
    document.getElementById('fadeReceiver').textContent = receiverName;
    fade.classList.add('active');
    setTimeout(() => fade.classList.remove('active'), 1500);
}

// ------------------------- Ù¾Ø§Ø¯Ø§Ø´ Ø¯ÙˆØ± -------------------------
let rewardTag = null;
const rewardCircle = document.getElementById('rewardCircle');

function resetRewardPopup() {
    stopNFCScan();
    rewardTag = null;
    rewardCircle.textContent = 'Ø¨Ø§Ø²ÛŒÚ©Ù†';
    rewardCircle.classList.remove('filled');
    popups.reward.classList.remove('active');
}

document.getElementById('rewardBtn').onclick = () => {
    const turnReward = parseInt(localStorage.getItem('turnReward'));
    document.getElementById('rewardAmount').textContent = 
        `Ù…Ø¨Ù„Øº Ù¾Ø§Ø¯Ø§Ø´: ${turnReward.toLocaleString('fa-IR')}`;
    popups.reward.classList.add('active');
    startNFCScan(player => {
        rewardTag = player;
        rewardCircle.textContent = player.name;
        rewardCircle.classList.add('filled');
        stopNFCScan();
    });
};

document.getElementById('rewardCancel').onclick = resetRewardPopup;

document.getElementById('rewardConfirm').onclick = () => {
    if (!rewardTag) {
        customAlert("Ù„Ø·ÙØ§ ØªÚ¯ Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯.");
        return;
    }
    const rewardAmount = parseInt(localStorage.getItem('turnReward'));
    const oldPlayers = JSON.parse(localStorage.getItem('players'));
    let players = JSON.parse(JSON.stringify(oldPlayers)); // Deep copy

    const player = players.find(p => p.id === rewardTag.id);
    player.balance += rewardAmount;
    localStorage.setItem('players', JSON.stringify(players));

    showRewardAnimation(player.name, rewardAmount);
    resetRewardPopup();
    setTimeout(() => updatePlayerDisplays(players, oldPlayers), 100);
};

function showRewardAnimation(name, amount) {
    const fade = document.getElementById('rewardFade');
    document.getElementById('rewardTo').textContent = name;
    document.getElementById('rewardShow').textContent = `+${amount.toLocaleString('fa-IR')}`;
    fade.classList.add('active');
    setTimeout(() => fade.classList.remove('active'), 1500);
}

// ------------------------- Ø§ØªÙ…Ø§Ù… Ø¨Ø§Ø²ÛŒ -------------------------
document.getElementById('endGame').onclick = async () => {
    const confirmed = await customConfirm("Ø¢ÛŒØ§ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ ÛŒÚ© Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯ØŒ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ", "Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ");
    if (confirmed) {
        localStorage.clear();
        location.reload();
    }
};

// --- Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---
function init() {
    if (localStorage.getItem('players')) {
        renderPlayerList();
        showSection('game');
    } else {
        showSection('start');
    }
}

init();

</script>

</body>
</html>
