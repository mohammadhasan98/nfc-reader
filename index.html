<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¨Ø§Ù†Ú© Ù…ÙˆÙ†ÙˆÙ¾ÙˆÙ„ÛŒ</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg-dark: #0D1B2A;
  --bg-light: #1B263B;
  --primary: #3A86FF;
  --primary-hover: #5c9bff;
  --secondary: #415A77;
  --secondary-hover: #527194;
  --text: #E0E1DD;
  --danger: #ff4b4b;
  --success: #4bff7b;

  /* Player colors for card headers */
  --player-color-1: #FF6B6B;
  --player-color-2: #4ECDC4;
  --player-color-3: #45B7D1;
  --player-color-4: #F7D154;
  --player-color-5: #9A77D1;
  --player-color-6: #50C878;
  --player-color-7: #FF9F1C;
  --player-color-8: #F5558D;

  font-family: 'Vazirmatn', sans-serif;
}
* { 
  box-sizing: border-box; 
  -webkit-tap-highlight-color: transparent;
}
body {
  background: var(--bg-dark);
  color: var(--text);
  margin: 0;
  padding: 0;
  user-select: none;
  -webkit-user-select: none;
  font-size: 16px;
  overflow-x: hidden;
}
section { 
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  padding: 20px;
  opacity: 0;
  pointer-events: none;
  transform: translateX(20px);
  transition: opacity 0.5s ease, transform 0.5s ease;
}
section.active { 
  opacity: 1;
  pointer-events: auto;
  transform: translateX(0);
}
h1, h2, h3 { text-align:center; color: var(--text); font-weight: 700; }
h1 { 
    font-size: 2.5rem; 
    margin-bottom: 25px; 
    background: linear-gradient(45deg, var(--primary), var(--primary-hover));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: 900;
    text-shadow: 0 0 20px rgba(58, 134, 255, 0.2);
}
h2 { margin-bottom: 30px; font-size: 1.8rem;}

/* --- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ --- */
button {
  font-family:'Vazirmatn', sans-serif;
  border:none;
  border-radius: 25px;
  padding: 12px 28px;
  font-size:16px;
  margin: 10px auto;
  display:block;
  cursor:pointer;
  transition: all .2s ease-in-out;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  min-width: 180px;
}
button:active { transform: translateY(1px) scale(0.98); }
button:disabled {
  background: #778DA9 !important;
  color: #ccc;
  cursor: not-allowed;
  box-shadow: none;
  transform: none !important;
}
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover:not(:disabled) { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(58, 134, 255, 0.2);}
.btn-secondary { background: var(--secondary); color: var(--text); }
.btn-secondary:hover:not(:disabled) { background: var(--secondary-hover); }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover:not(:disabled) { background: #e03a3a; }

/* --- ØªØºÛŒÛŒØ±Ø§Øª Ø¢ÛŒØªÙ… 3: Ø¨Ø²Ø±Ú¯ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹ --- */
#startGameBtn {
    padding: 16px 40px;
    font-size: 18px;
    font-weight: 700;
    border-radius: 30px;
    margin-top: 30px;
}

.floating-btn {
  position: fixed; top: 15px; left: 15px;
  width: 50px; height: 50px; border-radius: 50%;
  background: var(--secondary); color: var(--text);
  display: flex; justify-content: center; align-items: center;
  padding: 0; margin: 0; z-index: 1000; min-width: unset;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.floating-btn svg { width: 24px; height: 24px; }

/* --- ÙØ±Ù…â€ŒÙ‡Ø§ --- */
input, select {
  font-family:'Vazirmatn', sans-serif;
  border: 1px solid var(--secondary); background: var(--bg-light);
  color: var(--text); border-radius:15px; padding: 12px 20px;
  font-size:16px; text-align:center; width:90%;
  max-width: 300px; margin: 10px auto; display:block;
  transition: all .2s ease;
}
input:focus, select:focus {
  outline: none; border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.3);
}
label { display: block; text-align: center; margin-top: 20px; color: #aab; }

/* --- ØµÙØ­Ù‡ Ø´Ø±ÙˆØ¹ --- */
@keyframes pulse-border {
  0% { box-shadow: 0 0 0 0 rgba(58, 134, 255, 0.6); }
  70% { box-shadow: 0 0 0 10px rgba(58, 134, 255, 0); }
  100% { box-shadow: 0 0 0 0 rgba(58, 134, 255, 0); }
}
.scan-prompt {
  text-align: center; font-size: 18px; color: var(--primary-hover);
  padding: 15px; border: 2px solid var(--primary);
  border-radius: 15px; margin: 30px auto; max-width: 320px;
  animation: pulse-border 2.5s infinite cubic-bezier(0.66, 0, 0, 1);
}

/* --- ØªØºÛŒÛŒØ±Ø§Øª Ø¢ÛŒØªÙ… 4: Ú©Ø§Ø±Øª Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ø§Ø³Ú©Ù† Ø´Ø¯Ù‡ --- */
#scannedPlayersList {
    margin-top: 25px; padding: 0 10px;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
}
.scanned-player-item {
    background: var(--bg-light);
    border-radius: 12px;
    font-size: 17px;
    text-align: center;
    padding: 12px;
    border-top: 5px solid transparent; /* Placeholder for color */
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 5px;
    min-height: 80px;
}
/* Ø§Ø¹Ù…Ø§Ù„ Ø±Ù†Ú¯â€ŒÙ‡Ø§ Ø¨Ù‡ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡ Ø´Ø±ÙˆØ¹ */
.scanned-player-item.color-1 { border-top-color: var(--player-color-1); }
.scanned-player-item.color-2 { border-top-color: var(--player-color-2); }
.scanned-player-item.color-3 { border-top-color: var(--player-color-3); }
.scanned-player-item.color-4 { border-top-color: var(--player-color-4); }
.scanned-player-item.color-5 { border-top-color: var(--player-color-5); }
.scanned-player-item.color-6 { border-top-color: var(--player-color-6); }
.scanned-player-item.color-7 { border-top-color: var(--player-color-7); }
.scanned-player-item.color-8 { border-top-color: var(--player-color-8); }

.scanned-player-item .name {
    font-weight: 600;
    color: var(--text);
}
.scanned-player-item .id-tag {
    font-size: 12px;
    color: #aab;
    background: var(--secondary);
    padding: 2px 8px;
    border-radius: 8px;
}

/* --- Ù„ÛŒØ³Øª Ùˆ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† (ØµÙØ­Ù‡ Ø¨Ø§Ø²ÛŒ) --- */
#playerList {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px; margin-top: 20px;
}
@keyframes slideInCard {
  from { opacity: 0; transform: translateY(20px) scale(0.98); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}
.player-card {
  background: linear-gradient(145deg, var(--bg-light), #212f45);
  border-radius: 20px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  transition: transform .2s ease, background-color 0.4s ease, opacity 0.4s ease;
  animation: slideInCard 0.5s ease-out forwards;
  opacity: 0; position: relative; overflow: hidden;
  border: 1px solid rgba(255, 255, 255, 0.05);
}
.player-card:hover { transform: translateY(-3px); }
.player-card-header {
  padding: 12px 15px; display: flex;
  align-items: center; justify-content: space-between;
  color: #fff; font-weight: 700;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.player-card.color-1 .player-card-header { background-color: var(--player-color-1); }
.player-card.color-2 .player-card-header { background-color: var(--player-color-2); }
.player-card.color-3 .player-card-header { background-color: var(--player-color-3); }
.player-card.color-4 .player-card-header { background-color: var(--player-color-4); }
.player-card.color-5 .player-card-header { background-color: var(--player-color-5); }
.player-card.color-6 .player-card-header { background-color: var(--player-color-6); }
.player-card.color-7 .player-card-header { background-color: var(--player-color-7); }
.player-card.color-8 .player-card-header { background-color: var(--player-color-8); }

.player-name { font-size: 16px; }

/* --- ØªØºÛŒÛŒØ±Ø§Øª Ø¢ÛŒØªÙ… 1: Ø¨Ø²Ø±Ú¯ Ú©Ø±Ø¯Ù† ID --- */
.player-id-tag {
  font-size: 18px; /* Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø´Ø¯ */
  font-weight: 700;
  background: rgba(0,0,0,0.2);
  padding: 2px 10px;
  border-radius: 8px;
}
.player-card-body { padding: 15px; text-align: center; }
.player-card-body label {
    font-size: 14px; color: #aab;
    margin: 0 0 5px 0;
}

/* --- ØªØºÛŒÛŒØ±Ø§Øª Ø¢ÛŒØªÙ… 2: Ø¨Ø²Ø±Ú¯ Ú©Ø±Ø¯Ù† Ù…ÙˆØ¬ÙˆØ¯ÛŒ --- */
.player-balance { 
  font-size: 26px; /* Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø´Ø¯ */
  font-weight: 700;
  direction: ltr; 
  transition: color .3s ease, transform 0.3s ease; 
}

@keyframes stamp-animation {
  0% { opacity: 0; transform: translate(-50%, -50%) rotate(-15deg) scale(2.5); }
  60% { opacity: 0.8; transform: translate(-50%, -50%) rotate(-15deg) scale(0.9); }
  80% { transform: translate(-50%, -50%) rotate(-15deg) scale(1.1); }
  100% { opacity: 0.8; transform: translate(-50%, -50%) rotate(-15deg) scale(1); }
}
.player-card.bankrupt { opacity: 0.5; background: #2a2a2a; }
.player-card.bankrupt::after{
  content:"ÙˆØ±Ø´Ú©Ø³ØªÙ‡"; position: absolute; top: 50%; left: 50%;
  transform-origin: center center; border: 4px solid var(--danger);
  color: var(--danger); background: transparent; padding: 5px 20px;
  border-radius: 10px; font-size: 20px; font-weight: 900;
  letter-spacing: 1px; opacity: 0;
  animation: stamp-animation 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  animation-delay: 0.2s;
}

/* --- Ø§Ù†ÛŒÙ…ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ ØªØºÛŒÛŒØ± Ù…ÙˆØ¬ÙˆØ¯ÛŒ --- */
@keyframes balance-up-anim { 
  0% { color: var(--success); transform: scale(1.15); } 
  80% { color: var(--success); transform: scale(1); }
  100% { color: var(--text); transform: scale(1); } 
}
@keyframes balance-down-anim { 
  0% { color: var(--danger); transform: scale(1.15); } 
  80% { color: var(--danger); transform: scale(1); }
  100% { color: var(--text); transform: scale(1); } 
}
.balance-up { animation: balance-up-anim 1.5s ease; }
.balance-down { animation: balance-down-anim 1.5s ease; }
.balance-down-delayed { animation: balance-down-anim 0.5s ease; }
.balance-up-delayed { animation: balance-up-anim 0.5s ease; }

/* --- Ù¾Ø§Ù¾â€ŒØ¢Ù¾â€ŒÙ‡Ø§ --- */
@keyframes popupFadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
.popup {
  position:fixed; inset:0; background:rgba(0,0,0,0.6);
  display:none; justify-content:center; align-items:center;
  z-index:99; backdrop-filter: blur(5px);
}
.popup.active { display:flex; }
.popup.active .popup-box { animation: popupFadeIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.popup-box {
  background: var(--bg-light); border-radius:30px; padding:25px;
  width:90%; max-width:400px; text-align:center;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  border: 1px solid var(--secondary);
}
.popup-box .button-group {
    display: flex; justify-content: center; gap: 10px;
    margin-top: 20px; flex-wrap: wrap;
}
.popup-box .button-group button { min-width: 120px; }

/* --- Ú©ÛŒØ¨ÙˆØ±Ø¯ Ùˆ Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§ --- */
.circle {
  width:100px; height:100px; border-radius:50%; border: 2px solid var(--primary);
  color:var(--text); font-size:18px; display: flex; justify-content: center;
  align-items: center; text-align: center; padding: 5px; margin:20px auto;
  transition: all .3s ease; overflow: hidden; word-break: break-word;
}
.circle.filled { background: var(--primary); color: #fff; }
@keyframes circleNameFadeIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
.name-animating { animation: circleNameFadeIn 0.4s ease; }
.keyboard { 
    display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; 
    margin: 20px 0; padding: 0 10px;
}
.keyboard button{ 
    border-radius:15px; padding:14px; font-size:20px; background: var(--secondary);
    box-shadow: none; margin: 0; min-width: auto;
}
.keyboard button:hover { background: var(--secondary-hover); transform: none; }
.keyboard button:active { transform: scale(0.95); background: var(--primary); }

/* --- Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø§Ù†ØªÙ‚Ø§Ù„ Ùˆ Ù¾Ø§Ø¯Ø§Ø´ --- */
.fade {
  position:fixed; inset:0; background: rgba(13, 27, 42, 0.5);
  backdrop-filter: blur(10px); color:#fff; display:none; justify-content:center;
  align-items:center; flex-direction:column; font-size:20px; z-index:999;
}
.fade.active { display:flex; }
#transferInfo { 
  display: flex; justify-content: center; align-items: center; 
  width: 100%; gap: 20px; position: relative;
}
#transferInfo .circle { opacity: 0; transform: scale(0.8); }
#transferInfo .arrow { 
  opacity: 0; width:60px; height:60px; 
  border-top:5px solid #fff; border-left:5px solid #fff;
  transform: rotate(-135deg);
}
#fadeAmount {
    position: absolute; left: 50%; transform: translateX(-50%); top: -40px;
    font-size: 24px; font-weight: bold; opacity: 0;
    transition: opacity 0.5s ease 0.5s;
}
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
@keyframes arrowAnimRTL {
    from { transform: translateX(80px) rotate(-135deg); opacity: 0; }
    to { transform: translateX(-80px) rotate(-135deg); opacity: 1; }
}
.fade-giver-anim { animation: pulse 0.8s ease-in-out forwards; animation-delay: 0.1s; opacity: 1 !important; transform: scale(1); }
.fade-arrow-anim { animation: arrowAnimRTL 1s ease-in-out forwards; animation-delay: 0.5s; opacity: 0; }
.fade-receiver-anim { animation: pulse 0.8s ease-in-out forwards; animation-delay: 1.5s; opacity: 1 !important; transform: scale(1);}
.reward-arrow {
  width:50px; height:50px; border-bottom:5px solid #fff; 
  border-left:5px solid #fff; margin: 15px auto; 
  transform: rotate(-45deg);
  animation: rewardArrowAnim 1.2s ease-in-out infinite;
}
@keyframes rewardArrowAnim {
  0% { transform: translateY(-25px) rotate(-45deg); opacity: 0; }
  50% { opacity: 1; }
  100% { transform: translateY(25px) rotate(-45deg); opacity: 0; }
}

#dialogPopup, #addPlayerPopup { z-index: 100; }
#dialogMessage { font-size: 18px; line-height: 1.6; margin-bottom: 25px;}

</style>
</head>
<body>

<button id="fullscreenBtn" class="floating-btn">
  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M9.00002 4.00002H4.00002V9.00002" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M20 9.00002V4.00002H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M15 20H20V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M4.00002 15H9.00002V20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</button>

<section id="start" class="active">
  <h1>ğŸ¦ Ø¨Ø§Ù†Ú© Ù…ÙˆÙ†ÙˆÙ¾ÙˆÙ„ÛŒ</h1>
  <p class="scan-prompt">Ù„Ø·ÙØ§ Ú©Ø§Ø±Øª Ù‡Ø± Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯</p>
  <div id="scannedPlayersList"></div>
  <label for="startMoney">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§ÙˆÙ„ÛŒÙ‡:</label>
  <input type="text" inputmode="numeric" id="startMoney" placeholder="Ù…Ø«Ù„Ø§Ù‹ Û±Ûµ,Û°Û°Û°">
  <label for="turnReward">Ù¾Ø§Ø¯Ø§Ø´ Ø¯ÙˆØ± Ú©Ø§Ù…Ù„:</label>
  <input type="text" inputmode="numeric" id="turnReward" placeholder="Ù…Ø«Ù„Ø§Ù‹ Û²,Û°Û°Û°">
  <button id="startGameBtn" class="btn-primary" disabled>Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
</section>

<section id="game">
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom: 30px;">
    <button id="transferBtn" class="btn-primary">ğŸ’¸ Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª</button>
    <button id="rewardBtn" class="btn-primary">ğŸ Ù¾Ø§Ø¯Ø§Ø´ Ø¯ÙˆØ±</button>
    <button class="btn-secondary" disabled>ğŸ¦ Ù¾Ø±Ø¯Ø§Ø®Øª/Ø¯Ø±ÛŒØ§ÙØª</button>
    <button class="btn-secondary" disabled>ğŸ  Ø±Ù‡Ù† Ù…Ù„Ú©</button>
  </div>
  <div id="playerList"></div>
  <button id="endGame" class="btn-danger" style="margin-top: 30px;">Ø§ØªÙ…Ø§Ù… Ùˆ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ ğŸ”„</button>
</section>

<div id="transferPopup" class="popup">
  <div class="popup-box">
    <h3>ğŸ’³ Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª</h3>
    <input type="text" id="amountInput" readonly placeholder="Ù…Ø¨Ù„Øº">
    <div class="keyboard" id="numPad"></div>
    <div style="display:flex; justify-content:space-around; align-items: center; margin-top:10px;">
      <div class="circle" id="giverCircle">Ø¯Ù‡Ù†Ø¯Ù‡</div>
      <p style="font-size: 30px; margin: 0 10px;">â†</p>
      <div class="circle" id="receiverCircle">Ú¯ÛŒØ±Ù†Ø¯Ù‡</div>
    </div>
    <div class="button-group">
        <button id="transferConfirm" class="btn-primary">Ø§Ù†ØªÙ‚Ø§Ù„</button>
        <button id="transferCancel" class="btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>
  </div>
</div>

<div id="rewardPopup" class="popup">
  <div class="popup-box">
    <h3>ğŸ Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø¯Ø§Ø´ Ø¯ÙˆØ±</h3>
    <div id="rewardAmount" style="font-size:22px;margin:20px;"></div>
    <div class="circle" id="rewardCircle">Ø¨Ø§Ø²ÛŒÚ©Ù†</div>
    <div class="button-group">
        <button id="rewardConfirm" class="btn-primary">ØªØ§ÛŒÛŒØ¯</button>
        <button id="rewardCancel" class="btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>
  </div>
</div>

<div id="dialogPopup" class="popup">
    <div class="popup-box">
        <h3 id="dialogTitle">ØªÙˆØ¬Ù‡!</h3>
        <p id="dialogMessage"></p>
        <div class="button-group" id="dialogButtons"></div>
    </div>
</div>

<div id="addPlayerPopup" class="popup">
    <div class="popup-box">
        <h3>Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¬Ø¯ÛŒØ¯</h3>
        <p>Ù„Ø·ÙØ§ Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:</p>
        <input type="text" id="newPlayerNameInput" placeholder="Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù†">
        <div class="button-group">
            <button id="confirmAddPlayer" class="btn-primary">ØªØ§ÛŒÛŒØ¯</button>
            <button id="cancelAddPlayer" class="btn-secondary">Ø§Ù†ØµØ±Ø§Ù</button>
        </div>
    </div>
</div>

<div id="transferFade" class="fade">
  <div id="transferInfo">
    <div id="fadeAmount"></div>
    <div class="circle filled" id="fadeGiver"></div>
    <div class="arrow"></div>
    <div class="circle filled" id="fadeReceiver"></div>
  </div>
</div>

<div id="rewardFade" class="fade">
  <div style="text-align: center;">
    <div id="rewardShow" style="font-size: 24px; font-weight: bold; margin-bottom: 10px;"></div>
    <div class="reward-arrow"></div>
    <div class="circle filled" id="rewardTo"></div>
  </div>
</div>

<script>
document.addEventListener('contextmenu', e => e.preventDefault());

const sections = { start: document.getElementById('start'), game: document.getElementById('game') };
const popups = { 
    transfer: document.getElementById('transferPopup'), 
    reward: document.getElementById('rewardPopup'), 
    dialog: document.getElementById('dialogPopup'),
    addPlayer: document.getElementById('addPlayerPopup')
};
let ndefReader, nfcAbortController = null;

const startMoney = document.getElementById('startMoney');
const turnReward = document.getElementById('turnReward');
const startGameBtn = document.getElementById('startGameBtn');
const NUM_PLAYER_COLORS = 8;

let tempPlayers = [];

const dialogTitle = document.getElementById('dialogTitle'), dialogMessage = document.getElementById('dialogMessage'), dialogButtons = document.getElementById('dialogButtons');
function customAlert(message, title = "ØªÙˆØ¬Ù‡") {
    dialogTitle.textContent = title;
    dialogMessage.textContent = message;
    dialogButtons.innerHTML = `<button id="dialogOk" class="btn-primary">Ø¨Ø§Ø´Ù‡</button>`;
    popups.dialog.classList.add('active');
    return new Promise(resolve => {
        document.getElementById('dialogOk').onclick = () => { popups.dialog.classList.remove('active'); resolve(); };
    });
}
function customConfirm(message, title = "ØªØ§ÛŒÛŒØ¯ÛŒÙ‡") {
    dialogTitle.textContent = title;
    dialogMessage.textContent = message;
    dialogButtons.innerHTML = `<button id="dialogConfirm" class="btn-primary">Ø¨Ù„Ù‡</button><button id="dialogCancel" class="btn-secondary">Ø®ÛŒØ±</button>`;
    popups.dialog.classList.add('active');
    return new Promise(resolve => {
        document.getElementById('dialogConfirm').onclick = () => { popups.dialog.classList.remove('active'); resolve(true); };
        document.getElementById('dialogCancel').onclick = () => { popups.dialog.classList.remove('active'); resolve(false); };
    });
}

function showSection(id) {
    Object.values(sections).forEach(s => s.classList.remove('active'));
    sections[id].classList.add('active');
}

function toEnglishDigits(str) {
  if (typeof str !== 'string') return str;
  const persianArabicMap = { 'Û°': '0', 'Û±': '1', 'Û²': '2', 'Û³': '3', 'Û´': '4', 'Ûµ': '5', 'Û¶': '6', 'Û·': '7', 'Û¸': '8', 'Û¹': '9', 'Ù ': '0', 'Ù¡': '1', 'Ù¢': '2', 'Ù£': '3', 'Ù¤': '4', 'Ù¥': '5', 'Ù¦': '6', 'Ù§': '7', 'Ù¨': '8', 'Ù©': '9' };
  return str.replace(/[Û°-Û¹Ù -Ù©]/g, c => persianArabicMap[c]);
}

// --- Ù…Ø±Ø­Ù„Ù‡ Û±: ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† ---
function handleInitialScan(scannedId) {
    if (tempPlayers.some(p => p.id === scannedId)) {
        customAlert("Ø§ÛŒÙ† Ú©Ø§Ø±Øª Ù‚Ø¨Ù„Ø§ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¯ÛŒÚ¯Ø±ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª.");
        return;
    }
    
    const newPlayerNameInput = document.getElementById('newPlayerNameInput');
    newPlayerNameInput.value = '';
    popups.addPlayer.classList.add('active');
    
    document.getElementById('confirmAddPlayer').onclick = () => {
        const name = newPlayerNameInput.value.trim();
        if (!name) {
            customAlert("Ù„Ø·ÙØ§ Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
            return;
        }
        tempPlayers.push({ id: scannedId, name: name });
        updateScannedPlayersList();
        popups.addPlayer.classList.remove('active');
    };
    
    document.getElementById('cancelAddPlayer').onclick = () => {
        popups.addPlayer.classList.remove('active');
    };
}

// --- ØªØºÛŒÛŒØ±Ø§Øª Ø¢ÛŒØªÙ… 4: Ù…Ù†Ø·Ù‚ Ø¬Ø¯ÛŒØ¯ Ø³Ø§Ø®Øª Ú©Ø§Ø±Øª Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ø§Ø³Ú©Ù† Ø´Ø¯Ù‡ ---
function updateScannedPlayersList() {
    const listEl = document.getElementById('scannedPlayersList');
    listEl.innerHTML = '';
    tempPlayers.forEach((player, index) => {
        const item = document.createElement('div');
        item.className = 'scanned-player-item';
        // Ø§Ø¹Ù…Ø§Ù„ Ø±Ù†Ú¯ Ø§Ø®ØªØµØ§ØµÛŒ
        item.classList.add(`color-${(index % NUM_PLAYER_COLORS) + 1}`);
        // Ø³Ø§Ø®ØªØ§Ø± Ø¬Ø¯ÛŒØ¯ Ú©Ø§Ø±Øª
        item.innerHTML = `
            <span class="name">${player.name}</span>
            <span class="id-tag">Ú©Ø§Ø±Øª: ${player.id}</span>
        `;
        listEl.appendChild(item);
    });
    
    startGameBtn.disabled = tempPlayers.length < 2;
}

startGameBtn.onclick = () => {
    const startMoneyVal = parseInt(toEnglishDigits(startMoney.value).replace(/,/g, ''));
    const rewardVal = parseInt(toEnglishDigits(turnReward.value).replace(/,/g, ''));
    if (isNaN(startMoneyVal) || startMoneyVal <= 0 || isNaN(rewardVal) || rewardVal <= 0) {
        customAlert("Ù…Ù‚Ø§Ø¯ÛŒØ± Ù¾ÙˆÙ„ÛŒ Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ùˆ Ø¨Ø²Ø±Ú¯ØªØ± Ø§Ø² ØµÙØ± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
        return;
    }
    
    const finalPlayers = tempPlayers.map(p => ({
        ...p,
        balance: startMoneyVal,
        bankrupt: false
    }));

    localStorage.setItem('players', JSON.stringify(finalPlayers));
    localStorage.setItem('startMoney', startMoneyVal);
    localStorage.setItem('turnReward', rewardVal);

    stopNFCScan();
    renderPlayerList();
    showSection('game');
};


// --- Ù…Ø±Ø­Ù„Ù‡ Û³: ØµÙØ­Ù‡ Ø¨Ø§Ø²ÛŒ ---
function renderPlayerList() {
    const container = document.getElementById('playerList');
    container.innerHTML = '';
    JSON.parse(localStorage.getItem('players')).forEach((p, index) => {
        const card = document.createElement('div');
        card.className = 'player-card';
        card.classList.add(`color-${(index % NUM_PLAYER_COLORS) + 1}`);

        card.dataset.playerId = p.id;
        card.style.animationDelay = `${index * 100}ms`;
        if (p.bankrupt) card.classList.add('bankrupt');

        // --- ØªØºÛŒÛŒØ±Ø§Øª Ø¢ÛŒØªÙ… 1: Ø­Ø°Ù "Ø´.Ú©:" ---
        card.innerHTML = `
            <div class="player-card-header">
                <span class="player-name">${p.name}</span>
                <span class="player-id-tag">${p.id}</span>
            </div>
            <div class="player-card-body">
                <label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</label>
                <div class="player-balance" data-balance-id="${p.id}">${p.balance.toLocaleString('fa-IR')}</div>
            </div>
        `;
        
        card.addEventListener('contextmenu', async e => {
            e.preventDefault();
            if (p.bankrupt) return; 
            if (await customConfirm(`Ø¢ÛŒØ§ Ø§Ø² ÙˆØ±Ø´Ú©Ø³ØªÚ¯ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù† Â«${p.name}Â» Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)) {
                let players = JSON.parse(localStorage.getItem('players'));
                const target = players.find(pl => pl.id === p.id);
                if (target) {
                    target.bankrupt = true;
                    localStorage.setItem('players', JSON.stringify(players));
                    updatePlayerDisplays(players);
                }
            }
        });
        container.appendChild(card);
    });
}

function updatePlayerDisplays(newPlayers, oldPlayers) {
    newPlayers.forEach(p => {
        const card = document.querySelector(`.player-card[data-player-id="${p.id}"]`);
        if (!card) return;
        const balanceEl = card.querySelector(`.player-balance[data-balance-id="${p.id}"]`);
        if (p.bankrupt) card.classList.add('bankrupt'); else card.classList.remove('bankrupt');
        
        const oldPlayer = oldPlayers?.find(op => op.id === p.id);
        if (oldPlayer && p.balance !== oldPlayer.balance) {
            balanceEl.textContent = p.balance.toLocaleString('fa-IR');
            const animClass = p.balance > oldPlayer.balance ? 'balance-up' : 'balance-down';
            balanceEl.classList.remove('balance-up', 'balance-down');
            void balanceEl.offsetWidth;
            balanceEl.classList.add(animClass);
        } else {
            balanceEl.textContent = p.balance.toLocaleString('fa-IR');
        }
    });
}


// --- Ù…Ù†Ø·Ù‚ NFC ---
async function startNFCScan(onRead) {
    if (!('NDEFReader' in window)) {
        customAlert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Web NFC Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ø§Ø² Ú¯ÙˆÚ¯Ù„ Ú©Ø±ÙˆÙ… Ø¯Ø± Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.", "Ø®Ø·Ø§ÛŒ NFC");
        return;
    }
    try {
        if (!ndefReader) ndefReader = new NDEFReader();
        nfcAbortController = new AbortController();
        await ndefReader.scan({ signal: nfcAbortController.signal });
        ndefReader.onreading = event => {
            const decoder = new TextDecoder();
            const idString = decoder.decode(event.message.records[0].data).split('\n')[0];
            const id = parseInt(idString);
            if (isNaN(id)) return;
            
            if (sections.game.classList.contains('active')) {
                const player = JSON.parse(localStorage.getItem('players')).find(p => p.id === id);
                if (player && !player.bankrupt) onRead(player);
            } else if (sections.start.classList.contains('active')) {
                onRead(id);
            }
        };
    } catch (error) {
        customAlert(`Ø®Ø·Ø§ Ø¯Ø± ÙØ¹Ø§Ù„Ø³Ø§Ø²ÛŒ NFC: ${error.message}.`, "Ø®Ø·Ø§ÛŒ NFC");
    }
}
function stopNFCScan() { if (nfcAbortController) { nfcAbortController.abort(); nfcAbortController = null; } }

// --- Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª ---
const numPad = document.getElementById('numPad'), amountInput = document.getElementById('amountInput');
['Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹','Ù¾Ø§Ú©','Û°','âŒ«'].forEach(key => {
    const btn = document.createElement('button'); btn.textContent = key;
    if (key === 'âŒ«') btn.onclick = () => amountInput.value = amountInput.value.slice(0, -1);
    else if (key === 'Ù¾Ø§Ú©') btn.onclick = () => amountInput.value = '';
    else btn.onclick = () => amountInput.value += key;
    numPad.appendChild(btn);
});
let giverTag = null, receiverTag = null;
const giverCircle = document.getElementById('giverCircle'), receiverCircle = document.getElementById('receiverCircle');
function animateCircleName(circle, name) {
    circle.textContent = name;
    circle.classList.add('filled', 'name-animating');
    circle.addEventListener('animationend', () => circle.classList.remove('name-animating'), { once: true });
}
function resetTransferPopup() {
    stopNFCScan();
    giverTag = receiverTag = null;
    giverCircle.textContent = 'Ø¯Ù‡Ù†Ø¯Ù‡';
    receiverCircle.textContent = 'Ú¯ÛŒØ±Ù†Ø¯Ù‡';
    giverCircle.classList.remove('filled');
    receiverCircle.classList.remove('filled');
    amountInput.value = '';
    popups.transfer.classList.remove('active');
}
document.getElementById('transferBtn').onclick = () => {
    popups.transfer.classList.add('active');
    startNFCScan(player => {
        if (!giverTag) { giverTag = player; animateCircleName(giverCircle, player.name); } 
        else if (!receiverTag && player.id !== giverTag.id) { receiverTag = player; animateCircleName(receiverCircle, player.name); stopNFCScan(); }
    });
};
document.getElementById('transferCancel').onclick = resetTransferPopup;

document.getElementById('transferConfirm').onclick = () => {
    const amount = parseInt(toEnglishDigits(amountInput.value));
    if (!giverTag || !receiverTag) { customAlert("Ú©Ø§Ø±Øª Ø¯Ù‡Ù†Ø¯Ù‡ Ùˆ Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ø±Ø§ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯."); return; }
    if (isNaN(amount) || amount <= 0) { customAlert("Ù…Ø¨Ù„Øº Ø§Ù†ØªÙ‚Ø§Ù„ Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯."); return; }

    let players = JSON.parse(localStorage.getItem('players'));
    const giver = players.find(p => p.id === giverTag.id);
    const receiver = players.find(p => p.id === receiverTag.id);

    if (giver.balance < amount) { customAlert(`Ù…ÙˆØ¬ÙˆØ¯ÛŒ Â«${giver.name}Â» Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª!`); return; }
    
    giver.balance -= amount;
    receiver.balance += amount;
    localStorage.setItem('players', JSON.stringify(players));
    
    showTransferAnimation(giver.name, receiver.name, amount, giver.id, receiver.id, players); 
    
    resetTransferPopup();
};

function showTransferAnimation(giverName, receiverName, amount, giverId, receiverId, newPlayers) {
    const fade = document.getElementById('transferFade');
    const giverEl = document.getElementById('fadeGiver');
    const receiverEl = document.getElementById('fadeReceiver');
    const arrowEl = fade.querySelector('.arrow');
    const amountEl = document.getElementById('fadeAmount');
    
    giverEl.textContent = giverName; 
    receiverEl.textContent = receiverName;
    amountEl.textContent = amount.toLocaleString('fa-IR');
    
    giverEl.className = 'circle filled'; 
    receiverEl.className = 'circle filled'; 
    arrowEl.className = 'arrow';
    amountEl.style.opacity = '0';
    
    fade.classList.add('active');
    
    setTimeout(() => {
        giverEl.classList.add('fade-giver-anim'); 
        arrowEl.classList.add('fade-arrow-anim'); 
        receiverEl.classList.add('fade-receiver-anim');
        amountEl.style.opacity = '1';
    }, 50);

    setTimeout(() => {
        fade.classList.remove('active');
        const giverData = newPlayers.find(p => p.id === giverId);
        const receiverData = newPlayers.find(p => p.id === receiverId);
        if (giverData) {
            const giverBalanceEl = document.querySelector(`.player-balance[data-balance-id="${giverId}"]`);
            giverBalanceEl.textContent = giverData.balance.toLocaleString('fa-IR');
            giverBalanceEl.classList.remove('balance-up-delayed', 'balance-down-delayed');
            void giverBalanceEl.offsetWidth;
            giverBalanceEl.classList.add('balance-down-delayed');
        }
        
        setTimeout(() => {
            if (receiverData) {
                const receiverBalanceEl = document.querySelector(`.player-balance[data-balance-id="${receiverId}"]`);
                receiverBalanceEl.textContent = receiverData.balance.toLocaleString('fa-IR');
                receiverBalanceEl.classList.remove('balance-up-delayed', 'balance-down-delayed');
                void receiverBalanceEl.offsetWidth;
                receiverBalanceEl.classList.add('balance-up-delayed');
            }
        }, 500); 

    }, 2500); 
}

// --- Ù¾Ø§Ø¯Ø§Ø´ Ø¯ÙˆØ± ---
let rewardTag = null;
const rewardCircle = document.getElementById('rewardCircle');
function resetRewardPopup() {
    stopNFCScan(); rewardTag = null;
    rewardCircle.textContent = 'Ø¨Ø§Ø²ÛŒÚ©Ù†'; rewardCircle.classList.remove('filled');
    popups.reward.classList.remove('active');
}
document.getElementById('rewardBtn').onclick = () => {
    const turnReward = parseInt(localStorage.getItem('turnReward'));
    document.getElementById('rewardAmount').textContent = `Ù…Ø¨Ù„Øº Ù¾Ø§Ø¯Ø§Ø´: ${turnReward.toLocaleString('fa-IR')}`;
    popups.reward.classList.add('active');
    startNFCScan(player => { rewardTag = player; animateCircleName(rewardCircle, player.name); stopNFCScan(); });
};
document.getElementById('rewardCancel').onclick = resetRewardPopup;
document.getElementById('rewardConfirm').onclick = () => {
    if (!rewardTag) { customAlert("Ú©Ø§Ø±Øª Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯."); return; }
    const rewardAmount = parseInt(localStorage.getItem('turnReward'));
    const oldPlayers = JSON.parse(localStorage.getItem('players'));
    let players = JSON.parse(JSON.stringify(oldPlayers));
    const player = players.find(p => p.id === rewardTag.id);
    player.balance += rewardAmount;
    localStorage.setItem('players', JSON.stringify(players));
    showRewardAnimation(player.name, rewardAmount);
    resetRewardPopup();
    setTimeout(() => updatePlayerDisplays(players, oldPlayers), 100);
};
function showRewardAnimation(name, amount) {
    const fade = document.getElementById('rewardFade');
    document.getElementById('rewardTo').textContent = name;
    document.getElementById('rewardShow').textContent = `+${amount.toLocaleString('fa-IR')}`;
    fade.classList.add('active');
    setTimeout(() => fade.classList.remove('active'), 2000);
}

// --- Ø§ØªÙ…Ø§Ù… Ø¨Ø§Ø²ÛŒ ---
document.getElementById('endGame').onclick = async () => {
    if (await customConfirm("Ø¢ÛŒØ§ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ ÛŒÚ© Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯ØŒ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ", "Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ")) {
        localStorage.clear();
        location.reload();
    }
};

// --- Ø¯Ú©Ù…Ù‡ ØªÙ…Ø§Ù… ØµÙØ­Ù‡ ---
document.getElementById('fullscreenBtn').onclick = () => {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
            customAlert(`Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø§Ù„Øª ØªÙ…Ø§Ù…â€ŒØµÙØ­Ù‡: ${err.message}`);
        });
    } else {
        document.exitFullscreen();
    }
};

// --- Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---
function init() {
    if (localStorage.getItem('players')) {
        renderPlayerList();
        showSection('game');
    } else {
        showSection('start');
        startNFCScan(handleInitialScan);
    }
}
init();
</script>

</body>
</html>
