<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>بانک مونوپولی</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg-dark: #0D1B2A;
  --bg-light: #1B263B;
  --primary: #3A86FF;
  --primary-hover: #5c9bff;
  --secondary: #415A77;
  --secondary-hover: #527194;
  --text: #E0E1DD;
  --danger: #ff4b4b;
  --success: #4bff7b;
  font-family: 'Vazirmatn', sans-serif;
}

/* پالت رنگی برای کارت‌های بازیکن */
.color-1 { --card-color: #FF6B6B; --card-light: #FF8E8E; }
.color-2 { --card-color: #4ECDC4; --card-light: #7ED9D2; }
.color-3 { --card-color: #FFD93D; --card-light: #FFE26E; }
.color-4 { --card-color: #95E1D3; --card-light: #B8EBE0; }
.color-5 { --card-color: #AA96DA; --card-light: #C3B1E1; }
.color-6 { --card-color: #F38181; --card-light: #F7A4A4; }
.color-7 { --card-color: #6C5CE7; --card-light: #9088EE; }
.color-8 { --card-color: #00D2FF; --card-light: #33DDFF; }

* { 
  box-sizing: border-box; 
  -webkit-tap-highlight-color: transparent;
}
body {
  background: linear-gradient(135deg, #0D1B2A 0%, #1B263B 100%);
  color: var(--text);
  margin: 0;
  padding: 0;
  user-select: none;
  -webkit-user-select: none;
  font-size: 16px;
  overflow-x: hidden;
  min-height: 100vh;
}
section { 
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  padding: 20px;
  opacity: 0;
  pointer-events: none;
  transform: translateX(20px);
  transition: opacity 0.5s ease, transform 0.5s ease;
}
section.active { 
  opacity: 1;
  pointer-events: auto;
  transform: translateX(0);
}
h1, h2, h3 { text-align:center; color: var(--text); font-weight: 700; }
h1 { 
  font-size: 2.5rem; 
  margin-bottom: 30px; 
  text-shadow: 0 0 20px rgba(58, 134, 255, 0.6);
  background: linear-gradient(135deg, #3A86FF, #5c9bff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
h2 { margin-bottom: 30px; font-size: 1.8rem;}

/* --- استایل دکمه‌ها --- */
button {
  font-family:'Vazirmatn', sans-serif;
  border:none;
  border-radius: 25px;
  padding: 12px 28px;
  font-size:16px;
  margin: 10px auto;
  display:block;
  cursor:pointer;
  transition: all .2s ease-in-out;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  min-width: 180px;
}
button:active { transform: translateY(1px) scale(0.98); }
button:disabled {
  background: #778DA9 !important;
  color: #ccc;
  cursor: not-allowed;
  box-shadow: none;
  transform: none !important;
}
.btn-primary { 
  background: linear-gradient(135deg, var(--primary), var(--primary-hover)); 
  color: #fff; 
}
.btn-primary:hover:not(:disabled) { 
  transform: translateY(-2px); 
  box-shadow: 0 6px 20px rgba(58, 134, 255, 0.4);
}
.btn-secondary { background: var(--secondary); color: var(--text); }
.btn-secondary:hover:not(:disabled) { background: var(--secondary-hover); }
.btn-danger { 
  background: linear-gradient(135deg, var(--danger), #e03a3a); 
  color: #fff; 
}
.btn-danger:hover:not(:disabled) { 
  box-shadow: 0 6px 20px rgba(255, 75, 75, 0.4); 
  transform: translateY(-2px);
}

.floating-btn {
  position: fixed;
  top: 15px;
  left: 15px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--secondary);
  color: var(--text);
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 0;
  margin: 0;
  z-index: 1000;
  min-width: unset;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.floating-btn svg {
  width: 24px;
  height: 24px;
}

/* --- استایل فرم‌ها --- */
input, select {
  font-family:'Vazirmatn', sans-serif;
  border: 1px solid var(--secondary);
  background: var(--bg-light);
  color: var(--text);
  border-radius:15px;
  padding: 12px 20px;
  font-size:16px;
  text-align:center;
  width:90%;
  max-width: 300px;
  margin: 10px auto;
  display:block;
  transition: all .2s ease;
}
input:focus, select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.3);
}
label { display: block; text-align: center; margin-top: 20px; color: #aab; }

/* --- لیست بازیکنان --- */
#scannedPlayersList {
    margin-top: 25px;
    padding: 0 10px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.scanned-player-item {
    background: var(--secondary);
    padding: 10px 15px;
    border-radius: 12px;
    font-size: 17px;
    text-align: right;
}

/* --- طراحی جدید لیست بازیکنان (Grid 2 ستونی) --- */
#playerList {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
  margin-top: 20px;
  padding: 0 5px;
}

@media (max-width: 500px) {
  #playerList {
    grid-template-columns: 1fr;
  }
}

@keyframes slideInCard {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.player-card {
  background: var(--bg-light);
  border-radius: 20px;
  padding: 0;
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  transition: transform .2s ease, box-shadow 0.3s ease;
  animation: slideInCard 0.5s ease forwards;
  opacity: 0;
  position: relative;
  overflow: hidden;
  border: 2px solid transparent;
}

.player-card:hover { 
  transform: translateY(-5px); 
  box-shadow: 0 12px 30px rgba(0,0,0,0.4);
}

/* هدر کارت با رنگ منحصر به فرد */
.player-card-header {
  background: linear-gradient(135deg, var(--card-color), var(--card-light));
  padding: 15px;
  display: flex;
  align-items: center;
  gap: 12px;
  border-radius: 18px 18px 0 0;
}

.player-tag {
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(10px);
  color: #fff;
  width: 45px;
  height: 45px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: 900;
  font-size: 20px;
  flex-shrink: 0;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

.player-name {
  font-size: 18px;
  font-weight: 700;
  color: #fff;
  text-shadow: 0 2px 4px rgba(0,0,0,0.2);
  flex: 1;
}

/* بدنه کارت */
.player-card-body {
  padding: 20px 15px;
  text-align: center;
}

.balance-label {
  font-size: 13px;
  color: #aab;
  margin-bottom: 8px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.player-balance {
  font-size: 28px;
  font-weight: 900;
  direction: ltr;
  transition: color .3s ease;
  background: linear-gradient(135deg, var(--primary), var(--primary-hover));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

@keyframes stamp-animation {
  0% { opacity: 0; transform: translate(-50%, -50%) rotate(-15deg) scale(2.5); }
  60% { opacity: 0.9; transform: translate(-50%, -50%) rotate(-15deg) scale(0.9); }
  80% { transform: translate(-50%, -50%) rotate(-15deg) scale(1.1); }
  100% { opacity: 0.9; transform: translate(-50%, -50%) rotate(-15deg) scale(1); }
}

.player-card.bankrupt { 
  opacity: 0.5; 
  filter: grayscale(0.8);
}

.player-card.bankrupt::after{
  content:"ورشکسته";
  position: absolute; 
  top: 50%; 
  left: 50%;
  transform-origin: center center;
  border: 4px solid var(--danger); 
  color: var(--danger); 
  background: rgba(13, 27, 42, 0.95);
  padding: 8px 20px; 
  border-radius: 10px; 
  font-size: 20px; 
  font-weight: 900;
  letter-spacing: 1px; 
  opacity: 0;
  animation: stamp-animation 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  animation-delay: 0.2s;
  box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}

/* انیمیشن‌های تغییر موجودی */
@keyframes balance-up { 
  0% { 
    transform: scale(1.2); 
    filter: drop-shadow(0 0 10px var(--success));
  } 
  80% { 
    transform: scale(1); 
  }
  100% { 
    transform: scale(1); 
  } 
}
@keyframes balance-down { 
  0% { 
    transform: scale(1.2); 
    filter: drop-shadow(0 0 10px var(--danger));
  } 
  80% { 
    transform: scale(1); 
  }
  100% { 
    transform: scale(1); 
  } 
}
.balance-up { animation: balance-up 1.5s ease; }
.balance-down { animation: balance-down 1.5s ease; }

/* --- پاپ‌آپ‌ها --- */
@keyframes popupFadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
.popup {
  position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:99;
  backdrop-filter: blur(5px);
}
.popup.active { display:flex; }
.popup.active .popup-box { animation: popupFadeIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.popup-box {
  background: var(--bg-light); 
  border-radius:30px; 
  padding:25px; 
  width:90%; 
  max-width:400px;
  text-align:center; 
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  border: 1px solid rgba(58, 134, 255, 0.2);
}
.popup-box .button-group {
    display: flex; justify-content: center; gap: 10px; margin-top: 20px;
    flex-wrap: wrap;
}
.popup-box .button-group button { min-width: 120px; }

/* --- کیبورد و دایره‌ها --- */
.circle {
  width:100px; height:100px; border-radius:50%; border: 3px solid var(--primary);
  color:var(--text); font-size:18px; display: flex; justify-content: center; align-items: center;
  text-align: center; padding: 5px; margin:20px auto; transition: all .3s ease;
  overflow: hidden; word-break: break-word;
  background: var(--bg-dark);
}
.circle.filled { 
  background: linear-gradient(135deg, var(--primary), var(--primary-hover)); 
  color: #fff; 
  border-color: var(--primary-hover);
  box-shadow: 0 5px 15px rgba(58, 134, 255, 0.4);
}
@keyframes circleNameFadeIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
.name-animating { animation: circleNameFadeIn 0.4s ease; }
.keyboard { 
    display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; 
    margin: 20px 0; padding: 0 10px;
}
.keyboard button{ 
    border-radius:15px; padding:14px; font-size:20px; background: var(--secondary);
    box-shadow: none; margin: 0; min-width: auto;
}
.keyboard button:hover { background: var(--secondary-hover); transform: none; }
.keyboard button:active { transform: scale(0.95); background: var(--primary); }

/* --- انیمیشن انتقال و پاداش --- */
.fade {
  position:fixed; inset:0;
  background: rgba(13, 27, 42, 0.5);
  backdrop-filter: blur(10px);
  color:#fff; display:none; justify-content:center; align-items:center;
  flex-direction:column; font-size:20px; z-index:999;
}
.fade.active { display:flex; }

#transferInfo { 
  display: flex; 
  justify-content: center; 
  align-items: center; 
  width: 100%; 
  gap: 20px; 
  position: relative;
}
#transferInfo .circle { opacity: 0; transform: scale(0.8); }
#transferInfo .arrow { 
  opacity: 0; 
  width:60px; height:60px; 
  border-top:5px solid #fff; 
  border-right:5px solid #fff;
}
#fadeAmount {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    top: -40px;
    font-size: 24px;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.5s ease 0.5s;
}

@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
@keyframes arrowAnimLTR {
    from { transform: translateX(-80px) rotate(45deg); opacity: 0; }
    to { transform: translateX(80px) rotate(45deg); opacity: 1; }
}
.fade-giver-anim { animation: pulse 0.8s ease-in-out forwards; animation-delay: 0.1s; opacity: 1 !important; transform: scale(1); }
.fade-arrow-anim { animation: arrowAnimLTR 1s ease-in-out forwards; animation-delay: 0.5s; opacity: 0; }
.fade-receiver-anim { animation: pulse 0.8s ease-in-out forwards; animation-delay: 1.5s; opacity: 1 !important; transform: scale(1);}

.reward-arrow {
  width:50px; height:50px; 
  border-bottom:5px solid #fff; 
  border-left:5px solid #fff;
  margin: 15px auto; 
  transform: rotate(-45deg);
  animation: rewardArrowAnim 1.2s ease-in-out infinite;
}
@keyframes rewardArrowAnim {
  0% { transform: translateY(-25px) rotate(-45deg); opacity: 0; }
  50% { opacity: 1; }
  100% { transform: translateY(25px) rotate(-45deg); opacity: 0; }
}

#dialogPopup, #addPlayerPopup { z-index: 100; }
#dialogMessage { font-size: 18px; line-height: 1.6; margin-bottom: 25px;}

/* دکمه‌های مدیریت بازی */
.game-controls {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-bottom: 30px;
  padding: 0 5px;
}

.game-controls button {
  margin: 0;
  padding: 16px 20px;
  font-size: 15px;
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

</style>
</head>
<body>

<button id="fullscreenBtn" class="floating-btn">
  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M9.00002 4.00002H4.00002V9.00002" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M20 9.00002V4.00002H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M15 20H20V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M4.00002 15H9.00002V20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</button>

<section id="start" class="active">
  <h1>🏦 بانک مونوپولی</h1>
  
  <p style="text-align: center; font-size: 18px; color: var(--primary-hover);">لطفا تگ هر بازیکن را اسکن کنید</p>
  <div id="scannedPlayersList"></div>

  <label for="startMoney">موجودی اولیه:</label>
  <input type="text" inputmode="numeric" id="startMoney" placeholder="مثلاً ۱۵,۰۰۰">
  <label for="turnReward">پاداش دور کامل:</label>
  <input type="text" inputmode="numeric" id="turnReward" placeholder="مثلاً ۲,۰۰۰">
  <button id="startGameBtn" class="btn-primary" disabled>شروع بازی</button>
</section>

<section id="game">
  <h2>مدیریت بازی</h2>
  <div class="game-controls">
    <button id="transferBtn" class="btn-primary">
      <span>💸</span>
      <span>کارت به کارت</span>
    </button>
    <button id="rewardBtn" class="btn-primary">
      <span>🎁</span>
      <span>پاداش دور</span>
    </button>
    <button class="btn-secondary" disabled>
      <span>🏦</span>
      <span>پرداخت/دریافت</span>
    </button>
    <button class="btn-secondary" disabled>
      <span>🏠</span>
      <span>رهن ملک</span>
    </button>
  </div>
  <div id="playerList"></div>
  <button id="endGame" class="btn-danger" style="margin-top: 30px;">اتمام و شروع مجدد 🔄</button>
</section>

<div id="transferPopup" class="popup">
  <div class="popup-box">
    <h3>💳 کارت به کارت</h3>
    <input type="text" id="amountInput" readonly placeholder="مبلغ">
    <div class="keyboard" id="numPad"></div>
    <div style="display:flex; justify-content:space-around; align-items: center; margin-top:10px;">
      <div class="circle" id="giverCircle">دهنده</div>
      <p style="font-size: 30px; margin: 0 10px;">←</p>
      <div class="circle" id="receiverCircle">گیرنده</div>
    </div>
    <div class="button-group">
        <button id="transferConfirm" class="btn-primary">انتقال</button>
        <button id="transferCancel" class="btn-secondary">انصراف</button>
    </div>
  </div>
</div>

<div id="rewardPopup" class="popup">
  <div class="popup-box">
    <h3>🎁 دریافت پاداش دور</h3>
    <div id="rewardAmount" style="font-size:22px;margin:20px;"></div>
    <div class="circle" id="rewardCircle">بازیکن</div>
    <div class="button-group">
        <button id="rewardConfirm" class="btn-primary">تایید</button>
        <button id="rewardCancel" class="btn-secondary">انصراف</button>
    </div>
  </div>
</div>

<div id="dialogPopup" class="popup">
    <div class="popup-box">
        <h3 id="dialogTitle">توجه!</h3>
        <p id="dialogMessage"></p>
        <div class="button-group" id="dialogButtons"></div>
    </div>
</div>

<div id="addPlayerPopup" class="popup">
    <div class="popup-box">
        <h3>افزودن بازیکن جدید</h3>
        <p>لطفا نام بازیکن را وارد کنید:</p>
        <input type="text" id="newPlayerNameInput" placeholder="نام بازیکن">
        <div class="button-group">
            <button id="confirmAddPlayer" class="btn-primary">تایید</button>
            <button id="cancelAddPlayer" class="btn-secondary">انصراف</button>
        </div>
    </div>
</div>

<div id="transferFade" class="fade">
  <div id="transferInfo">
    <div id="fadeAmount"></div>
    <div class="circle filled" id="fadeGiver"></div>
    <div class="arrow"></div>
    <div class="circle filled" id="fadeReceiver"></div>
  </div>
</div>

<div id="rewardFade" class="fade">
  <div style="text-align: center;">
    <div id="rewardShow" style="font-size: 24px; font-weight: bold; margin-bottom: 10px;"></div>
    <div class="reward-arrow"></div>
    <div class="circle filled" id="rewardTo"></div>
  </div>
</div>

<script>
document.addEventListener('contextmenu', e => e.preventDefault());

const sections = { start: document.getElementById('start'), game: document.getElementById('game') };
const popups = { 
    transfer: document.getElementById('transferPopup'), 
    reward: document.getElementById('rewardPopup'), 
    dialog: document.getElementById('dialogPopup'),
    addPlayer: document.getElementById('addPlayerPopup')
};
let ndefReader, nfcAbortController = null;

const startMoney = document.getElementById('startMoney');
const turnReward = document.getElementById('turnReward');
const startGameBtn = document.getElementById('startGameBtn');

let tempPlayers = [];

// رنگ‌های کارت (8 رنگ منحصر به فرد)
const cardColors = ['color-1', 'color-2', 'color-3', 'color-4', 'color-5', 'color-6', 'color-7', 'color-8'];

const dialogTitle = document.getElementById('dialogTitle'), dialogMessage = document.getElementById('dialogMessage'), dialogButtons = document.getElementById('dialogButtons');
function customAlert(message, title = "توجه") {
    dialogTitle.textContent = title;
    dialogMessage.textContent = message;
    dialogButtons.innerHTML = `<button id="dialogOk" class="btn-primary">باشه</button>`;
    popups.dialog.classList.add('active');
    return new Promise(resolve => {
        document.getElementById('dialogOk').onclick = () => { popups.dialog.classList.remove('active'); resolve(); };
    });
}
function customConfirm(message, title = "تاییدیه") {
    dialogTitle.textContent = title;
    dialogMessage.textContent = message;
    dialogButtons.innerHTML = `<button id="dialogConfirm" class="btn-primary">بله</button><button id="dialogCancel" class="btn-secondary">خیر</button>`;
    popups.dialog.classList.add('active');
    return new Promise(resolve => {
        document.getElementById('dialogConfirm').onclick = () => { popups.dialog.classList.remove('active'); resolve(true); };
        document.getElementById('dialogCancel').onclick = () => { popups.dialog.classList.remove('active'); resolve(false); };
    });
}

function showSection(id) {
    Object.values(sections).forEach(s => s.classList.remove('active'));
    sections[id].classList.add('active');
}

function toEnglishDigits(str) {
  if (typeof str !== 'string') return str;
  const persianArabicMap = { '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4', '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9', '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4', '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9' };
  return str.replace(/[۰-۹٠-٩]/g, c => persianArabicMap[c]);
}

function handleInitialScan(scannedId) {
    if (tempPlayers.some(p => p.id === scannedId)) {
        customAlert("این تگ قبلا برای بازیکن دیگری ثبت شده است.");
        return;
    }
    
    const newPlayerNameInput = document.getElementById('newPlayerNameInput');
    newPlayerNameInput.value = '';
    popups.addPlayer.classList.add('active');
    
    document.getElementById('confirmAddPlayer').onclick = () => {
        const name = newPlayerNameInput.value.trim();
        if (!name) {
            customAlert("لطفا نام بازیکن را وارد کنید.");
            return;
        }
        tempPlayers.push({ id: scannedId, name: name });
        updateScannedPlayersList();
        popups.addPlayer.classList.remove('active');
    };
    
    document.getElementById('cancelAddPlayer').onclick = () => {
        popups.addPlayer.classList.remove('active');
    };
}

function updateScannedPlayersList() {
    const listEl = document.getElementById('scannedPlayersList');
    listEl.innerHTML = '';
    tempPlayers.forEach((player, index) => {
        const item = document.createElement('div');
        item.className = 'scanned-player-item';
        item.textContent = `${index + 1}. ${player.name}`;
        listEl.appendChild(item);
    });
    
    startGameBtn.disabled = tempPlayers.length < 2;
}

startGameBtn.onclick = () => {
    const startMoneyVal = parseInt(toEnglishDigits(startMoney.value).replace(/,/g, ''));
    const rewardVal